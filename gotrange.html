<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taco Basket Ball - Global Edition</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        #game-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 600px;
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas {
            border: 8px solid #5D4037;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            border-radius: 4px;
            width: 100%;
            height: 100%;
            display: block;
            box-sizing: border-box;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
            text-align: left;
        }

        #controls {
            position: absolute;
            bottom: 125px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: auto;
            z-index: 20;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .ui-btn {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            color: #000;
            border: 2px solid #fff;
            padding: 8px 18px;
            cursor: pointer;
            font-weight: 800;
            display: inline-block;
            border-radius: 6px;
            box-shadow: 0 4px 0 #B8860B;
            transition: transform 0.1s, background 0.1s;
            font-size: 16px;
            text-transform: uppercase;
            text-shadow: none;
        }
        .ui-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #B8860B; }
        .ui-btn:hover { background: #fff; }
        
        h1 { 
            margin: 0; 
            font-size: 42px; 
            color: #FFD700;
            text-shadow: 3px 3px 0 #8B0000;
            font-weight: 900;
            font-style: italic;
        }
        p { margin: 5px 0; color: #fff; font-weight: bold; font-size: 1.2em; }
        .stat-label { color: #00FF00; }
        .highscore-label { color: #FFD700; }
        
        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 550px;
            max-height: 85%;
            overflow-y: auto;
            background: rgba(30, 30, 30, 0.98);
            border: 4px solid #DAA520;
            padding: 25px;
            color: white;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            border-radius: 15px;
        }
        
        .modal::-webkit-scrollbar { width: 10px; }
        .modal::-webkit-scrollbar-track { background: #333; border-radius: 5px; }
        .modal::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 5px; }

        .modal-header { color: #FFD700; margin-bottom: 20px; font-size: 2.2em; text-shadow: 2px 2px #d32f2f; font-weight: 800; border-bottom: 2px solid #555; padding-bottom: 10px; }
        
        .upgrade-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(255,255,255,0.05), rgba(255,255,255,0.1));
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .difficulty-row {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #FFD700;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }
        input[type=range] { width: 100%; margin: 15px 0; cursor: pointer; accent-color: #FFD700; }
        
        .ach-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: left;
            opacity: 0.7;
            transition: 0.3s;
        }
        .ach-row.unlocked {
            border-color: #00FF00;
            background: linear-gradient(to right, rgba(0, 100, 0, 0.4), rgba(0, 50, 0, 0.2));
            opacity: 1;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }
        .ach-icon { font-size: 28px; margin-right: 15px; }
        .ach-info h4 { margin: 0; color: #aaa; font-size: 1.1em; }
        .ach-row.unlocked .ach-info h4 { color: #FFD700; }
        .ach-info span { font-size: 0.9em; color: #ccc; }

        .btn {
            background: linear-gradient(to bottom, #228B22, #006400);
            color: white;
            border: none;
            padding: 8px 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 0 3px 0 #004d00;
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; color: #888; }
        .btn-close { background: #d32f2f; padding: 12px 30px; font-size: 1.2em; margin-top: 20px; width: 100%; box-shadow: 0 4px 0 #8B0000; }
        
        .skin-viewer {
            margin-top: 20px;
            border-top: 2px solid #555;
            padding-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
        }
        .skin-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .selector-label { width: 180px; font-size: 1.2em; color: #FFD700; font-weight: bold; text-transform: uppercase; }

        #notification {
            position: absolute;
            bottom: 250px; 
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #000, #333);
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
            z-index: 200;
            text-align: center;
            box-shadow: 0 0 25px #FFD700;
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp {
            from { bottom: 150px; opacity: 0; }
            to { bottom: 250px; opacity: 1; }
        }
        #courtNameDisplay {
            position: absolute;
            top: 60px;
            right: 20px;
            font-size: 1.5em;
            color: rgba(255,255,255,0.7);
            font-weight: 900;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
            font-style: italic;
            text-align: right;
        }
        #strikes {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #FF4500;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }
        #contest-ui {
            display: none;
            position: absolute;
            top: 150px;
            left: 20px;
            font-size: 1.2em;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <h1>TACO BASKET BALL</h1>
        <p>Tacos: <span id="scoreVal" class="stat-label">0</span></p>
        <div id="classic-stats">
            <p>Distance: <span id="distVal" class="stat-label">10 ft</span></p>
            <p>Record: <span id="highScoreVal" class="highscore-label">10 ft</span></p>
        </div>
    </div>
    <div id="strikes">MISS: <span id="missVal">0</span>/2</div>
    <div id="courtNameDisplay">BACKYARD COURT</div>
    <div id="contest-ui">
        <p style="color:#FFFF00; font-size:1.5em;">TIME: <span id="contestTime">60</span>s</p>
        <p>SCORE: <span id="contestScore" style="color:#00FF00">0</span></p>
        <p>RACK: <span id="contestRack">1</span>/5</p>
    </div>
    <div id="controls">
        <div class="ui-btn" onclick="tacoGame.ui.toggleMode()">MODE: <span id="modeBtnText">CLASSIQUE</span></div>
        <div class="ui-btn" onclick="tacoGame.ui.openShop()">SHOP [P]</div>
        <div class="ui-btn" onclick="tacoGame.ui.openAchievements()">TROPHIES [O]</div>
        <div class="ui-btn" onclick="tacoGame.ui.openStats()">STATS [S]</div>
    </div>
    <div id="notification">
        <div>üèÜ ACHIEVEMENT UNLOCKED!</div>
        <div id="notifText" style="color:white; font-size:0.8em; margin-top:5px;">Rookie</div>
    </div>

    <!-- MODALS -->
    <div id="statsUI" class="modal">
        <div class="modal-header">LIFETIME STATS</div>
        <div style="text-align:left; padding: 10px; font-size: 1.2em;">
            <p style="overflow:hidden;">Total Shots: <span id="statShots" style="color:#FFF; float:right">0</span></p>
            <p style="overflow:hidden;">Makes: <span id="statMakes" style="color:#00FF00; float:right">0</span></p>
            <p style="overflow:hidden;">Misses: <span id="statMisses" style="color:#FF0000; float:right">0</span></p>
            <p style="overflow:hidden;">Accuracy: <span id="statAccuracy" style="color:#FFD700; float:right">0%</span></p>
            <p style="overflow:hidden;">Contests Played: <span id="statContests" style="color:#00FFFF; float:right">0</span></p>
            <hr style="border-color:#555; margin:15px 0;">
            <p style="overflow:hidden;">Best Distance: <span id="statBestDist" style="color:#FFD700; float:right">0 ft</span></p>
        </div>
        <button id="btnReset" class="btn" style="background: #8B0000; margin-top: 20px; width: 100%; border: 1px solid #ff4444;" onclick="tacoGame.ui.attemptReset()">RESET PROGRESS</button>
        <button class="btn btn-close" onclick="tacoGame.ui.closeStats()">CLOSE</button>
    </div>

    <div id="shopUI" class="modal">
        <div class="modal-header">TACO MARKET</div>
        <p>Tacos Available: <span id="shopTacos" style="color:#FFFF00; font-size: 1.2em; font-weight: bold;">0</span></p>
        <div class="difficulty-row">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><strong>DIFFICULTY</strong><span id="diffLabel" style="color:#00FF00; font-weight:bold;">NORMAL (x1.0)</span></div>
            <input type="range" id="diffSlider" min="1" max="3" step="0.5" value="1" oninput="tacoGame.ui.updateDifficulty()">
            <div style="font-size:0.8em; color:#aaa;">Higher risk, higher reward!</div>
        </div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">INCOME MULTIPLIER</strong> (Lvl <span id="lvlIncome">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Sweet rewards! (x0.5/lvl)</span></div><button id="btnBuyIncome" class="btn" onclick="tacoGame.ui.buyUpgrade('income')">Buy (5)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">VIS√âE ASSIST√âE</strong> (Niv <span id="lvlAim">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Wider shot window.</span></div><button id="btnBuyAim" class="btn" onclick="tacoGame.ui.buyUpgrade('aim')">Buy (10)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">TACO GREASE</strong> (Niv <span id="lvlLuck">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Chance for favorable bounces.</span></div><button id="btnBuyLuck" class="btn" onclick="tacoGame.ui.buyUpgrade('luck')">Buy (15)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">MOONWALK</strong> (Lvl <span id="lvlMoonwalk">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Step back faster!</span></div><button id="btnBuyMoonwalk" class="btn" onclick="tacoGame.ui.buyUpgrade('moonwalk')">Buy (25)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">EXTRA LIVES</strong> (Lvl <span id="lvlExtraLives">0</span>)<br><span style="font-size:0.85em; color:#ccc;">More misses allowed before Game Over.</span></div><button id="btnBuyExtraLives" class="btn" onclick="tacoGame.ui.buyUpgrade('extraLives')">Buy (1000)</button></div>
        <div class="skin-viewer">
            <h3 style="color:#aaa; border-bottom:1px solid #555; padding-bottom:5px;">LOCKER ROOM</h3>
            <div class="skin-nav"><button class="btn" onclick="tacoGame.ui.changeAnimal(-1)">&lt;</button><span id="animalName" class="selector-label">Rat</span><button class="btn" onclick="tacoGame.ui.changeAnimal(1)">&gt;</button></div>
            <div class="skin-nav"><button class="btn" onclick="tacoGame.ui.changeSkin(-1)">&lt;</button><span id="skinName" class="selector-label">Classic</span><button class="btn" onclick="tacoGame.ui.changeSkin(1)">&gt;</button></div>
            <div id="skinStatus" style="margin-bottom:15px; color:#aaa; font-style:italic;">Equipped</div>
            <button id="btnEquipSkin" class="btn" style="width:100%; font-size: 1.1em;" onclick="tacoGame.ui.buyOrEquipSkin()">Equip</button>
        </div>
        <button class="btn btn-close" onclick="tacoGame.ui.closeShop()">CLOSE</button>
    </div>

    <div id="achUI" class="modal">
        <div class="modal-header">TROPHY ROOM</div>
        <div id="achList"></div>
        <button class="btn btn-close" onclick="tacoGame.ui.closeAchievements()">CLOSE</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
/**
 * ARCHITECTURE:
 * - Constants: Global configuration data
 * - Storage: Handles LocalStorage persistence
 * - AchievementSystem: Logic for unlocking trophies
 * - Physics: Gravity, projectile motion
 * - Renderer: Canvas drawing methods
 * - UIManager: DOM interaction, menus
 * - Game: Main controller, game loop, state management
 */

// --- 1. CONSTANTS ---
const ACHIEVEMENTS_DB = [
    { id: 'rookie', name: 'Rookie', desc: 'First basket made', reward: 10 },
    { id: 'veteran', name: 'Veteran', desc: 'Make 100 total baskets', reward: 150 },
    { id: 'ball_hog', name: 'Ball Hog', desc: 'Shoot 500 times', reward: 100 },
    { id: 'bricklayer', name: 'Bricklayer', desc: 'Miss 50 shots', reward: 25 },
    { id: 'amateur', name: 'Amateur', desc: 'Reach 25 ft', reward: 25 },
    { id: 'sniper', name: 'Sniper', desc: 'Reach 50 ft', reward: 50 },
    { id: 'pro', name: 'Pro Shooter', desc: 'Reach 75 ft', reward: 75 },
    { id: 'parking_lot', name: 'Parking Lot', desc: 'Reach 100 ft', reward: 100 },
    { id: 'longshot', name: 'Longshot', desc: 'Reach 125 ft', reward: 125 },
    { id: 'levis_legend', name: 'Legend', desc: 'Reach 150 ft', reward: 200 },
    { id: 'interstellar', name: 'Interstellar', desc: 'Reach 200 ft', reward: 300 },
    { id: 'moonwalker', name: 'Moonwalker', desc: 'Reach 500 ft', reward: 500 },
    { id: 'demigod', name: 'Demigod', desc: 'Reach 1000 ft', reward: 1000 },
    { id: 'contest_winner', name: 'Contest King', desc: 'Score > 10 in Contest', reward: 200 },
    { id: 'contest_perfect', name: 'Perfection', desc: 'Score > 20 in Contest', reward: 500 },
    { id: 'pocket_change', name: 'Pocket Change', desc: 'Have 100 Tacos', reward: 10 },
    { id: 'tycoon', name: 'Taco Tycoon', desc: 'Have 500 Tacos', reward: 50 },
    { id: 'millionaire', name: 'Millionaire', desc: 'Have 2000 Tacos', reward: 200 },
    { id: 'sweet_tooth', name: 'Sweet Tooth', desc: 'Income Lvl 5', reward: 100 },
    { id: 'hawkeye', name: 'Eagle Eye', desc: 'Aim Lvl 5', reward: 100 },
    { id: 'leprechaun', name: 'Lucky', desc: 'Luck Lvl 5', reward: 100 },
    { id: 'fashionista', name: 'Fashionista', desc: 'Unlock 5 skins', reward: 100 },
    { id: 'wardrobe_malfunction', name: 'Full Wardrobe', desc: 'Unlock 10 skins', reward: 300 },
    { id: 'collector', name: 'Collector', desc: 'Unlock 15 skins', reward: 500 },
    { id: 'zoo', name: 'Zoo Keeper', desc: 'Skins for 3 diff animals', reward: 150 },
    { id: 'lucky', name: 'Pure Luck', desc: 'Get a lucky bounce', reward: 25 },
    { id: 'daredevil', name: 'Daredevil', desc: 'Score on Max difficulty', reward: 50 },
    { id: 'hard_mode', name: 'Hard Worker', desc: 'Score on Hard difficulty', reward: 25 },
    { id: 'cosplay', name: 'Cosplay', desc: 'Equip Robot/Alien/Ninja', reward: 20 },
    { id: 'eh', name: 'Northern', desc: 'Equip Lumberjack or Hockey', reward: 20 },
    { id: 'spooky', name: 'Spooky', desc: 'Equip Zombie/Vampire/Devil', reward: 20 },
    { id: 'urban_legend', name: 'Urban Legend', desc: 'Play on Street Court', reward: 50 },
    { id: 'ice_cold', name: 'Ice Cold', desc: 'Play on Ice Rink', reward: 100 },
    { id: 'astronaut_training', name: 'Space Cadet', desc: 'Play on Moon', reward: 150 }
];

const COURT_ZONES = [
    { limit: 50, name: "BACKYARD", type: 'grass', ground1: '#228B22', ground2: '#32CD32', sky1: '#87CEEB', sky2: '#FFF' },
    { limit: 100, name: "CITY PARK", type: 'tree', ground1: '#8B4513', ground2: '#D2691E', sky1: '#87CEEB', sky2: '#E0FFFF' },
    { limit: 200, name: "OLD TOWN", type: 'castle', ground1: '#8B0000', ground2: '#A52A2A', sky1: '#4682B4', sky2: '#87CEEB' },
    { limit: 350, name: "STREET COURT", type: 'castle', ground1: '#696969', ground2: '#808080', sky1: '#4682B4', sky2: '#87CEEB' },
    { limit: 500, name: "PINE FOREST", type: 'tree', ground1: '#006400', ground2: '#2F4F4F', sky1: '#2E8B57', sky2: '#8FBC8F' },
    { limit: 750, name: "ICE RINK", type: 'mountain', ground1: '#E0FFFF', ground2: '#FFFFFF', sky1: '#87CEEB', sky2: '#F0F8FF' },
    { limit: 1000, name: "OCEAN VIEW", type: 'water', ground1: '#00008B', ground2: '#1E90FF', sky1: '#191970', sky2: '#4169E1' },
    { limit: 1500, name: "MOUNTAIN PEAK", type: 'mountain', ground1: '#F0FFFF', ground2: '#E0FFFF', sky1: '#87CEEB', sky2: '#00BFFF' },
    { limit: 2500, name: "STRATOSPHERE", type: 'space', ground1: '#483D8B', ground2: '#6A5ACD', sky1: '#000080', sky2: '#000000' },
    { limit: 4000, name: "MOON BASE", type: 'space', ground1: '#808080', ground2: '#A9A9A9', sky1: '#000000', sky2: '#191970' },
    { limit: 6000, name: "MARS", type: 'space', ground1: '#8B4513', ground2: '#CD853F', sky1: '#FF4500', sky2: '#000000' },
    { limit: 8000, name: "THE NETHER", type: 'space', ground1: '#8B0000', ground2: '#2F0000', sky1: '#330000', sky2: '#000000' },
    { limit: 9999999, name: "TACO DIMENSION", type: 'grass', ground1: '#FF00FF', ground2: '#00FFFF', sky1: '#FFFF00', sky2: '#FF0000' }
];

const SCALE_OBJECTS = [
    { limit: 15, name: "Compact Car", icon: "üöó" },
    { limit: 25, name: "Moose (2m)", icon: "ü¶å" },
    { limit: 30, name: "3-Point Line", icon: "üèÄ" },
    { limit: 40, name: "School Bus", icon: "üöå" },
    { limit: 60, name: "Bowling Lane", icon: "üé≥" },
    { limit: 94, name: "NBA Court", icon: "üèÄ" },
    { limit: 150, name: "Blue Whale", icon: "üêã" },
    { limit: 195, name: "Leaning Tower of Pisa", icon: "üáÆüáπ" },
    { limit: 230, name: "747 Wingspan", icon: "‚úàÔ∏è" },
    { limit: 272, name: "Niagara Falls", icon: "üåä" },
    { limit: 305, name: "Statue of Liberty", icon: "üóΩ" },
    { limit: 350, name: "Golden Gate Bridge", icon: "üåâ" },
    { limit: 450, name: "Giza Pyramid", icon: "üî∫" },
    { limit: 600, name: "Space Needle", icon: "üõ∏" },
    { limit: 984, name: "Eiffel Tower", icon: "üá´üá∑" },
    { limit: 1454, name: "Empire State Building", icon: "üèôÔ∏è" },
    { limit: 1815, name: "CN Tower", icon: "üóº" },
    { limit: 2200, name: "Burj Khalifa", icon: "üè¢" },
    { limit: 5280, name: "One Mile", icon: "üõ£Ô∏è" },
    { limit: 10000, name: "Runway", icon: "üõ´" },
    { limit: 14410, name: "Mt Rainier", icon: "üèîÔ∏è" },
    { limit: 20310, name: "Mt Denali", icon: "‚õ∞Ô∏è" },
    { limit: 29029, name: "Mt Everest", icon: "üóª" },
    { limit: 35000, name: "Cruising Altitude", icon: "‚úàÔ∏è" },
    { limit: 100000, name: "Stratosphere", icon: "üéà" },
    { limit: 328000, name: "Space Line", icon: "üåå" },
    { limit: 1300000, name: "Space Station", icon: "üõ∞Ô∏è" },
    { limit: 9999999, name: "La Lune", icon: "üåë" }
];

const SKINS_DB = [
    { id: 'rat_classic', animal: 'rat', name: 'Classic', cost: 0 },
    { id: 'rat_lumberjack', animal: 'rat', name: 'Lumberjack', cost: 500 },
    { id: 'rat_mariachi', animal: 'rat', name: 'Mariachi', cost: 1000 },
    { id: 'rat_luchador', animal: 'rat', name: 'Luchador', cost: 1500 },
    { id: 'rat_alien', animal: 'rat', name: 'Alien', cost: 3000 },
    { id: 'rat_zombie', animal: 'rat', name: 'Zombie', cost: 3000 },
    { id: 'rat_astronaut', animal: 'rat', name: 'Astronaut', cost: 5000 },
    { id: 'rat_ninja', animal: 'rat', name: 'Ninja', cost: 5000 },
    { id: 'rat_robot', animal: 'rat', name: 'Robot', cost: 5000 },
    { id: 'rat_pirate', animal: 'rat', name: 'Pirate', cost: 1500 },
    { id: 'rat_clown', animal: 'rat', name: 'Clown', cost: 1500 },
    { id: 'rat_vampire', animal: 'rat', name: 'Vampire', cost: 3000 },
    { id: 'rat_chef', animal: 'rat', name: 'Chef', cost: 750 },
    { id: 'rat_hockey', animal: 'rat', name: 'Hockey Player', cost: 7500 },
    { id: 'rat_poutine', animal: 'rat', name: 'Poutine', cost: 7500 },
    { id: 'rat_king', animal: 'rat', name: 'King', cost: 10000 },
    { id: 'rat_wizard', animal: 'rat', name: 'Wizard', cost: 10000 },
    { id: 'rat_devil', animal: 'rat', name: 'Devil', cost: 15000 },
    { id: 'rat_angel', animal: 'rat', name: 'Angel', cost: 15000 },
    { id: 'cat_classic', animal: 'cat', name: 'Classique', cost: 250 },
    { id: 'cat_tabby', animal: 'cat', name: 'Tabby', cost: 1000 },
    { id: 'cat_tuxedo', animal: 'cat', name: 'Tuxedo', cost: 1000 },
    { id: 'dog_classic', animal: 'dog', name: 'Classique', cost: 250 },
    { id: 'dog_dalmation', animal: 'dog', name: 'Dalmatian', cost: 1000 },
    { id: 'dog_pug', animal: 'dog', name: 'Pug', cost: 1500 },
    { id: 'bear_classic', animal: 'bear', name: 'Classique', cost: 500 },
    { id: 'bear_panda', animal: 'bear', name: 'Panda', cost: 3000 },
    { id: 'bear_polar', animal: 'bear', name: 'Polar', cost: 3000 },
    { id: 'rabbit_classic', animal: 'rabbit', name: 'Classique', cost: 250 },
    { id: 'rabbit_jack', animal: 'rabbit', name: 'Jackrabbit', cost: 1000 },
    { id: 'rabbit_magic', animal: 'rabbit', name: 'Magician', cost: 2500 },
    { id: 'beaver_classic', animal: 'beaver', name: 'Classique', cost: 500 },
    { id: 'beaver_lumber', animal: 'beaver', name: 'Lumberjack', cost: 1500 },
    { id: 'moose_classic', animal: 'moose', name: 'Classique', cost: 750 },
    { id: 'moose_royal', animal: 'moose', name: 'Royal', cost: 5000 },
    { id: 'penguin_classic', animal: 'penguin', name: 'Classique', cost: 750 },
    { id: 'penguin_emperor', animal: 'penguin', name: 'Emperor', cost: 3000 },
    { id: 'raccoon_classic', animal: 'raccoon', name: 'Classique', cost: 500 },
    { id: 'raccoon_bandit', animal: 'raccoon', name: 'Bandit', cost: 1500 }
];

const ANIMALS = ['rat', 'cat', 'dog', 'bear', 'rabbit', 'beaver', 'moose', 'penguin', 'raccoon'];

// --- 2. STORAGE CLASS ---
class Storage {
    constructor() {
        this.defaultData = {
            tacos: 0,
            level: 1,
            difficulty: 1.0,
            highScore: 10,
            stats: { income: 1, aim: 1, luck: 1, moonwalk: 1, extraLives: 0 },
            lifetimeStats: { shots: 0, makes: 0, misses: 0, contests: 0 },
            unlockedSkins: ['rat_classic'],
            currentSkin: 'rat_classic',
            unlockedAchievements: []
        };
        this.data = this.load();
    }

    load() {
        const saved = localStorage.getItem('tacoSaveData');
        let data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(this.defaultData));

        // MIGRATION & SAFETY CHECKS
        if(!data.unlockedAchievements) data.unlockedAchievements = [];
        if(!data.stats.income) data.stats.income = 1;
        if(!data.stats.moonwalk) data.stats.moonwalk = 1;
        if(typeof data.stats.extraLives === 'undefined') data.stats.extraLives = 0;
        if(!data.lifetimeStats) data.lifetimeStats = { shots: 0, makes: 0, misses: 0, contests: 0 };
        if(!data.unlockedSkins) data.unlockedSkins = ['rat_classic'];
        if(!data.currentSkin) data.currentSkin = 'rat_classic';

        return data;
    }

    save() {
        localStorage.setItem('tacoSaveData', JSON.stringify(this.data));
    }
    
    reset() {
        this.data = JSON.parse(JSON.stringify(this.defaultData));
        this.save();
    }
}

// --- 3. ACHIEVEMENT SYSTEM ---
class AchievementSystem {
    constructor(game) {
        this.game = game;
    }

    unlock(id) {
        if (!this.game.storage.data.unlockedAchievements.includes(id)) {
            const ach = ACHIEVEMENTS_DB.find(a => a.id === id);
            if (ach) {
                this.game.storage.data.unlockedAchievements.push(id);
                this.game.storage.data.tacos += ach.reward;
                this.game.storage.save();
                this.game.ui.showNotification(ach.name, ach.reward);
                this.game.ui.update(); // Update score display
            }
        }
    }

    // New unified check method called from various game events
    check(triggerType, contextData = {}) {
        const data = this.game.storage.data;
        const dist = 10 + (this.game.distanceLevel * 5);

        // 1. DISTANCE BASED
        if (triggerType === 'distance' || triggerType === 'score') {
            if (dist >= 25) this.unlock('amateur');
            if (dist >= 50) this.unlock('sniper');
            if (dist >= 75) this.unlock('pro');
            if (dist >= 100) this.unlock('parking_lot');
            if (dist >= 125) this.unlock('longshot');
            if (dist >= 150) this.unlock('levis_legend');
            if (dist >= 200) this.unlock('interstellar');
            if (dist >= 500) this.unlock('moonwalker'); // Fixed threshold from memory
            if (dist >= 1000) this.unlock('demigod');

            // Location/Court specific
            const court = this.game.getCourtDetails(dist);
            if (court.name.includes("STREET")) this.unlock('urban_legend');
            if (court.name.includes("ICE")) this.unlock('ice_cold');
            if (court.name.includes("MOON")) this.unlock('astronaut_training');
        }

        // 2. WEALTH / TACOS
        if (triggerType === 'balance_update' || triggerType === 'score') {
            if (data.tacos >= 100) this.unlock('pocket_change');
            if (data.tacos >= 500) this.unlock('tycoon');
            if (data.tacos >= 2000) this.unlock('millionaire');
        }

        // 3. STATS / UPGRADES
        if (triggerType === 'stat_update') {
            if (data.stats.income >= 5) this.unlock('sweet_tooth');
            if (data.stats.aim >= 5) this.unlock('hawkeye');
            if (data.stats.luck >= 5) this.unlock('leprechaun');
        }

        // 4. COLLECTION / SKINS
        if (triggerType === 'skin_update' || triggerType === 'shop') {
            if (data.unlockedSkins.length >= 5) this.unlock('fashionista');
            if (data.unlockedSkins.length >= 10) this.unlock('wardrobe_malfunction');
            if (data.unlockedSkins.length >= 15) this.unlock('collector');

            // Check for unique animal types
            const ownedAnimals = new Set();
            data.unlockedSkins.forEach(skinId => {
                const s = SKINS_DB.find(dbSkin => dbSkin.id === skinId);
                if (s) ownedAnimals.add(s.animal);
            });
            if (ownedAnimals.size >= 3) this.unlock('zoo');
        }

        // 5. CURRENT SKIN EQUIPPED
        if (triggerType === 'skin_equip') {
             const skin = data.currentSkin;
             if(skin.includes('robot') || skin.includes('alien') || skin.includes('ninja')) this.unlock('cosplay');
             if(skin.includes('lumberjack') || skin.includes('hockey')) this.unlock('eh');
             if(skin.includes('zombie') || skin.includes('vampire') || skin.includes('devil')) this.unlock('spooky');
        }

        // 6. SHOT RESULTS
        if (triggerType === 'shot_result') {
            if (contextData.made) {
                 this.unlock('rookie');
                 if (data.lifetimeStats.makes >= 100) this.unlock('veteran');
                 if (data.difficulty >= 3) this.unlock('daredevil');
                 if (data.difficulty >= 2) this.unlock('hard_mode');
            }
            if (data.lifetimeStats.shots >= 500) this.unlock('ball_hog');
            if (data.lifetimeStats.misses >= 50) this.unlock('bricklayer');
        }

        // 7. CONTEST
        if (triggerType === 'contest_end') {
             if (this.game.contestData.score > 10) this.unlock('contest_winner');
             if (this.game.contestData.score > 20) this.unlock('contest_perfect');
        }

        // 8. MISC
        if (triggerType === 'lucky_bounce') this.unlock('lucky');
    }

    checkAll() {
        this.check('score');
        this.check('distance');
        this.check('balance_update');
        this.check('stat_update');
        this.check('skin_update');
        this.check('skin_equip');
        this.check('shot_result', { made: false }); // General stats check
    }
}

// --- 4. RENDERER CLASS ---
class Renderer {
    constructor(game) {
        this.game = game;
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = 800;
        this.height = 600;
        this.canvas.width = this.width;
        this.canvas.height = this.height;

        this.snowParticles = [];
        for(let i=0; i<100; i++) {
            this.snowParticles.push({
                x: Math.random() * this.width,
                y: Math.random() * this.height,
                r: Math.random() * 2 + 1,
                speed: Math.random() * 2 + 1
            });
        }

        this.decors = [];
        for(let i=0; i<300; i++) {
            let dist = Math.random() * 10000;
            let pathX = 600 - (dist * 0.7);
            let pathY = 150 + (dist * 0.7);
            let scatter = (Math.random() - 0.5) * 1200;
            this.decors.push({ x: pathX + scatter, y: pathY + scatter, dist: dist });
        }

        this.mountains = [];
        for(let i=0; i<15; i++) {
            this.mountains.push({ x: i * 80 - 100, h: 100 + Math.random() * 150, color: `hsl(25, ${30 + Math.random()*20}%, ${20 + Math.random()*10}%)` });
        }

        // Bind resize
        window.addEventListener('resize', () => this.resize());
        this.resize();
    }

    resize() {
        const container = document.getElementById('game-container');
        let winW = window.innerWidth;
        let winH = window.innerHeight;
        let scale = Math.min(winW / 800, winH / 600) * 0.95;
        container.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    project(x, y, z) {
        const HOOP_POS = this.game.HOOP_POS;
        const player = this.game.player;

        let dxToHoop = HOOP_POS.x - player.x;
        let dyToHoop = HOOP_POS.y - player.y;
        let distToHoop = Math.sqrt(dxToHoop*dxToHoop + dyToHoop*dyToHoop);

        // Dynamic camera
        let idealZoom = 380 * (400 + distToHoop) / Math.max(100, distToHoop);
        idealZoom = Math.min(1000, Math.max(400, idealZoom));
        this.game.cameraZoom = idealZoom;
        this.game.cameraHeight = 84000 / idealZoom;

        let angleToHoop = Math.atan2(dyToHoop, dxToHoop);
        let rotation = -angleToHoop - Math.PI/2;

        let dx = x - player.x;
        let dy = y - player.y;
        let rx = dx * Math.cos(rotation) - dy * Math.sin(rotation);
        let ry = dx * Math.sin(rotation) + dy * Math.cos(rotation);

        let cameraOffset = 400;
        let depth = cameraOffset - ry;

        if (depth <= 0) return null; 

        let scale = this.game.cameraZoom / depth;
        let screenX = this.width / 2 + (rx * scale);
        let horizonY = (this.height - 120) * 0.5;
        let screenY = horizonY + (this.game.cameraHeight - z) * scale;

        return { x: screenX, y: screenY, scale: scale, depth: depth };
    }

    draw() {
        this.ctx.clearRect(0, 0, this.width, this.height);
        this.drawBackground();
        this.drawScene();
        this.drawUI();
    }

    drawBackground() {
        let currentDist = 10 + (this.game.distanceLevel * 5);
        if(this.game.mode === 'CONTEST') currentDist = 25; // Fixed context for contest

        let court = this.game.getCourtDetails(currentDist);
        let horizonY = (this.height - 120) * 0.5;

        // Shake effect
        if(this.game.shakeIntensity > 0) {
            this.ctx.save();
            let s = this.game.shakeIntensity;
            this.ctx.translate((Math.random()-0.5)*s, (Math.random()-0.5)*s);
            this.game.shakeIntensity--;
        }

        // Sky
        let skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.height * 0.6);
        skyGrad.addColorStop(0, court.sky1); skyGrad.addColorStop(1, court.sky2); 
        this.ctx.fillStyle = skyGrad; this.ctx.fillRect(0, 0, this.width, this.height);
        
        // Ground base
        let currentZoneGrad = this.ctx.createLinearGradient(0, horizonY, 0, this.height);
        currentZoneGrad.addColorStop(0, court.ground1); currentZoneGrad.addColorStop(1, court.ground2);
        this.ctx.fillStyle = currentZoneGrad; this.ctx.fillRect(0, horizonY, this.width, this.height - horizonY);

        // Zones stripes
        const HOOP_POS = this.game.HOOP_POS;
        const player = this.game.player;

        // Helper to project distance markers
        const getProjectedY = (gDist) => {
            if (gDist <= 0) {
                let p = this.project(HOOP_POS.x, HOOP_POS.y, 0);
                return p ? p.y : horizonY;
            }
            let ratio = gDist / currentDist;
            // Prevent division by zero or negative logic if at 0 dist
            if(currentDist <= 1) ratio = 1;

            let wx = HOOP_POS.x + (player.x - HOOP_POS.x) * ratio;
            let wy = HOOP_POS.y + (player.y - HOOP_POS.y) * ratio;
            let p = this.project(wx, wy, 0);
            return p ? p.y : this.height;
        };

        for (let i = 0; i < COURT_ZONES.length; i++) {
            let z = COURT_ZONES[i];
            let zStart = (i === 0) ? 0 : COURT_ZONES[i-1].limit;
            let zEnd = z.limit;
            if (zStart >= currentDist) break; 
            let drawEnd = Math.min(zEnd, currentDist);
            let yTop = getProjectedY(zStart);
            let yBottom = getProjectedY(drawEnd);
            if ((yBottom - yTop) > 0.5) {
                let grad = this.ctx.createLinearGradient(0, yTop, 0, yBottom);
                grad.addColorStop(0, z.ground1); grad.addColorStop(1, z.ground2);
                this.ctx.fillStyle = grad; this.ctx.fillRect(0, yTop, this.width, (yBottom - yTop) + 2);
            }
        }

        // Mountains
        this.mountains.forEach(m => {
            let shift = (player.x + player.y) * 0.05;
            let xPos = ((m.x - shift) % (this.width + 200)) - 100;
            this.ctx.beginPath();
            this.ctx.moveTo(xPos, horizonY);
            this.ctx.lineTo(xPos + 60, horizonY - m.h);
            this.ctx.lineTo(xPos + 120, horizonY);
            this.ctx.fillStyle = m.color;
            this.ctx.fill();
        });

        // Horizon line
        this.ctx.beginPath(); this.ctx.moveTo(0, horizonY); this.ctx.lineTo(this.width, horizonY);
        this.ctx.strokeStyle = 'rgba(0,0,0,0.3)'; this.ctx.stroke();
    }

    drawScene() {
        let renderList = [];
        const HOOP_POS = this.game.HOOP_POS;
        let currentDist = 10 + (this.game.distanceLevel * 5);
        if(this.game.mode === 'CONTEST') currentDist = 25;

        // Decors
        this.decors.forEach(d => {
            let proj = this.project(d.x, d.y, 0);
            let dDist = Math.sqrt(Math.pow(d.x - HOOP_POS.x, 2) + Math.pow(d.y - HOOP_POS.y, 2));
            let decorZone = COURT_ZONES.find(z => dDist < z.limit) || COURT_ZONES[COURT_ZONES.length-1];
            if (proj) renderList.push({ type: 'decor', depth: proj.depth, proj: proj, zoneType: decorZone.type }); 
        });

        // Obstacles
        this.game.obstacles.forEach(o => {
             if(o.active) {
                 let proj = this.project(o.x, o.y, o.z);
                 if(proj) renderList.push({ type: 'goose', depth: proj.depth, proj: proj, obj: o });
             }
        });

        // Hoop
        let hoopProj = this.project(HOOP_POS.x, HOOP_POS.y, HOOP_POS.z);
        if (hoopProj) renderList.push({ type: 'hoop', depth: hoopProj.depth, proj: hoopProj });
        
        // Player & Shadow
        let player = this.game.player;
        let playerProj = this.project(player.x, player.y, player.z);
        if (playerProj) renderList.push({ type: 'player', depth: playerProj.depth, proj: playerProj });

        let shadowProj = this.project(player.x, player.y, 0);
        if (shadowProj) renderList.push({ type: 'shadow', depth: shadowProj.depth, proj: shadowProj });

        // Ball
        let ball = this.game.ball;
        if ((this.game.state === 'SHOOTING' || this.game.state === 'RESETTING') && ball.active) {
            let ballProj = this.project(ball.x, ball.y, ball.z);
            if (ballProj) renderList.push({ type: 'ball', depth: ballProj.depth, proj: ballProj });
        }

        // Sort by depth (Painter's Algorithm)
        renderList.sort((a, b) => b.depth - a.depth);

        // Render
        renderList.forEach(obj => {
            if (obj.type === 'decor') this.drawDecor(obj.proj, obj.zoneType);
            if (obj.type === 'hoop') this.drawHoop(obj.proj);
            if (obj.type === 'shadow') this.drawShadow(obj.proj);
            if (obj.type === 'player') this.drawPlayer(obj.proj);
            if (obj.type === 'ball') this.drawBall(obj.proj);
            if (obj.type === 'goose') this.drawGoose(obj.proj);
        });
        
        // Snow
        this.ctx.fillStyle = "rgba(255,255,255,0.7)";
        this.snowParticles.forEach(p => {
             // Update snow here for visual effect
             p.y += p.speed;
             p.x += Math.sin(p.y * 0.01) * 0.5;
             if(p.y > this.height) p.y = 0;
             this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); this.ctx.fill();
        });
    }

    drawDecor(p, type) {
        if (!p) return; 
        let s = p.scale;
        let ctx = this.ctx;

        if(type === 'grass') { 
            ctx.fillStyle = '#F4C430'; 
            ctx.beginPath(); ctx.arc(p.x, p.y - 20*s, 30*s, Math.PI, 0); ctx.fill();
            ctx.strokeStyle = '#D2691E'; ctx.lineWidth = 2*s; ctx.stroke();
            ctx.fillStyle = '#32CD32'; for(let i=0; i<5; i++) { ctx.beginPath(); ctx.arc(p.x - 25*s + (i*12*s), p.y - 45*s, 8*s, 0, Math.PI*2); ctx.fill(); }
            ctx.fillStyle = '#FFA500'; ctx.beginPath(); ctx.arc(p.x - 30*s, p.y - 25*s, 15*s, 0, Math.PI*2); ctx.fill();
        } 
        else if(type === 'tree') {
            ctx.fillStyle = '#8B4513'; ctx.fillRect(p.x - 5*s, p.y, 10*s, -20*s);
            ctx.fillStyle = '#006400';
            ctx.beginPath(); ctx.moveTo(p.x - 30*s, p.y - 15*s); ctx.lineTo(p.x + 30*s, p.y - 15*s); ctx.lineTo(p.x, p.y - 80*s); ctx.fill();
            ctx.beginPath(); ctx.moveTo(p.x - 25*s, p.y - 40*s); ctx.lineTo(p.x + 25*s, p.y - 40*s); ctx.lineTo(p.x, p.y - 100*s); ctx.fill();
        }
        else if (type === 'water') {
             ctx.fillStyle = '#00008B'; ctx.beginPath(); ctx.arc(p.x, p.y, 10*s, 0, Math.PI*2); ctx.fill();
             ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p.x, p.y, 5*s, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'castle') {
            ctx.strokeStyle = '#222'; ctx.lineWidth = 3*s;
            ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y - 50*s); ctx.stroke();
            ctx.fillStyle = '#FFFFE0'; ctx.beginPath(); ctx.arc(p.x, p.y - 55*s, 8*s, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'mountain') {
            ctx.fillStyle = '#808080'; ctx.beginPath(); ctx.arc(p.x, p.y, 20*s, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p.x, p.y, 20*s, 3.5, 5.9); ctx.fill();
        }
        else if (type === 'space') {
            ctx.fillStyle = '#555'; ctx.beginPath(); ctx.arc(p.x, p.y - 30*s, 15*s, 0, Math.PI*2); ctx.fill();
        }
    }

    drawGoose(p) {
        let s = p.scale;
        let ctx = this.ctx;
        ctx.fillStyle = '#696969';
        ctx.beginPath(); ctx.ellipse(p.x, p.y, 20*s, 10*s, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(p.x + 20*s, p.y - 10*s, 5*s, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#FFF'; ctx.fillRect(p.x + 18*s, p.y - 8*s, 4*s, 2*s);
    }

    drawShadow(p) {
        if(!p) return;
        this.ctx.fillStyle='rgba(0,0,0,0.3)';
        this.ctx.beginPath();
        this.ctx.ellipse(p.x, p.y, 25*p.scale, 8*p.scale, 0, 0, Math.PI*2);
        this.ctx.fill();
    }

    drawHoop(p) {
        if (!p) return;
        let s = p.scale;
        let ctx = this.ctx;
        const HOOP_POS = this.game.HOOP_POS;
        
        let currentPos = { x: HOOP_POS.x, y: HOOP_POS.y, z: HOOP_POS.z };
        let moveX = (currentPos.x - HOOP_POS.x) * s;

        // Pole
        let baseP = this.project(HOOP_POS.x, HOOP_POS.y, 0);
        if(baseP) {
            ctx.fillStyle = '#444';
            ctx.fillRect(p.x - 2*s + moveX, p.y, 4*s, baseP.y - p.y);
        }
        
        // Backboard
        let bbW = 60 * s; let bbH = 40 * s; let bbX = p.x - bbW/2 + moveX; let bbY = p.y - bbH - 10*s;
        ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillRect(bbX, bbY, bbW, bbH);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2*s; ctx.strokeRect(bbX, bbY, bbW, bbH);
        ctx.fillStyle = '#CE1126'; ctx.fillRect(bbX + bbW*0.35, bbY + bbH*0.6, bbW*0.3, bbH*0.3);
        
        // Rim
        if(this.game.isOnFire) {
            ctx.shadowBlur = 20; ctx.shadowColor = "red"; ctx.strokeStyle = "orange";
        } else {
            ctx.strokeStyle = 'orange';
        }
        
        ctx.beginPath(); ctx.ellipse(p.x + moveX, p.y, 18 * s, 5 * s, 0, 0, Math.PI * 2);
        ctx.lineWidth = 4 * s; ctx.stroke();
        ctx.shadowBlur = 0; 
        
        // Net
        ctx.beginPath(); ctx.moveTo(p.x - 15*s + moveX, p.y);
        ctx.lineTo(p.x - 10*s + moveX, p.y + 20*s);
        ctx.lineTo(p.x + 10*s + moveX, p.y + 20*s);
        ctx.lineTo(p.x + 15*s + moveX, p.y);
        ctx.strokeStyle = 'white'; ctx.lineWidth = 1*s; ctx.stroke();
    }

    drawBall(p) {
        if (!p) return;
        let s = p.scale;
        let ctx = this.ctx;

        let color1 = '#ff6600'; let color2 = '#cc5500';
        if(this.game.isGoldenBall) { color1 = '#FFD700'; color2 = '#DAA520'; }
        if(this.game.isOnFire) { color1 = '#FF4500'; color2 = '#8B0000'; }

        if(this.game.mode === 'CONTEST' && this.game.contestData.ballsInRack === 4) {
            color1 = '#FFFFFF'; color2 = '#0000FF';
        }

        ctx.strokeStyle = '#000'; ctx.lineWidth = 1 * s;
        let grad = ctx.createRadialGradient(p.x - 2*s, p.y - 2*s, 1*s, p.x, p.y, 8*s);
        grad.addColorStop(0, color1); grad.addColorStop(1, color2);

        if(this.game.isOnFire) {
             ctx.shadowBlur = 15; ctx.shadowColor = "orange";
        }

        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, 8 * s, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.shadowBlur = 0;

        ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.beginPath(); ctx.arc(p.x, p.y, 8 * s, 0, Math.PI*2); ctx.stroke();
        if(this.game.mode === 'CONTEST' && this.game.contestData.ballsInRack === 4) {
            ctx.strokeStyle = '#FF0000'; ctx.lineWidth = 2 * s;
        }
        ctx.beginPath(); ctx.moveTo(p.x - 8*s, p.y); ctx.quadraticCurveTo(p.x, p.y + 4*s, p.x + 8*s, p.y); ctx.stroke();
    }

    getSkinVisuals(skinId, animal) {
        let v = {
            fur: '#777', torso: '#777', legs: '#777', arm: '#777', snoutColor: null,
            hat: null, face: null, body: null, back: null, tail: null,
            sizeMod: { w: 1, h: 1, head: 1 },
            headType: 'circle', earType: 'round', bodyType: 'default',
            hasJersey: true
        };

        // Animal Base Config
        if (animal === 'rat') {
            v.fur = '#696969'; v.sizeMod = { w: 0.7, h: 0.7, head: 0.8 };
            v.headType = 'snout_pointed'; v.earType = 'round_large'; v.snoutColor = '#FFC0CB';
        }
        else if (animal === 'cat') {
            v.fur = '#FFA500'; v.sizeMod = { w: 0.8, h: 0.8, head: 0.8 };
            v.headType = 'oval_wide'; v.earType = 'pointy';
        }
        else if (animal === 'dog') {
            v.fur = '#8B4513'; v.sizeMod = { w: 0.9, h: 0.9, head: 0.9 };
            v.headType = 'snout_box'; v.earType = 'floppy'; v.snoutColor = '#000';
        }
        else if (animal === 'bear') {
            v.fur = '#4B3621'; v.sizeMod = { w: 1.4, h: 1.1, head: 1.2 };
            v.headType = 'snout_round'; v.earType = 'round'; v.bodyType = 'broad'; v.snoutColor = '#D2B48C';
        }
        else if (animal === 'rabbit') {
            v.fur = '#EEE8AA'; v.sizeMod = { w: 0.8, h: 0.8, head: 0.9 };
            v.earType = 'long'; v.headType = 'oval';
        }
        else if (animal === 'beaver') {
            v.fur = '#8B4513'; v.sizeMod = { w: 0.9, h: 0.9, head: 0.9 };
            v.tail = 'beaver'; v.headType = 'snout_box'; v.earType = 'round'; v.bodyType = 'broad';
        }
        else if (animal === 'moose') {
            v.fur = '#8B4513'; v.sizeMod = { w: 1.2, h: 1.3, head: 1.1 };
            v.hat = 'antlers'; v.headType = 'snout_long'; v.earType = 'pointy_side'; v.bodyType = 'broad';
        }
        else if (animal === 'penguin') {
            v.fur = '#222'; v.sizeMod = { w: 0.9, h: 0.8, head: 0.8 };
            v.body = 'tuxedo_belly'; v.bodyType = 'egg'; v.headType = 'beak'; v.earType = 'none';
        }
        else if (animal === 'raccoon') {
            v.fur = '#777'; v.sizeMod = { w: 0.8, h: 0.8, head: 0.8 };
            v.face = 'mask_raccoon'; v.headType = 'snout_pointed'; v.earType = 'pointy';
        }

        v.torso = v.fur; v.legs = v.fur; v.arm = v.fur;

        // Specific Skin Overrides
        if (skinId.includes('lumberjack') || skinId.includes('lumber')) {
            v.torso = '#CC0000'; v.legs = '#333399';
            v.body = 'flannel'; v.hat = 'beanie_orange';
            if(animal==='rat' || animal==='beaver') v.face = 'beard_brown';
            v.hasJersey = false;
        }
        else if (skinId.includes('mariachi')) {
            v.torso = '#222'; v.legs = '#222'; v.arm = '#222';
            v.hat = 'sombrero'; v.body = 'mariachi_tie';
            v.hasJersey = false;
        }
        else if (skinId.includes('luchador')) {
            v.torso = '#FFD700'; v.legs = '#008000';
            v.face = 'mask_lucha'; v.back = 'cape_red';
            v.hasJersey = false;
        }
        else if (skinId.includes('alien')) {
            v.fur = '#32CD32'; v.torso='#32CD32'; v.legs='#32CD32'; v.arm='#32CD32';
            v.hat = 'antenna_alien'; v.face = 'eyes_black';
            v.hasJersey = false;
        }
        else if (skinId.includes('zombie')) {
            v.fur = '#556B2F'; v.torso='#4B5320'; v.legs='#2F4F4F';
            v.body = 'tattered'; v.face = 'zombie_eye';
            v.hasJersey = false;
        }
        else if (skinId.includes('astronaut')) {
            v.fur = '#EEE'; v.torso='#FFF'; v.legs='#FFF'; v.arm='#FFF';
            v.hat = 'helmet_bubble'; v.body = 'badge_nasa';
            v.hasJersey = false;
        }
        else if (skinId.includes('ninja')) {
            v.fur = '#111'; v.torso='#111'; v.legs='#111'; v.arm='#111';
            v.face = 'mask_ninja'; v.back = 'sword_ninja';
            v.hasJersey = false;
        }
        else if (skinId.includes('robot')) {
            v.fur = '#C0C0C0'; v.torso='#A9A9A9'; v.legs='#A9A9A9'; v.arm='#A9A9A9';
            v.hat = 'antenna_robot'; v.face = 'eyes_red_glow';
            v.hasJersey = false;
        }
        else if (skinId.includes('pirate')) {
            v.torso = '#FFF'; v.legs = '#333';
            v.hat = 'pirate_hat'; v.face = 'eyepatch';
            v.hasJersey = false;
        }
        else if (skinId.includes('clown')) {
            v.torso = '#FFFF00'; v.legs = '#FF00FF'; v.arm = '#00FFFF';
            v.hat = 'clown_wig'; v.face = 'nose_red';
            v.hasJersey = false;
        }
        else if (skinId.includes('vampire')) {
            v.torso = '#000'; v.legs = '#000'; v.arm = '#000';
            v.back = 'cape_black_red'; v.hat = 'hair_widow';
            v.hasJersey = false;
        }
        else if (skinId.includes('chef')) {
            v.torso = '#FFF'; v.legs = '#000'; v.arm = '#FFF'; v.hat = 'hat_chef';
            v.hasJersey = false;
        }
        else if (skinId.includes('hockey')) {
            v.torso = '#FFF'; v.legs = '#000'; v.face = 'mask_hockey';
        }
        else if (skinId.includes('king') || skinId.includes('royal')) {
            v.torso = '#800080'; v.legs = '#800080'; v.hat = 'crown'; v.back = 'cape_royal';
            v.hasJersey = false;
        }
        else if (skinId.includes('wizard') || skinId.includes('magic')) {
            v.torso = '#4B0082'; v.legs = '#4B0082';
            v.hat = (skinId.includes('magic')) ? 'hat_top' : 'hat_wizard';
            v.face = (skinId.includes('magic')) ? null : 'beard_white';
            v.hasJersey = false;
        }
        else if (skinId.includes('devil')) {
            v.fur = '#DC143C'; v.torso='#DC143C'; v.legs='#DC143C'; v.arm='#DC143C';
            v.hat = 'horns'; v.tail = 'tail_devil';
            v.hasJersey = false;
        }
        else if (skinId.includes('angel')) {
            v.fur = '#FFF'; v.torso='#FFF'; v.legs='#FFF'; v.arm='#FFF';
            v.hat = 'halo'; v.back = 'wings_angel';
            v.hasJersey = false;
        }
        else if (skinId.includes('poutine')) {
            v.torso = '#F5DEB3'; v.legs = '#8B4513'; v.body = 'messy_poutine';
            v.hasJersey = false;
        }
        else if (skinId === 'cat_tuxedo') { v.fur = '#111'; v.torso = '#111'; v.body = 'tuxedo_belly'; }
        else if (skinId === 'dog_dalmation') { v.fur = '#FFF'; v.body = 'spots'; }
        else if (skinId === 'dog_pug') { v.fur = '#F5DEB3'; v.face = 'mask_pug'; }
        else if (skinId === 'bear_panda') { v.fur = '#FFF'; v.torso = '#FFF'; v.legs = '#000'; v.arm = '#000'; v.face = 'eyes_panda'; }
        else if (skinId === 'rabbit_jack') { v.fur = '#CD853F'; v.hat = 'ears_long'; }
        else if (skinId === 'penguin_emperor') { v.torso = '#333'; v.body = 'belly_yellow_grad'; }
        else if (skinId === 'raccoon_bandit') { v.hat = 'hat_bandit'; v.face = 'mask_bandit'; v.body = 'striped_shirt'; v.hasJersey = false; }

        return v;
    }

    drawHat(type, x, y, s) {
        let ctx = this.ctx;
        if(type === 'beanie_orange') {
            ctx.fillStyle = '#FF4500'; ctx.beginPath(); ctx.arc(x, y - 5*s, 14*s, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#FFA500'; ctx.fillRect(x - 14*s, y - 8*s, 28*s, 6*s);
        } else if (type === 'sombrero') {
            ctx.fillStyle = '#D2691E'; ctx.beginPath(); ctx.ellipse(x, y - 5*s, 25*s, 8*s, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x, y - 10*s, 10*s, Math.PI, 0); ctx.fill();
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2*s; ctx.stroke();
        } else if (type === 'antenna_alien') {
            ctx.strokeStyle = '#32CD32'; ctx.lineWidth = 2*s;
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y-20*s); ctx.stroke();
            ctx.fillStyle = '#00FF00'; ctx.beginPath(); ctx.arc(x, y-20*s, 4*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'antenna_robot') {
            ctx.fillStyle = '#888'; ctx.fillRect(x-2*s, y-15*s, 4*s, 10*s);
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(x, y-18*s, 3*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'helmet_bubble') {
            ctx.fillStyle = 'rgba(200, 200, 255, 0.3)'; ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2*s;
            ctx.beginPath(); ctx.arc(x, y, 16*s, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        } else if (type === 'pirate_hat') {
            ctx.fillStyle = '#111'; ctx.beginPath(); ctx.moveTo(x-20*s, y); ctx.quadraticCurveTo(x, y-15*s, x+20*s, y); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = `${8*s}px Arial`; ctx.fillText("‚ò†Ô∏è", x, y-5*s);
        } else if (type === 'clown_wig') {
            ctx.fillStyle = '#FF0000';
            ctx.beginPath(); ctx.arc(x-12*s, y, 8*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x+12*s, y, 8*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'hair_widow') {
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(x-12*s, y-5*s); ctx.lineTo(x, y+5*s); ctx.lineTo(x+12*s, y-5*s); ctx.lineTo(x, y-15*s); ctx.fill();
        } else if (type === 'hat_chef') {
            ctx.fillStyle = '#FFF'; ctx.fillRect(x-10*s, y-20*s, 20*s, 15*s);
            ctx.beginPath(); ctx.arc(x, y-20*s, 12*s, Math.PI, 0); ctx.fill();
        } else if (type === 'crown') {
            ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.moveTo(x-10*s, y-5*s); ctx.lineTo(x-10*s, y-20*s); ctx.lineTo(x-5*s, y-10*s); ctx.lineTo(x, y-25*s); ctx.lineTo(x+5*s, y-10*s); ctx.lineTo(x+10*s, y-20*s); ctx.lineTo(x+10*s, y-5*s); ctx.fill();
        } else if (type === 'hat_wizard') {
            ctx.fillStyle = '#4B0082'; ctx.beginPath(); ctx.moveTo(x-15*s, y-5*s); ctx.lineTo(x+15*s, y-5*s); ctx.lineTo(x, y-35*s); ctx.fill();
        } else if (type === 'horns') {
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.moveTo(x-8*s, y-8*s); ctx.quadraticCurveTo(x-12*s, y-15*s, x-5*s, y-12*s); ctx.fill();
            ctx.beginPath(); ctx.moveTo(x+8*s, y-8*s); ctx.quadraticCurveTo(x+12*s, y-15*s, x+5*s, y-12*s); ctx.fill();
        } else if (type === 'halo') {
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3*s; ctx.beginPath(); ctx.ellipse(x, y-15*s, 12*s, 4*s, 0, 0, Math.PI*2); ctx.stroke();
        } else if (type === 'ears_long') {
            ctx.fillStyle = '#CD853F'; ctx.beginPath(); ctx.ellipse(x-5*s, y-20*s, 4*s, 15*s, -0.2, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(x+5*s, y-20*s, 4*s, 15*s, 0.2, 0, Math.PI*2); ctx.fill();
        } else if (type === 'hat_top') {
            ctx.fillStyle = '#000'; ctx.fillRect(x-10*s, y-25*s, 20*s, 20*s); ctx.fillRect(x-15*s, y-5*s, 30*s, 2*s);
        } else if (type === 'hat_bandit') {
            ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(x, y-5*s, 18*s, 4*s, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x, y-8*s, 10*s, Math.PI, 0); ctx.fill();
        } else if (type === 'antlers') {
             ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 3*s;
             ctx.beginPath(); ctx.moveTo(x-5*s, y-8*s); ctx.lineTo(x-20*s, y-20*s); ctx.moveTo(x+5*s, y-8*s); ctx.lineTo(x+20*s, y-20*s); ctx.stroke();
        }
    }

    drawHead(type, x, y, r, s, color, snoutColor) {
        let ctx = this.ctx;
        ctx.fillStyle = color;

        // Base Head
        if (type.includes('oval')) {
            ctx.beginPath(); ctx.ellipse(x, y, r*1.2, r*0.9, 0, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        }

        // Snout Projection
        if (type.includes('snout')) {
            ctx.fillStyle = snoutColor || color;
            let sy = y + r*0.2;
            if (type === 'snout_pointed') {
                // Rat style
                ctx.beginPath(); ctx.moveTo(x - r*0.5, sy); ctx.lineTo(x + r*0.5, sy); ctx.lineTo(x, sy + r*1.2); ctx.fill();
                ctx.fillStyle = 'pink'; ctx.beginPath(); ctx.arc(x, sy + r*1.2, r*0.2, 0, Math.PI*2); ctx.fill(); // Nose tip
            }
            else if (type === 'snout_box') {
                // Dog/Bear style
                ctx.fillRect(x - r*0.5, sy, r, r*0.8);
                ctx.beginPath(); ctx.arc(x, sy + r*0.8, r*0.5, 0, Math.PI, false); ctx.fill();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.ellipse(x, sy + r*0.4, r*0.3, r*0.2, 0, 0, Math.PI*2); ctx.fill(); // Nose
            }
            else if (type === 'snout_long') {
                // Moose
                ctx.fillRect(x - r*0.4, sy, r*0.8, r*1.2);
                ctx.beginPath(); ctx.arc(x, sy + r*1.2, r*0.4, 0, Math.PI, false); ctx.fill();
            }
        }
        else if (type === 'beak') {
            ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.moveTo(x-r*0.3, y+r*0.2); ctx.lineTo(x+r*0.3, y+r*0.2); ctx.lineTo(x, y+r); ctx.fill();
        }
    }

    drawEars(type, x, y, r, s, color) {
        let ctx = this.ctx;
        ctx.fillStyle = color;
        if (type === 'round' || type === 'round_large') {
            let size = (type === 'round_large') ? r*0.6 : r*0.4;
            ctx.beginPath(); ctx.arc(x - r*0.8, y - r*0.8, size, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x + r*0.8, y - r*0.8, size, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'pointy') {
            ctx.beginPath(); ctx.moveTo(x - r*0.4, y - r*0.5); ctx.lineTo(x - r*1.2, y - r*1.2); ctx.lineTo(x - r*0.9, y - r*0.2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(x + r*0.4, y - r*0.5); ctx.lineTo(x + r*1.2, y - r*1.2); ctx.lineTo(x + r*0.9, y - r*0.2); ctx.fill();
        }
        else if (type === 'long') {
            ctx.beginPath(); ctx.ellipse(x - r*0.5, y - r*1.5, r*0.3, r*1.2, -0.2, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(x + r*0.5, y - r*1.5, r*0.3, r*1.2, 0.2, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'floppy') {
            ctx.beginPath(); ctx.ellipse(x - r, y, r*0.4, r*0.8, 0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(x + r, y, r*0.4, r*0.8, -0.5, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'pointy_side') {
             // Moose ears
             ctx.beginPath(); ctx.ellipse(x - r, y - r*0.2, r*0.6, r*0.3, -0.5, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.ellipse(x + r, y - r*0.2, r*0.6, r*0.3, 0.5, 0, Math.PI*2); ctx.fill();
        }
    }

    drawFace(type, x, y, s) {
        let ctx = this.ctx;
        if (type === 'beard_brown') {
            ctx.fillStyle = '#8B4513'; ctx.beginPath(); ctx.arc(x, y+2*s, 8*s, 0, Math.PI); ctx.fill();
        } else if (type === 'beard_white') {
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(x, y+2*s, 8*s, 0, Math.PI); ctx.fill();
        } else if (type === 'mask_lucha') {
            ctx.fillStyle = '#008000'; ctx.beginPath(); ctx.arc(x, y, 9*s, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(x-4*s, y-2*s, 2*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x+4*s, y-2*s, 2*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'mask_ninja') {
            ctx.fillStyle = '#333'; ctx.fillRect(x-10*s, y, 20*s, 10*s);
        } else if (type === 'mask_hockey') {
            ctx.fillStyle = '#EEE'; ctx.beginPath(); ctx.arc(x, y, 9*s, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x-3*s, y-2*s, 1.5*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x+3*s, y-2*s, 1.5*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'eyepatch') {
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x-3*s, y-2*s, 3*s, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(x-3*s, y-2*s); ctx.lineTo(x+10*s, y-8*s); ctx.lineWidth = 1*s; ctx.stroke();
        } else if (type === 'nose_red') {
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(x, y+1*s, 3*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'eyes_red_glow') {
            ctx.fillStyle = 'red'; ctx.shadowBlur = 5; ctx.shadowColor = 'red';
            ctx.fillRect(x-6*s, y-3*s, 4*s, 2*s); ctx.fillRect(x+2*s, y-3*s, 4*s, 2*s);
            ctx.shadowBlur = 0;
        } else if (type === 'mask_raccoon' || type === 'mask_bandit') {
            ctx.fillStyle = '#333'; ctx.fillRect(x-10*s, y-4*s, 20*s, 6*s);
        } else if (type === 'mask_pug') {
            ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(x, y+2*s, 6*s, 4*s, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'eyes_panda') {
             ctx.fillStyle = '#000';
             ctx.beginPath(); ctx.ellipse(x-4*s, y-2*s, 3*s, 2*s, -0.2, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.ellipse(x+4*s, y-2*s, 3*s, 2*s, 0.2, 0, Math.PI*2); ctx.fill();
        }
    }

    drawBodyDetail(type, x, y, w, h, s) {
        let ctx = this.ctx;
        if(type === 'flannel') {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(x-w/2 + 4*s, y, 4*s, h); ctx.fillRect(x-w/2 + 12*s, y, 4*s, h);
            ctx.fillRect(x-w/2, y + 10*s, w, 4*s); ctx.fillRect(x-w/2, y + 25*s, w, 4*s);
        } else if (type === 'mariachi_tie') {
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.moveTo(x, y+5*s); ctx.lineTo(x-3*s, y+15*s); ctx.lineTo(x+3*s, y+15*s); ctx.fill();
        } else if (type === 'tuxedo_belly' || type === 'penguin_belly') {
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.ellipse(x, y + h/2, w*0.3, h*0.4, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'belly_yellow_grad') {
            let g = ctx.createLinearGradient(0, y, 0, y+h); g.addColorStop(0, '#FFD700'); g.addColorStop(1, '#FFF');
            ctx.fillStyle = g; ctx.beginPath(); ctx.ellipse(x, y + h/2, w*0.3, h*0.4, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'badge_nasa') {
            ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.arc(x-3*s, y+10*s, 3*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'striped_shirt') {
             ctx.fillStyle = '#000'; for(let i=0; i<4; i++) ctx.fillRect(x-w/2, y + (i*10*s), w, 3*s);
        } else if (type === 'spots') {
             ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x-2*s, y+10*s, 2*s, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.arc(x+4*s, y+25*s, 2*s, 0, Math.PI*2); ctx.fill();
        } else if (type === 'tattered') {
             ctx.fillStyle = 'rgba(0,0,0,0.4)';
             ctx.beginPath(); ctx.moveTo(x-5*s, y+10*s); ctx.lineTo(x, y+15*s); ctx.lineTo(x+5*s, y+10*s); ctx.fill();
             ctx.beginPath(); ctx.moveTo(x+2*s, y+25*s); ctx.lineTo(x+8*s, y+30*s); ctx.lineTo(x+4*s, y+35*s); ctx.fill();
        } else if (type === 'messy_poutine') {
             ctx.fillStyle = '#8B4513'; // Gravy
             ctx.beginPath(); ctx.arc(x-3*s, y+10*s, 4*s, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.arc(x+4*s, y+25*s, 5*s, 0, Math.PI*2); ctx.fill();
             ctx.fillStyle = '#FFFFE0'; // Curds
             ctx.beginPath(); ctx.arc(x+3*s, y+8*s, 3*s, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.arc(x-4*s, y+22*s, 3*s, 0, Math.PI*2); ctx.fill();
        }
    }

    drawTail(type, x, y, s) {
        let ctx = this.ctx;
        if(type === 'tail_devil') {
            ctx.strokeStyle = '#DC143C'; ctx.lineWidth = 4*s;
            ctx.beginPath(); ctx.moveTo(x, y); ctx.quadraticCurveTo(x-15*s, y+10*s, x-20*s, y-5*s); ctx.stroke();
            ctx.fillStyle = '#DC143C'; ctx.beginPath(); ctx.moveTo(x-20*s, y-5*s); ctx.lineTo(x-25*s, y-10*s); ctx.lineTo(x-15*s, y-10*s); ctx.fill();
        } else if (type === 'beaver') {
            ctx.fillStyle = '#5D4037';
            ctx.beginPath(); ctx.ellipse(x-15*s, y+5*s, 15*s, 6*s, -0.2, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#3E2723'; ctx.lineWidth = 1*s;
            ctx.beginPath(); ctx.moveTo(x-25*s, y+5*s); ctx.lineTo(x-5*s, y+5*s); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x-20*s, y+2*s); ctx.lineTo(x-10*s, y+8*s); ctx.stroke();
        }
    }

    drawBack(type, x, y, s) {
        let ctx = this.ctx;
        if (type.includes('cape')) {
            ctx.fillStyle = (type.includes('red')) ? 'red' : (type.includes('royal') ? '#DAA520' : 'black');
            ctx.beginPath(); ctx.moveTo(x-8*s, y); ctx.lineTo(x+8*s, y); ctx.lineTo(x+12*s, y+40*s); ctx.lineTo(x-12*s, y+40*s); ctx.fill();
        } else if (type === 'wings_angel') {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.beginPath(); ctx.ellipse(x-15*s, y+10*s, 10*s, 20*s, 0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(x+15*s, y+10*s, 10*s, 20*s, -0.5, 0, Math.PI*2); ctx.fill();
        } else if (type === 'sword_ninja') {
            ctx.strokeStyle = '#888'; ctx.lineWidth = 3*s; ctx.beginPath(); ctx.moveTo(x-10*s, y-10*s); ctx.lineTo(x+15*s, y+30*s); ctx.stroke();
        }
    }

    drawPlayer(p) {
        if (!p) return;
        let s = p.scale;
        let ctx = this.ctx;
        let skin = this.game.storage.data.currentSkin;
        let skinObj = SKINS_DB.find(x => x.id === skin);
        let currentAnimal = skinObj ? skinObj.animal : 'rat';

        // Get Skin Configuration
        const vis = this.getSkinVisuals(skin, currentAnimal);
        const sizeMod = vis.sizeMod;

        // Colors
        let furColor = vis.fur;
        let torsoColor = vis.torso;
        let legColor = vis.legs;
        let armColor = vis.arm;
        
        // Geometry
        let bodyW = 20 * s * sizeMod.w;
        let bodyH = 40 * s * sizeMod.h;
        let legLen = 30 * s * sizeMod.h;
        let torsoY = p.y - legLen - bodyH;
        let headY = torsoY - (10 * s * sizeMod.head);
        let headRadius = 12 * s * sizeMod.head;

        // Draw Back Accessories (Cape, Wings, Tail) - Behind body
        if(vis.back) this.drawBack(vis.back, p.x, torsoY + 5*s, s);
        if(vis.tail) this.drawTail(vis.tail, p.x, torsoY + bodyH - 5*s, s);

        // Draw Legs
        this.drawLimb(p.x - 8*s, p.y - legLen, p.x - 10*s, p.y, 7*s*sizeMod.w, legColor);
        this.drawLimb(p.x + 8*s, p.y - legLen, p.x + 10*s, p.y, 7*s*sizeMod.w, legColor);

        // Arms Logic
        let leftArmAngle, rightArmAngle, leftForeArmAngle, rightForeArmAngle;
        let wristAngle = 0;

        if (this.game.state === 'SHOOTING') {
            leftArmAngle = -Math.PI/2 + 0.2;
            rightArmAngle = -Math.PI/2 - 0.2;
            leftForeArmAngle = -Math.PI/2 + 0.4;
            rightForeArmAngle = -Math.PI/2 - 0.4;
            wristAngle = 1.0;
        } else if (this.game.state === 'JUMPING') {
            let lift = Math.max(0, (9 - this.game.player.vz) / 9);
            leftArmAngle = (Math.PI/2 - 0.2) + ((-Math.PI/2 + 0.2) - (Math.PI/2 - 0.2)) * lift;
            rightArmAngle = (Math.PI/2 + 0.2) + ((-Math.PI/2 - 0.2) - (Math.PI/2 + 0.2)) * lift;
            leftForeArmAngle = (Math.PI/2 - 0.1) + ((-Math.PI/2 + 0.4) - (Math.PI/2 - 0.1)) * lift;
            rightForeArmAngle = (Math.PI/2 + 0.1) + ((-Math.PI/2 - 0.4) - (Math.PI/2 + 0.1)) * lift;
        } else {
            leftArmAngle = Math.PI/2 - 0.2;
            rightArmAngle = Math.PI/2 + 0.2;
            leftForeArmAngle = Math.PI/2 - 0.1;
            rightForeArmAngle = Math.PI/2 + 0.1;
        }

        let shoulderY = torsoY + (5*s);
        let leftShoulderX = p.x - 12*s;
        let rightShoulderX = p.x + 12*s;
        let upperArmLen = 20 * s * sizeMod.h * 0.6;
        let foreArmLen = 20 * s * sizeMod.h * 0.6;

        const drawSegmentedArm = (sx, sy, isRight, angle1, angle2) => {
            let elbow = this.getJoint(sx, sy, upperArmLen, angle1);
            this.drawLimb(sx, sy, elbow.x, elbow.y, 6*s*sizeMod.w, armColor);
            let wrist = this.getJoint(elbow.x, elbow.y, foreArmLen, angle2);
            this.drawLimb(elbow.x, elbow.y, wrist.x, wrist.y, 5*s*sizeMod.w, armColor);
            ctx.save();
            ctx.translate(wrist.x, wrist.y);
            ctx.rotate(angle2 + (isRight ? wristAngle : 0));
            ctx.fillStyle = armColor; ctx.beginPath(); ctx.arc(0, 0, 5*s, 0, Math.PI*2); ctx.fill();
            if (isRight && this.game.state !== 'SHOOTING' && this.game.state !== 'GAMEOVER') {
                this.drawBall({x:0, y:5*s, scale:s});
            }
            ctx.restore();
        };

        drawSegmentedArm(leftShoulderX, shoulderY, false, leftArmAngle, leftForeArmAngle);
        drawSegmentedArm(rightShoulderX, shoulderY, true, rightArmAngle, rightForeArmAngle);

        // Body
        if (vis.bodyType === 'egg') {
            // Penguin style - big oval
            ctx.fillStyle = torsoColor;
            ctx.beginPath(); ctx.ellipse(p.x, torsoY + bodyH*0.5, bodyW*0.9, bodyH*0.6, 0, 0, Math.PI*2); ctx.fill();
            // Small legs for egg body
            this.drawLimb(p.x - 8*s, p.y - 10*s, p.x - 10*s, p.y, 7*s*sizeMod.w, legColor);
            this.drawLimb(p.x + 8*s, p.y - 10*s, p.x + 10*s, p.y, 7*s*sizeMod.w, legColor);
        }
        else if (vis.bodyType === 'broad') {
            // Bear/Moose style - Trapezoid
            ctx.fillStyle = torsoColor;
            ctx.beginPath();
            ctx.moveTo(p.x - bodyW*0.7, torsoY); // Top Left
            ctx.lineTo(p.x + bodyW*0.7, torsoY); // Top Right
            ctx.lineTo(p.x + bodyW*0.5, torsoY + bodyH); // Bottom Right
            ctx.lineTo(p.x - bodyW*0.5, torsoY + bodyH); // Bottom Left
            ctx.fill();
            // Standard Legs
            this.drawLimb(p.x - 8*s, p.y - legLen, p.x - 10*s, p.y, 7*s*sizeMod.w, legColor);
            this.drawLimb(p.x + 8*s, p.y - legLen, p.x + 10*s, p.y, 7*s*sizeMod.w, legColor);
        }
        else {
            // Default Rectangle
            this.drawRoundedRect(p.x - bodyW/2, torsoY, bodyW, bodyH, 10*s, torsoColor);
            // Standard Legs
            this.drawLimb(p.x - 8*s, p.y - legLen, p.x - 10*s, p.y, 7*s*sizeMod.w, legColor);
            this.drawLimb(p.x + 8*s, p.y - legLen, p.x + 10*s, p.y, 7*s*sizeMod.w, legColor);
        }

        if(vis.body) this.drawBodyDetail(vis.body, p.x, torsoY, bodyW, bodyH, s);

        // Ears (Behind Head)
        if(vis.earType && vis.hat !== 'helmet_bubble' && vis.hat !== 'clown_wig') {
            this.drawEars(vis.earType, p.x, headY, headRadius, s, furColor);
        }

        // Head
        this.drawHead(vis.headType, p.x, headY, headRadius, s, furColor, vis.snoutColor);

        // Face / Hat
        if(vis.face) this.drawFace(vis.face, p.x, headY, s);
        if(vis.hat) this.drawHat(vis.hat, p.x, headY, s);

        // Jersey Number (If not covered)
        if(vis.hasJersey) {
            ctx.fillStyle = "#FFF";
            ctx.font = `bold ${12 * s}px Arial`;
            ctx.textAlign = "center";
            ctx.fillText("23", p.x, torsoY + bodyH * 0.6);
        }

        // Shot Meter
        if (this.game.state === 'JUMPING') {
            this.drawShotMeter(p, s, sizeMod);
        }
    }

    drawShotMeter(p, s, sizeMod) {
        let ctx = this.ctx;
        let maxVz = 9;
        let curVz = Math.abs(this.game.player.vz);
        let progress = 1.0 - (curVz / maxVz);
        progress = Math.max(0, Math.min(1, progress));

        let groundY = p.y + (this.game.player.z * s);
        let meterY = groundY - (130 * s * sizeMod.h);
        let cx = p.x + (60 * s);
        let radius = 50 * s;

        // Background
        ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 10*s; ctx.lineCap = 'round';
        ctx.arc(cx, meterY, radius, 0, -Math.PI / 2, true); ctx.stroke();

        // Green Window
        let damp = 6.0 + (this.game.storage.data.stats.aim - 1);
        let pen = Math.min(4.0, 1.0 + (this.game.distanceLevel * 0.04));
        let thresh = (0.25 * damp) / (this.game.storage.data.difficulty * pen);
        let greenStart = 1.0 - (thresh / maxVz);

        ctx.beginPath(); ctx.strokeStyle = 'rgba(0,255,0,0.4)'; ctx.lineWidth = 10*s;
        ctx.arc(cx, meterY, radius, -Math.PI/2 * Math.max(0, greenStart), -Math.PI/2, true); ctx.stroke();

        // Fill
        ctx.beginPath();
        if (progress > greenStart) ctx.strokeStyle = '#00FF00';
        else if (progress > 0.6) ctx.strokeStyle = '#FFFF00';
        else ctx.strokeStyle = '#FF4500';

        ctx.lineWidth = 8*s;
        ctx.arc(cx, meterY, radius, 0, -Math.PI/2 * progress, true);
        ctx.stroke();
    }

    drawUI() {
        // Feedback Text
        if (this.game.feedbackTimer > 0) {
            this.ctx.save();
            this.ctx.font = "900 60px 'Arial Black'";
            let txt = this.game.feedback;
            this.ctx.fillStyle = (txt.includes("Miss") || txt.includes("Ouch") || txt.includes("GAME")) ? "#FF0000" : "#00FF00";
            if (txt.includes("FIRE")) this.ctx.fillStyle = "orange";
            this.ctx.strokeStyle = "white"; this.ctx.lineWidth = 2; this.ctx.textAlign = "center";
            this.ctx.fillText(txt, this.width/2, 200);
            this.ctx.strokeText(txt, this.width/2, 200);
            this.ctx.restore();
            if(this.game.state !== 'GAMEOVER') this.game.feedbackTimer--;
        }

        // Restore shake translation
        if(this.game.shakeIntensity > 0) this.ctx.restore();

        // Flight Tracker / HUD Base
        let h = 120;
        let y = this.height - h;
        this.ctx.fillStyle = '#111'; this.ctx.fillRect(0, y, this.width, h);
        this.ctx.fillStyle = '#222'; this.ctx.fillRect(0, y + h/2, this.width, h/2);

        // Distance / Text
        let dist = 10 + (this.game.distanceLevel * 5);
        let scaleObj = SCALE_OBJECTS.find(o => dist < o.limit) || SCALE_OBJECTS[SCALE_OBJECTS.length-1];

        this.ctx.font = "bold 20px 'Segoe UI'"; this.ctx.fillStyle = "#FFD700"; this.ctx.textAlign = "center";
        
        if (this.game.mode === 'CLASSIC') {
            this.ctx.fillText(`Distance: ${dist} ft`, this.width/2, y + 30);
            this.ctx.font = "italic 16px 'Segoe UI'"; this.ctx.fillStyle = "#aaa";
            this.ctx.fillText(`(Equivalent: ${scaleObj.name})`, this.width/2, y + 55);
        } else {
             this.ctx.fillText(`3-POINT CONTEST`, this.width/2, y + 30);
        }

        // On Fire
        if(this.game.isOnFire) {
             this.ctx.font = "900 24px Arial"; this.ctx.fillStyle="orange";
             this.ctx.fillText("üî• ON FIRE! (x2) üî•", this.width - 150, y + 40);
        }

        // Progress Line
        let margin = 100;
        let lineY = y + 80;
        let lineLen = this.width - (margin * 2);
        this.ctx.strokeStyle = '#555'; this.ctx.lineWidth = 4;
        this.ctx.beginPath(); this.ctx.moveTo(margin, lineY); this.ctx.lineTo(margin + lineLen, lineY); this.ctx.stroke();

        this.ctx.font = "30px Arial"; this.ctx.textAlign="center";
        this.ctx.fillText("‚õπÔ∏è", margin, lineY + 10);
        this.ctx.fillText("üèÄ", margin + lineLen, lineY + 10);

        if (this.game.mode === 'CLASSIC') {
            this.ctx.globalAlpha = 0.3; this.ctx.font = "60px Arial";
            this.ctx.fillText(scaleObj.icon, this.width/2, lineY);
            this.ctx.globalAlpha = 1.0;
        }

        // Ball on tracker
        if((this.game.state === 'SHOOTING' || this.game.state === 'RESETTING') && this.game.ball.active) {
            const HOOP_POS = this.game.HOOP_POS;
            let totalDist = Math.sqrt(Math.pow(HOOP_POS.x - this.game.player.x, 2) + Math.pow(HOOP_POS.y - this.game.player.y, 2));
            let currentDist = Math.sqrt(Math.pow(this.game.ball.x - this.game.player.x, 2) + Math.pow(this.game.ball.y - this.game.player.y, 2));
            let progress = currentDist / totalDist;
            let ballX = margin + (progress * lineLen);
            this.ctx.fillStyle = '#ff6600';
            this.ctx.beginPath(); this.ctx.arc(ballX, lineY, 5, 0, Math.PI*2); this.ctx.fill();
        }
    }

    drawLimb(x1, y1, x2, y2, width, color) {
        let ctx = this.ctx;
        let angle = Math.atan2(y2 - y1, x2 - x1);
        let dx = Math.sin(angle) * (width / 2);
        let dy = Math.cos(angle) * (width / 2);
        ctx.beginPath();
        ctx.moveTo(x1 - dx, y1 + dy);
        ctx.lineTo(x2 - dx, y2 + dy);
        ctx.arc(x2, y2, width/2, angle + Math.PI/2, angle - Math.PI/2);
        ctx.lineTo(x1 + dx, y1 - dy);
        ctx.arc(x1, y1, width/2, angle - Math.PI/2, angle + Math.PI/2);
        ctx.closePath();

        let grad = ctx.createLinearGradient(x1, y1, x2, y2);
        grad.addColorStop(0, color); grad.addColorStop(1, '#000000');
        ctx.fillStyle = color; ctx.fill();
        ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
    }

    drawRoundedRect(x, y, w, h, r, color) {
        let ctx = this.ctx;
        ctx.beginPath(); ctx.moveTo(x+r, y); ctx.arcTo(x+w, y, x+w, y+h, r); ctx.arcTo(x+w, y+h, x, y+h, r); ctx.arcTo(x, y+h, x, y, r); ctx.arcTo(x, y, x+w, y, r); ctx.closePath();
        let grad = ctx.createRadialGradient(x + w/2, y + h/2, 5, x + w/2, y + h/2, w); grad.addColorStop(0, color); grad.addColorStop(1, 'rgba(0,0,0,0.3)');
        ctx.fillStyle = color; ctx.fill(); ctx.fillStyle = grad; ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
    }

    getJoint(x, y, length, angle) {
        return { x: x + Math.cos(angle) * length, y: y + Math.sin(angle) * length };
    }
}

// --- 5. UI MANAGER ---
class UIManager {
    constructor(game) {
        this.game = game;
        this.els = {
            score: document.getElementById('scoreVal'),
            dist: document.getElementById('distVal'),
            highScore: document.getElementById('highScoreVal'),
            missVal: document.getElementById('missVal'),
            courtName: document.getElementById('courtNameDisplay'),
            contestUI: document.getElementById('contest-ui'),
            classicStats: document.getElementById('classic-stats'),
            strikes: document.getElementById('strikes'),
            shop: document.getElementById('shopUI'),
            ach: document.getElementById('achUI'),
            stats: document.getElementById('statsUI'),
            notif: document.getElementById('notification'),
            notifText: document.getElementById('notifText'),
            contestTime: document.getElementById('contestTime'),
            contestScore: document.getElementById('contestScore'),
            contestRack: document.getElementById('contestRack')
        };
    }

    update() {
        const data = this.game.storage.data;
        this.els.score.innerText = data.tacos;
        this.els.highScore.innerText = data.highScore + " ft";

        if(this.game.mode === 'CLASSIC') {
            this.els.classicStats.style.display = 'block';
            this.els.strikes.style.display = 'block';
            this.els.contestUI.style.display = 'none';

            let dist = 10 + (this.game.distanceLevel * 5);
            this.els.dist.innerText = dist + " ft";

            let maxMisses = 2 + (data.stats.extraLives || 0);
            this.els.missVal.innerText = `${this.game.consecutiveMisses}/${maxMisses}`;

            let c = this.game.getCourtDetails(dist);
            this.els.courtName.innerText = c.name;
        } else {
            this.els.classicStats.style.display = 'none';
            this.els.strikes.style.display = 'none';
            this.els.contestUI.style.display = 'block';
            this.els.courtName.innerText = "3-POINT CONTEST";
            this.els.contestTime.innerText = Math.ceil(this.game.contestData.timer);
            this.els.contestScore.innerText = this.game.contestData.score;
            this.els.contestRack.innerText = this.game.contestData.rack;
        }
    }

    showNotification(title, reward) {
        this.els.notifText.innerText = `${title} (+${reward} Tacos)`;
        this.els.notif.style.display = 'block';
        setTimeout(() => { this.els.notif.style.display = 'none'; }, 3000);
    }

    // Menu Actions
    openShop() {
        if(this.game.state !== 'IDLE' && this.game.state !== 'GAMEOVER') return;
        this.game.state = 'SHOP';
        this.els.shop.style.display = 'block';
        this.els.ach.style.display = 'none';
        this.els.stats.style.display = 'none';
        document.getElementById('diffSlider').value = this.game.storage.data.difficulty;
        this.updateDifficulty(); // Update label
        this.updateShopUI();
    }
    closeShop() {
        this.game.state = 'IDLE';
        this.els.shop.style.display = 'none';
        if(this.game.feedback === "FINISHED!" || this.game.feedback === "GAME OVER!") this.game.resetGame();
    }
    openAchievements() {
        if(this.game.state !== 'IDLE' && this.game.state !== 'GAMEOVER') return;
        this.game.state = 'ACHIEVEMENTS';
        this.els.ach.style.display = 'block';
        this.els.shop.style.display = 'none';
        this.els.stats.style.display = 'none';
        this.renderAchievements();
    }
    closeAchievements() {
        this.game.state = 'IDLE';
        this.els.ach.style.display = 'none';
        if(this.game.feedback === "FINISHED!" || this.game.feedback === "GAME OVER!") this.game.resetGame();
    }
    openStats() {
        if(this.game.state !== 'IDLE' && this.game.state !== 'GAMEOVER') return;
        this.game.state = 'STATS';
        this.els.shop.style.display = 'none';
        this.els.ach.style.display = 'none';
        this.els.stats.style.display = 'block';

        const ls = this.game.storage.data.lifetimeStats;
        document.getElementById('statShots').innerText = ls.shots;
        document.getElementById('statMakes').innerText = ls.makes;
        document.getElementById('statMisses').innerText = ls.misses;
        document.getElementById('statContests').innerText = ls.contests;
        document.getElementById('statBestDist').innerText = this.game.storage.data.highScore + " ft";
        let acc = 0;
        if(ls.shots > 0) acc = ((ls.makes / ls.shots) * 100).toFixed(1);
        document.getElementById('statAccuracy').innerText = acc + "%";
    }
    closeStats() {
        this.game.state = 'IDLE';
        this.els.stats.style.display = 'none';
        this.game.resetStage = 0;
        const btn = document.getElementById('btnReset');
        if(btn) { btn.innerText = "RESET PROGRESS"; btn.style.background = "#8B0000"; }
        if(this.game.feedback === "FINISHED!" || this.game.feedback === "GAME OVER!") this.game.resetGame();
    }
    
    toggleMode() {
        if(this.game.state !== 'IDLE' && this.game.state !== 'GAMEOVER') return;
        if(this.game.mode === 'CLASSIC') {
            this.game.mode = 'CONTEST';
            document.getElementById('modeBtnText').innerText = "CONTEST";
        } else {
            this.game.mode = 'CLASSIC';
            document.getElementById('modeBtnText').innerText = "CLASSIC";
        }
        this.game.resetGame();
    }

    attemptReset() {
        const btn = document.getElementById('btnReset');
        if (this.game.resetStage === 0) {
            this.game.resetStage = 1;
            btn.innerText = "SURE? (CLICK AGAIN)";
            btn.style.background = "#FF0000";
            return;
        }
        this.game.storage.reset();
        this.update();
        this.closeStats();
        this.game.resetGame();
        this.game.feedback = "RESET!";
        this.game.feedbackTimer = 60;
    }

    updateDifficulty() {
        const val = parseFloat(document.getElementById('diffSlider').value);
        this.game.storage.data.difficulty = val;
        const label = document.getElementById('diffLabel');
        label.innerText = `x${val.toFixed(1)} Tacos`;
        if(val === 1) { label.innerText = "NORMAL (x1.0)"; label.style.color = "#00FF00"; }
        else if (val < 2.5) { label.innerText = `HARD (x${val.toFixed(1)})`; label.style.color = "#FFFF00"; }
        else { label.innerText = `LEGEND (x${val.toFixed(1)})`; label.style.color = "#FF0000"; }
        this.game.storage.save();
    }

    renderAchievements() {
        const list = document.getElementById('achList');
        list.innerHTML = '';
        ACHIEVEMENTS_DB.forEach(ach => {
            const unlocked = this.game.storage.data.unlockedAchievements.includes(ach.id);
            const div = document.createElement('div');
            div.className = `ach-row ${unlocked ? 'unlocked' : ''}`;
            div.innerHTML = `<div style="display:flex; align-items:center;"><div class="ach-icon">${unlocked ? 'üèÜ' : 'üîí'}</div><div class="ach-info"><h4>${ach.name}</h4><span>${ach.desc}</span></div></div>${unlocked ? '<div style="color:#00FF00">‚úì</div>' : ''}`;
            list.appendChild(div);
        });
    }

    // Shop Logic
    getUpgradeCost(statName) {
        const lvl = this.game.storage.data.stats[statName];
        if (statName === 'income') return Math.floor(25 * Math.pow(lvl, 2));
        if (statName === 'aim') return Math.floor(50 * Math.pow(lvl, 2));
        if (statName === 'luck') return Math.floor(75 * Math.pow(lvl, 2));
        if (statName === 'moonwalk') return Math.floor(150 * Math.pow(lvl, 2));
        if (statName === 'extraLives') return Math.floor(1000 * Math.pow(2, lvl));
        return 99999;
    }

    buyUpgrade(stat) {
        const cost = this.getUpgradeCost(stat);
        const data = this.game.storage.data;
        if (data.tacos >= cost) {
            data.tacos -= cost;
            data.stats[stat]++;
            this.game.storage.save();
            this.updateShopUI();
            this.update();
            this.game.achievements.check('stat_update');
        }
    }

    updateShopUI() {
        const data = this.game.storage.data;
        document.getElementById('shopTacos').innerText = data.tacos;
        
        ['income', 'aim', 'luck', 'moonwalk', 'extraLives'].forEach(stat => {
             const cost = this.getUpgradeCost(stat);
             const lvl = data.stats[stat] || 0;
             const btn = document.getElementById(`btnBuy${stat.charAt(0).toUpperCase() + stat.slice(1)}`);
             document.getElementById(`lvl${stat.charAt(0).toUpperCase() + stat.slice(1)}`).innerText = lvl;
             btn.innerText = `Buy (${cost})`;
             btn.disabled = data.tacos < cost;
        });

        // Skins
        const currentAnimal = ANIMALS[this.game.viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        const skin = animalSkins[this.game.viewingSkinIndex];
        
        document.getElementById('animalName').innerText = currentAnimal.toUpperCase();
        document.getElementById('skinName').innerText = skin.name;
        
        const btn = document.getElementById('btnEquipSkin');
        const status = document.getElementById('skinStatus');
        const isUnlocked = data.unlockedSkins.includes(skin.id);
        const isEquipped = data.currentSkin === skin.id;
        
        if (isEquipped) {
            status.innerText = "Equipped";
            btn.style.display = 'none';
        } else if (isUnlocked) {
            status.innerText = "Owned";
            btn.style.display = 'inline-block';
            btn.innerText = "Equip";
            btn.disabled = false;
        } else {
            status.innerText = `Cost: ${skin.cost} Tacos`;
            btn.style.display = 'inline-block';
            btn.innerText = "Buy";
            btn.disabled = data.tacos < skin.cost;
        }
    }

    changeAnimal(dir) {
        this.game.viewingAnimalIndex += dir;
        if(this.game.viewingAnimalIndex < 0) this.game.viewingAnimalIndex = ANIMALS.length - 1;
        if(this.game.viewingAnimalIndex >= ANIMALS.length) this.game.viewingAnimalIndex = 0;
        this.game.viewingSkinIndex = 0;
        this.updateShopUI();
    }

    changeSkin(dir) {
        const currentAnimal = ANIMALS[this.game.viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        this.game.viewingSkinIndex += dir;
        if(this.game.viewingSkinIndex < 0) this.game.viewingSkinIndex = animalSkins.length - 1;
        if(this.game.viewingSkinIndex >= animalSkins.length) this.game.viewingSkinIndex = 0;
        this.updateShopUI();
    }

    buyOrEquipSkin() {
        const data = this.game.storage.data;
        const currentAnimal = ANIMALS[this.game.viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        const skin = animalSkins[this.game.viewingSkinIndex];
        const isUnlocked = data.unlockedSkins.includes(skin.id);
        
        if (isUnlocked) {
            data.currentSkin = skin.id;
            this.game.achievements.check('skin_equip');
        } else if (data.tacos >= skin.cost) {
            data.tacos -= skin.cost;
            data.unlockedSkins.push(skin.id);
            data.currentSkin = skin.id;
            this.game.achievements.check('skin_update');
            this.game.achievements.check('skin_equip');
        }
        this.game.storage.save();
        this.updateShopUI();
        this.update();
    }
}

// --- 6. GAME CLASS (MAIN) ---
class Game {
    constructor() {
        // Core Systems
        this.storage = new Storage();
        this.ui = new UIManager(this);
        this.achievements = new AchievementSystem(this);
        this.renderer = new Renderer(this);

        // Game State
        this.state = 'IDLE'; // IDLE, JUMPING, SHOOTING, RESETTING, GAMEOVER, SHOP, STATS
        this.mode = 'CLASSIC'; // CLASSIC, CONTEST
        this.distanceLevel = 1;
        this.HOOP_POS = { x: 600, y: 150, z: 130 };
        this.GRAVITY = 0.5;

        // Entities
        this.player = { x: 300, y: 300, z: 0, vz: 0 };
        this.ball = { x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0, active: false };
        this.obstacles = [];

        // Gameplay Stats
        this.feedback = "";
        this.feedbackTimer = 0;
        this.consecutiveMisses = 0;
        this.currentStreak = 0;
        this.isOnFire = false;
        this.isGoldenBall = false;
        this.shakeIntensity = 0;

        // Contest Data
        this.contestData = { timer: 60, score: 0, rack: 1, ballsInRack: 0, isActive: false };

        // View
        this.viewingAnimalIndex = 0;
        this.viewingSkinIndex = 0;
        this.cameraZoom = 800;
        this.cameraHeight = 300;
        this.resetStage = 0;

        // Init
        this.bindInput();
        this.ui.update();
        // Initial Achievement Check (Retroactive for saved data)
        this.achievements.checkAll();

        this.loopId = requestAnimationFrame((t) => this.loop(t));

        // Global Access for UI
        window.tacoGame = this;
    }

    bindInput() {
        window.addEventListener('keydown', (e) => {
            if(this.state === 'SHOP') { if(e.code === 'Escape') this.ui.closeShop(); return; }
            if(this.state === 'ACHIEVEMENTS') { if(e.code === 'Escape') this.ui.closeAchievements(); return; }
            if(this.state === 'STATS') { if(e.code === 'Escape') this.ui.closeStats(); return; }

            if(e.code === 'KeyP') this.ui.openShop();
            if(e.code === 'KeyO') this.ui.openAchievements();
            if(e.code === 'KeyS') this.ui.openStats();

            if (e.code === 'Space' && !this.spacePressed) {
                this.spacePressed = true;
                if (this.state === 'GAMEOVER') this.ui.openShop();
                else if (this.state === 'IDLE') this.startJump();
            }
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                this.spacePressed = false;
                if (this.state === 'JUMPING') this.releaseShot();
            }
        });

        window.addEventListener('mousedown', (e) => {
            if(e.target.closest('.modal') || e.target.closest('.ui-btn')) return;
            if (this.state === 'GAMEOVER') this.ui.openShop();
            else if (this.state === 'IDLE') this.startJump();
        });

        window.addEventListener('mouseup', () => {
            if (this.state === 'JUMPING') this.releaseShot();
        });
    }

    // Logic
    startJump() {
        if (this.state !== 'IDLE') return;
        this.state = 'JUMPING';
        this.player.vz = 9;
        this.feedback = "";
    }

    releaseShot() {
        if (this.state !== 'JUMPING') return;
        let timingError = this.player.vz;
        this.shoot(timingError);
    }

    shoot(timingError) {
        this.state = 'SHOOTING';
        this.storage.data.lifetimeStats.shots++;
        this.achievements.check('shot_result', { made: false });

        let aimBonus = (this.storage.data.stats.aim - 1);
        let baseDampener = 6.0;
        if (this.mode === 'CONTEST') { aimBonus *= 0.2; baseDampener = 4.5; }

        let dampener = baseDampener + aimBonus;
        if (dampener > 36.0) dampener = 36.0;

        // Wind (simulated)
        let windEffect = 0;
        if ((10 + this.distanceLevel*5) >= 50) {
             windEffect = (Math.random() - 0.5) * 2;
        }

        let distPenalty = 1.0 + Math.pow(this.distanceLevel, 1.25) * 0.06;
        let accuracy = (timingError / dampener) * this.storage.data.difficulty * distPenalty;

        // Physics Calc
        let dx = this.HOOP_POS.x - this.player.x;
        let dy = this.HOOP_POS.y - this.player.y;

        this.ball.x = this.player.x;
        this.ball.y = this.player.y;
        this.ball.z = this.player.z + 120;
        this.ball.active = true;

        let flightTime = Math.min(120, 40 + (this.distanceLevel * 0.8));
        this.ball.vx = (dx / flightTime);
        this.ball.vy = (dy / flightTime);
        this.ball.vz = (this.HOOP_POS.z - this.ball.z + 0.5 * this.GRAVITY * flightTime * (flightTime - 1)) / flightTime;

        this.isGoldenBall = (Math.random() < 0.01);

        // Determine outcome
        let isMiss = Math.abs(accuracy) > 0.25;
        // 50/50 chance to make it if slightly off (rim bounce)
        if (isMiss && Math.abs(accuracy) < 0.32) {
            if(Math.random() > 0.5) {
                isMiss = false;
                this.feedback = "ON THE LINE!";
                this.feedbackTimer = 30;
            }
        }
        
        if (isMiss) {
            let luckChance = (this.storage.data.stats.luck - 1) * 0.05;
            if (Math.random() < luckChance) {
                this.feedback = "LUCKY!";
                this.feedbackTimer = 30;
                this.achievements.check('lucky_bounce');
            } else {
                let len = Math.sqrt(dx*dx + dy*dy);
                let perpX = -dy / len;
                let perpY = dx / len;
                let scatter = (Math.random() > 0.5 ? 1 : -1) * Math.abs(accuracy) * 15;
                this.ball.vx += perpX * scatter;
                this.ball.vy += perpY * scatter;
                this.ball.vz -= Math.abs(accuracy) * 5;
                this.feedback = Math.abs(accuracy) > 0.5 ? "AIRBALL" : "BRICK";
                this.feedbackTimer = 30;
                this.isOnFire = false;
            }
        }
    }

    handleScore() {
        this.ball.active = false;
        this.storage.data.lifetimeStats.makes++;
        this.currentStreak++;
        this.shakeIntensity = 20;

        this.achievements.check('shot_result', { made: true });
        this.achievements.check('score'); // Check distance related
        
        if(this.currentStreak >= 3) {
            this.isOnFire = true;
            this.feedback = "ON FIRE !!!";
        }
        
        if(this.mode === 'CONTEST') {
            let isMoneyBall = (this.contestData.ballsInRack === 4);
            let points = isMoneyBall ? 2 : 1;
            if(this.isOnFire) points *= 2;
            if(this.isGoldenBall) points += 100;
            
            this.contestData.score += points;
            this.feedbackTimer = 30;
            this.ui.update();
            this.state = 'RESETTING';
            setTimeout(() => this.nextLevel(), 500);
        } else {
            this.consecutiveMisses = 0;
            let msg = "Swish";
            if(this.currentStreak >= 3) msg = "Awesome!";
            if(this.isGoldenBall) msg = "JACKPOT!";
            this.feedback = msg;
            this.feedbackTimer = 60;
            this.state = 'RESETTING';
            setTimeout(() => this.nextLevel(), 1000);
        }
    }

    handleMiss() {
        if(this.state === 'GAMEOVER') return;
        this.storage.data.lifetimeStats.misses++;
        this.currentStreak = 0;
        this.isOnFire = false;
        
        if(this.mode === 'CONTEST') {
            this.feedback = "Missed";
            this.feedbackTimer = 30;
            this.state = 'RESETTING';
            setTimeout(() => this.nextLevel(), 500);
        } else {
            this.consecutiveMisses++;
            this.ui.update();
            let maxMisses = 2 + (this.storage.data.stats.extraLives || 0);

            if (this.consecutiveMisses >= maxMisses) {
                this.feedback = "GAME OVER!";
                this.feedbackTimer = 60;
                this.state = 'GAMEOVER';
                setTimeout(() => this.ui.openShop(), 1500);
            } else {
                this.feedback = "Ouch! Try again!";
                this.feedbackTimer = 60;
                this.state = 'RESETTING';
                setTimeout(() => {
                    this.player.z = 0;
                    this.player.vz = 0;
                    this.state = 'IDLE';
                }, 1500);
            }
        }
    }

    nextLevel() {
        if(this.mode === 'CONTEST') {
            this.contestData.ballsInRack++;
            if(this.contestData.ballsInRack >= 5) {
                this.contestData.rack++;
                this.contestData.ballsInRack = 0;
                if(this.contestData.rack > 5) {
                    this.endContest();
                    return;
                } else {
                    this.setPlayerPositionForRack(this.contestData.rack);
                }
            }
            this.ui.update();
            this.state = 'IDLE';
        } else {
            let baseReward = 1 * this.distanceLevel * this.storage.data.difficulty;
            let multiplier = 1 + (this.storage.data.stats.income - 1) * 0.5;
            let reward = Math.ceil(baseReward * multiplier);
            if (this.currentStreak > 1) reward += this.currentStreak * 2;
            if (this.isOnFire) reward *= 2;

            this.storage.data.tacos += reward;
            this.achievements.check('balance_update');

            let jump = this.storage.data.stats.moonwalk || 1;
            this.distanceLevel += jump;

            let currentDistanceVal = 10 + (this.distanceLevel * 5);
            if (currentDistanceVal > this.storage.data.highScore) {
                this.storage.data.highScore = currentDistanceVal;
            }
            this.storage.save();
            this.achievements.check('score'); // Distance check

            this.player.x -= 15 * jump;
            this.player.y += 15 * jump;
            this.player.z = 0;
            this.player.vz = 0;
            this.state = 'IDLE';
            this.ui.update();
        }
    }

    resetGame() {
        if(this.mode === 'CONTEST') {
            this.startContest();
        } else {
            this.distanceLevel = 1;
            this.consecutiveMisses = 0;
            this.player = { x: 300, y: 300, z: 0, vz: 0 };
            this.state = 'IDLE';
            this.ui.update();
        }
    }

    startContest() {
        this.mode = 'CONTEST';
        this.contestData = { timer: 60, score: 0, rack: 1, ballsInRack: 0, isActive: true };
        this.distanceLevel = 3;
        this.setPlayerPositionForRack(1);
        this.storage.data.lifetimeStats.contests++;
        this.ui.update();
        this.state = 'IDLE';
    }

    endContest() {
        this.state = 'GAMEOVER';
        this.feedback = "FINISHED!";
        this.feedbackTimer = 120;
        let reward = this.contestData.score * 10;
        this.storage.data.tacos += reward;
        this.achievements.check('contest_end');
        this.achievements.check('balance_update');
        this.storage.save();
        setTimeout(() => this.ui.openShop(), 2000);
    }

    setPlayerPositionForRack(rackNum) {
        if(rackNum === 1) { this.player.x = 200; this.player.y = 500; }
        else if(rackNum === 2) { this.player.x = 250; this.player.y = 400; }
        else if(rackNum === 3) { this.player.x = 300; this.player.y = 300; }
        else if(rackNum === 4) { this.player.x = 350; this.player.y = 200; }
        else if(rackNum === 5) { this.player.x = 400; this.player.y = 100; }
        this.player.z = 0; this.player.vz = 0;
    }

    getCourtDetails(dist) {
        return COURT_ZONES.find(z => dist < z.limit) || COURT_ZONES[COURT_ZONES.length-1];
    }

    // Main Loop
    loop(timestamp) {
        this.loopId = requestAnimationFrame((t) => this.loop(t));
        if (!this.lastTime) this.lastTime = timestamp;
        let dt = (timestamp - this.lastTime) / 16.666;
        if(dt > 4) dt = 4;
        this.lastTime = timestamp;

        this.update(dt);
        this.renderer.draw();
    }

    update(dt) {
        if (this.state === 'SHOP' || this.state === 'ACHIEVEMENTS' || this.state === 'STATS') return;

        // Obstacles
        if(Math.random() < 0.005) { 
             this.obstacles.push({ active: true, x: -100, y: 100 + Math.random()*200, z: 500, speed: 5 });
        }
        this.obstacles.forEach(o => {
            o.x += o.speed;
            if(o.x > 800 + 200) o.active = false; // hardcoded width for now
        });

        // Contest Timer
        if(this.mode === 'CONTEST' && this.state !== 'GAMEOVER') {
            if(this.contestData.timer > 0) {
                this.contestData.timer -= (1/60) * dt;
                if(this.contestData.timer <= 0) {
                    this.contestData.timer = 0;
                    this.endContest();
                }
                // visual update logic inside loop could be optimized, but ok for now
                if(Math.floor(this.contestData.timer) !== parseInt(this.ui.els.contestTime.innerText)) {
                    this.ui.update();
                }
            }
        }

        // Jump Physics
        if (this.state === 'JUMPING') {
            this.player.z += this.player.vz * dt;
            this.player.vz -= this.GRAVITY * dt;
            if (this.player.z <= 0) {
                this.player.z = 0;
                this.player.vz = 0;
                this.state = 'GAMEOVER';
                this.feedback = "Travel!";
                this.feedbackTimer = 60;
                setTimeout(() => this.ui.openShop(), 1500);
            }
        }

        // Shooting Physics
        if (this.state === 'SHOOTING') {
            // Player gravity if still in air
            if (this.player.z > 0) {
                this.player.z += this.player.vz * dt;
                this.player.vz -= this.GRAVITY * dt;
                if (this.player.z < 0) this.player.z = 0;
            }

            if (this.ball.active) {
                let prevZ = this.ball.z;
                this.ball.x += this.ball.vx * dt;
                this.ball.y += this.ball.vy * dt;
                this.ball.z += this.ball.vz * dt;
                this.ball.vz -= this.GRAVITY * dt;

                // Collision detection
                if (prevZ >= this.HOOP_POS.z && this.ball.z <= this.HOOP_POS.z) {
                    let distToHoopCenter = Math.sqrt(Math.pow(this.ball.x - this.HOOP_POS.x, 2) + Math.pow(this.ball.y - this.HOOP_POS.y, 2));
                    if (distToHoopCenter < 40) {
                        this.handleScore();
                        return;
                    }
                }
                
                let distToHoop = Math.sqrt(Math.pow(this.HOOP_POS.x - this.player.x, 2) + Math.pow(this.HOOP_POS.y - this.player.y, 2));
                let currentDist = Math.sqrt(Math.pow(this.ball.x - this.player.x, 2) + Math.pow(this.ball.y - this.player.y, 2));

                if (this.ball.z < -50 || currentDist > distToHoop + 5000) {
                    this.ball.active = false;
                    this.handleMiss();
                    return;
                }
                if (this.ball.z <= 0) {
                    this.ball.z = 0;
                    this.ball.active = false;
                    this.handleMiss();
                    return;
                }
            }
        }
    }
}

// Start Game
window.onload = () => {
    new Game();
};

</script>
</body>
</html>