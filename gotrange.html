<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taco Basket Ball - Qu√©bec √âdition</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 600px;
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas {
            border: 8px solid #5D4037;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            border-radius: 4px;
            width: 100%;
            height: 100%;
            display: block;
            box-sizing: border-box;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
            text-align: left;
        }

        #controls {
            position: absolute;
            bottom: 125px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: auto;
            z-index: 20;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .ui-btn {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            color: #000;
            border: 2px solid #fff;
            padding: 8px 18px;
            cursor: pointer;
            font-weight: 800;
            display: inline-block;
            border-radius: 6px;
            box-shadow: 0 4px 0 #B8860B;
            transition: transform 0.1s, background 0.1s;
            font-size: 16px;
            text-transform: uppercase;
            text-shadow: none;
        }
        .ui-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #B8860B; }
        .ui-btn:hover { background: #fff; }

        h1 {
            margin: 0;
            font-size: 42px;
            color: #FFD700;
            text-shadow: 3px 3px 0 #8B0000;
            font-weight: 900;
            font-style: italic;
        }
        p { margin: 5px 0; color: #fff; font-weight: bold; font-size: 1.2em; }
        .stat-label { color: #00FF00; }
        .highscore-label { color: #FFD700; }

        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 550px;
            max-height: 85%;
            overflow-y: auto;
            background: rgba(30, 30, 30, 0.98);
            border: 4px solid #DAA520;
            padding: 25px;
            color: white;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            border-radius: 15px;
        }

        .modal::-webkit-scrollbar { width: 10px; }
        .modal::-webkit-scrollbar-track { background: #333; border-radius: 5px; }
        .modal::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 5px; }

        .modal-header { color: #FFD700; margin-bottom: 20px; font-size: 2.2em; text-shadow: 2px 2px #d32f2f; font-weight: 800; border-bottom: 2px solid #555; padding-bottom: 10px; }

        .upgrade-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(255,255,255,0.05), rgba(255,255,255,0.1));
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .difficulty-row {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #FFD700;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }
        input[type=range] { width: 100%; margin: 15px 0; cursor: pointer; accent-color: #FFD700; }

        .ach-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: left;
            opacity: 0.7;
            transition: 0.3s;
        }
        .ach-row.unlocked {
            border-color: #00FF00;
            background: linear-gradient(to right, rgba(0, 100, 0, 0.4), rgba(0, 50, 0, 0.2));
            opacity: 1;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }
        .ach-icon { font-size: 28px; margin-right: 15px; }
        .ach-info h4 { margin: 0; color: #aaa; font-size: 1.1em; }
        .ach-row.unlocked .ach-info h4 { color: #FFD700; }
        .ach-info span { font-size: 0.9em; color: #ccc; }

        .btn {
            background: linear-gradient(to bottom, #228B22, #006400);
            color: white;
            border: none;
            padding: 8px 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 0 3px 0 #004d00;
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; color: #888; }
        .btn-close { background: #d32f2f; padding: 12px 30px; font-size: 1.2em; margin-top: 20px; width: 100%; box-shadow: 0 4px 0 #8B0000; }

        .skin-viewer {
            margin-top: 20px;
            border-top: 2px solid #555;
            padding-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
        }
        .skin-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .selector-label { width: 180px; font-size: 1.2em; color: #FFD700; font-weight: bold; text-transform: uppercase; }

        #notification {
            position: absolute;
            bottom: 250px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #000, #333);
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
            z-index: 200;
            text-align: center;
            box-shadow: 0 0 25px #FFD700;
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp {
            from { bottom: 150px; opacity: 0; }
            to { bottom: 250px; opacity: 1; }
        }
        #courtNameDisplay {
            position: absolute;
            top: 60px;
            right: 20px;
            font-size: 1.5em;
            color: rgba(255,255,255,0.7);
            font-weight: 900;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
            font-style: italic;
            text-align: right;
        }
        #strikes {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #FF4500;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }
        #contest-ui {
            display: none;
            position: absolute;
            top: 150px;
            left: 20px;
            font-size: 1.2em;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <h1>TACO BASKET BALL</h1>
        <p>Tacos: <span id="scoreVal" class="stat-label">0</span></p>
        <div id="classic-stats">
            <p>Distance: <span id="distVal" class="stat-label">10 ft</span></p>
            <p>Record: <span id="highScoreVal" class="highscore-label">10 ft</span></p>
        </div>
    </div>
    <div id="strikes">MISS: <span id="missVal">0</span>/2</div>
    <div id="courtNameDisplay">COUR ARRI√àRE DE L√âVIS</div>
    <div id="contest-ui">
        <p style="color:#FFFF00; font-size:1.5em;">TEMPS: <span id="contestTime">60</span>s</p>
        <p>SCORE: <span id="contestScore" style="color:#00FF00">0</span></p>
        <p>STATION: <span id="contestRack">1</span>/5</p>
    </div>
    <div id="controls">
        <div class="ui-btn" onclick="toggleMode()">MODE: <span id="modeBtnText">CLASSIQUE</span></div>
        <div class="ui-btn" onclick="openShop()">BOUTIQUE [P]</div>
        <div class="ui-btn" onclick="openAchievements()">TROPH√âES [O]</div>
        <div class="ui-btn" onclick="openStats()">STATS [S]</div>
    </div>
    <div id="notification">
        <div>üèÜ SUCC√àS D√âBLOQU√â !</div>
        <div id="notifText" style="color:white; font-size:0.8em; margin-top:5px;">Rookie</div>
    </div>

    <!-- MODALS -->
    <div id="statsUI" class="modal">
        <div class="modal-header">STATISTIQUES √Ä VIE</div>
        <div style="text-align:left; padding: 10px; font-size: 1.2em;">
            <p style="overflow:hidden;">Tirs Totaux: <span id="statShots" style="color:#FFF; float:right">0</span></p>
            <p style="overflow:hidden;">Paniers: <span id="statMakes" style="color:#00FF00; float:right">0</span></p>
            <p style="overflow:hidden;">Rat√©s: <span id="statMisses" style="color:#FF0000; float:right">0</span></p>
            <p style="overflow:hidden;">Pr√©cision: <span id="statAccuracy" style="color:#FFD700; float:right">0%</span></p>
            <p style="overflow:hidden;">Concours Jou√©s: <span id="statContests" style="color:#00FFFF; float:right">0</span></p>
            <hr style="border-color:#555; margin:15px 0;">
            <p style="overflow:hidden;">Meilleure Distance: <span id="statBestDist" style="color:#FFD700; float:right">0 pi</span></p>
        </div>
        <button id="btnReset" class="btn" style="background: #8B0000; margin-top: 20px; width: 100%; border: 1px solid #ff4444;" onclick="attemptReset()">R√âINITIALISER PROGRESSION</button>
        <button id="btnUnlock" class="btn" style="background: #4B0082; margin-top: 10px; width: 100%; border: 1px solid #9370DB;" onclick="unlockAllSkins()">D√âBLOQUER TOUS LES SKINS</button>
        <button class="btn btn-close" onclick="closeStats()">FERMER</button>
    </div>

    <div id="shopUI" class="modal">
        <div class="modal-header">TACO MERCADO</div>
        <p>Tacos Disponibles: <span id="shopTacos" style="color:#FFFF00; font-size: 1.2em; font-weight: bold;">0</span></p>
        <div class="difficulty-row">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><strong>DIFFICULT√â</strong><span id="diffLabel" style="color:#00FF00; font-weight:bold;">NORMAL (x1.0)</span></div>
            <input type="range" id="diffSlider" min="1" max="3" step="0.5" value="1" oninput="updateDifficulty()">
            <div style="font-size:0.8em; color:#aaa;">Plus c'est dur, plus √ßa paye !</div>
        </div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">SIROP D'√âRABLE</strong> (Niv <span id="lvlIncome">1</span>)<br><span style="font-size:0.85em; color:#ccc;">R√©compense sucr√©e ! (Multiplicateur x0.5/niv)</span></div><button id="btnBuyIncome" class="btn" onclick="buyUpgrade('income')">Acheter (5)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">VIS√âE ASSIST√âE</strong> (Niv <span id="lvlAim">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Fen√™tre de tir plus large.</span></div><button id="btnBuyAim" class="btn" onclick="buyUpgrade('aim')">Acheter (10)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">TACO GREASE</strong> (Niv <span id="lvlLuck">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Chance de rebond favorable.</span></div><button id="btnBuyLuck" class="btn" onclick="buyUpgrade('luck')">Acheter (15)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">MOONWALK</strong> (Niv <span id="lvlMoonwalk">1</span>)<br><span style="font-size:0.85em; color:#ccc;">Recule plus vite apr√®s chaque panier !</span></div><button id="btnBuyMoonwalk" class="btn" onclick="buyUpgrade('moonwalk')">Acheter (25)</button></div>
        <div class="upgrade-row"><div style="text-align:left;"><strong style="font-size:1.1em; color:#FFD700;">SECONDE CHANCE</strong> (Niv <span id="lvlExtraLives">0</span>)<br><span style="font-size:0.85em; color:#ccc;">Tirs de plus avant Game Over.</span></div><button id="btnBuyExtraLives" class="btn" onclick="buyUpgrade('extraLives')">Acheter (1000)</button></div>
        <div class="skin-viewer">
            <h3 style="color:#aaa; border-bottom:1px solid #555; padding-bottom:5px;">VESTIAIRE</h3>
            <div class="skin-nav"><button class="btn" onclick="changeAnimal(-1)">&lt;</button><span id="animalName" class="selector-label">Rat</span><button class="btn" onclick="changeAnimal(1)">&gt;</button></div>
            <div class="skin-nav"><button class="btn" onclick="changeSkin(-1)">&lt;</button><span id="skinName" class="selector-label">Classic</span><button class="btn" onclick="changeSkin(1)">&gt;</button></div>
            <div id="skinStatus" style="margin-bottom:15px; color:#aaa; font-style:italic;">√âquip√©</div>
            <button id="btnEquipSkin" class="btn" style="width:100%; font-size: 1.1em;" onclick="buyOrEquipSkin()">√âquiper</button>
        </div>
        <button class="btn btn-close" onclick="closeShop()">FERMER</button>
    </div>

    <div id="achUI" class="modal">
        <div class="modal-header">SALLE DES TROPH√âES</div>
        <div id="achList"></div>
        <button class="btn btn-close" onclick="closeAchievements()">FERMER</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
    // --- 1. DATA & CONSTANTS (DEFINED FIRST) ---
    var ACHIEVEMENTS = [
        { id: 'rookie', name: 'Recrue', desc: 'Premier panier marqu√©', reward: 10 },
        { id: 'veteran', name: 'V√©t√©ran', desc: 'Marquer 100 paniers au total', reward: 150 },
        { id: 'ball_hog', name: 'Ball Hog', desc: 'Tirer 500 fois', reward: 100 },
        { id: 'bricklayer', name: 'Briqueur', desc: 'Rater 50 tirs', reward: 25 },
        { id: 'amateur', name: 'Amateur', desc: 'Atteindre 25 pi', reward: 25 },
        { id: 'sniper', name: 'Sniper', desc: 'Atteindre 50 pi', reward: 50 },
        { id: 'pro', name: 'Pro Shooter', desc: 'Atteindre 75 pi', reward: 75 },
        { id: 'parking_lot', name: 'Parking', desc: 'Atteindre 100 pi', reward: 100 },
        { id: 'longshot', name: 'Longue Distance', desc: 'Atteindre 125 pi', reward: 125 },
        { id: 'levis_legend', name: 'L√©vis Legend', desc: 'Atteindre 150 pi', reward: 200 },
        { id: 'interstellar', name: 'Interstellaire', desc: 'Atteindre 200 pi', reward: 300 },
        { id: 'moonwalker', name: 'Marcheur Lunaire', desc: 'Atteindre 500 pi', reward: 500 },
        { id: 'demigod', name: 'Demi-Dieu', desc: 'Atteindre 1000 pi', reward: 1000 },
        { id: 'contest_winner', name: 'Roi du Concours', desc: 'Score > 10 au Concours', reward: 200 },
        { id: 'contest_perfect', name: 'Perfection', desc: 'Score > 20 au Concours', reward: 500 },
        { id: 'pocket_change', name: 'Fond de poche', desc: 'Avoir 100 Tacos', reward: 10 },
        { id: 'tycoon', name: 'Taco Tycoon', desc: 'Avoir 500 Tacos', reward: 50 },
        { id: 'millionaire', name: 'Millionaire', desc: 'Avoir 2000 Tacos', reward: 200 },
        { id: 'sweet_tooth', name: 'Bec Sucr√©', desc: 'Sirop √ârable Niv 5', reward: 100 },
        { id: 'hawkeye', name: 'Oeil de Lynx', desc: 'Vis√©e Assist√©e Niv 5', reward: 100 },
        { id: 'leprechaun', name: 'Chanceux', desc: 'Taco Grease Niv 5', reward: 100 },
        { id: 'fashionista', name: 'Fashionista', desc: 'D√©bloquer 5 skins', reward: 100 },
        { id: 'wardrobe_malfunction', name: 'Garde-robe Pleine', desc: 'D√©bloquer 10 skins', reward: 300 },
        { id: 'collector', name: 'Collectionneur', desc: 'D√©bloquer 15 skins', reward: 500 },
        { id: 'zoo', name: 'Gardien de Zoo', desc: 'Skins pour 3 animaux diff√©rents', reward: 150 },
        { id: 'lucky', name: 'Chance Pure', desc: 'Avoir un rebond chanceux', reward: 25 },
        { id: 'daredevil', name: 'Casse-cou', desc: 'Marquer en difficult√© max', reward: 50 },
        { id: 'hard_mode', name: 'Travaillant', desc: 'Marquer en mode Difficile', reward: 25 },
        { id: 'cosplay', name: 'Cosplay', desc: '√âquiper Robot/Alien/Ninja', reward: 20 },
        { id: 'eh', name: 'Canadien', desc: '√âquiper B√ªcheron ou Hockey', reward: 20 },
        { id: 'spooky', name: 'Effrayant', desc: '√âquiper Zombie/Vampire/Diable', reward: 20 },
        { id: 'urban_legend', name: 'L√©gende Urbaine', desc: 'Jouer sur le Terrain de Rue', reward: 50 },
        { id: 'ice_cold', name: 'Glace', desc: 'Jouer sur la Patinoire', reward: 100 },
        { id: 'astronaut_training', name: 'Cadet Spatial', desc: 'Jouer sur la Lune', reward: 150 }
    ];

    var COURT_ZONES = [
        { limit: 50, name: "COUR ARRI√àRE", type: 'grass', ground1: '#228B22', ground2: '#32CD32', sky1: '#87CEEB', sky2: '#FFF' },
        { limit: 100, name: "PARC DE LA PAIX", type: 'tree', ground1: '#8B4513', ground2: '#D2691E', sky1: '#87CEEB', sky2: '#E0FFFF' },
        { limit: 200, name: "VIEUX-L√âVIS", type: 'castle', ground1: '#8B0000', ground2: '#A52A2A', sky1: '#4682B4', sky2: '#87CEEB' },
        { limit: 350, name: "TERRAIN DE RUE", type: 'castle', ground1: '#696969', ground2: '#808080', sky1: '#4682B4', sky2: '#87CEEB' },
        { limit: 500, name: "FOR√äT BOR√âALE", type: 'tree', ground1: '#006400', ground2: '#2F4F4F', sky1: '#2E8B57', sky2: '#8FBC8F' },
        { limit: 750, name: "LA PATINOIRE", type: 'mountain', ground1: '#E0FFFF', ground2: '#FFFFFF', sky1: '#87CEEB', sky2: '#F0F8FF' },
        { limit: 1000, name: "FLEUVE ST-LAURENT", type: 'water', ground1: '#00008B', ground2: '#1E90FF', sky1: '#191970', sky2: '#4169E1' },
        { limit: 1500, name: "MONT-SAINTE-ANNE", type: 'mountain', ground1: '#F0FFFF', ground2: '#E0FFFF', sky1: '#87CEEB', sky2: '#00BFFF' },
        { limit: 2500, name: "HAUTE ATMOSPH√àRE", type: 'space', ground1: '#483D8B', ground2: '#6A5ACD', sky1: '#000080', sky2: '#000000' },
        { limit: 4000, name: "BASE LUNAIRE", type: 'space', ground1: '#808080', ground2: '#A9A9A9', sky1: '#000000', sky2: '#191970' },
        { limit: 6000, name: "MARS", type: 'space', ground1: '#8B4513', ground2: '#CD853F', sky1: '#FF4500', sky2: '#000000' },
        { limit: 8000, name: "LE NETHER", type: 'space', ground1: '#8B0000', ground2: '#2F0000', sky1: '#330000', sky2: '#000000' },
        { limit: 9999999, name: "DIMENSION TACO", type: 'grass', ground1: '#FF00FF', ground2: '#00FFFF', sky1: '#FFFF00', sky2: '#FF0000' }
    ];

    var SCALE_OBJECTS = [
        { limit: 15, name: "Voiture Compacte", icon: "üöó" },
        { limit: 25, name: "Orignal (2m)", icon: "ü¶å" },
        { limit: 30, name: "Ligne de 3 points", icon: "üèÄ" },
        { limit: 40, name: "Autobus Scolaire", icon: "üöå" },
        { limit: 60, name: "Piste de Bowling", icon: "üé≥" },
        { limit: 94, name: "Terrain NBA", icon: "üèÄ" },
        { limit: 150, name: "Baleine Bleue", icon: "üêã" },
        { limit: 195, name: "Tour de Pise", icon: "üáÆüáπ" },
        { limit: 230, name: "Envergure Boeing 747", icon: "‚úàÔ∏è" },
        { limit: 272, name: "Chute Montmorency", icon: "üåä" },
        { limit: 305, name: "Statue de la Libert√©", icon: "üóΩ" },
        { limit: 350, name: "Ch√¢teau Frontenac", icon: "üè∞" },
        { limit: 450, name: "Pyramide de Gizeh", icon: "üî∫" },
        { limit: 600, name: "Space Needle", icon: "üõ∏" },
        { limit: 984, name: "Tour Eiffel", icon: "üá´üá∑" },
        { limit: 1454, name: "Empire State Building", icon: "üèôÔ∏è" },
        { limit: 1815, name: "Tour CN", icon: "üóº" },
        { limit: 2200, name: "Pont de Qu√©bec (Trav√©e)", icon: "üåâ" },
        { limit: 2717, name: "Burj Khalifa", icon: "üè¢" },
        { limit: 5280, name: "Un Mille (1.6km)", icon: "üõ£Ô∏è" },
        { limit: 10000, name: "Piste A√©roport", icon: "üõ´" },
        { limit: 14410, name: "Mont Rainier", icon: "üèîÔ∏è" },
        { limit: 20310, name: "Mont Denali", icon: "‚õ∞Ô∏è" },
        { limit: 29029, name: "Mont Everest", icon: "üóª" },
        { limit: 35000, name: "Altitude de Croisi√®re", icon: "‚úàÔ∏è" },
        { limit: 100000, name: "Stratosph√®re", icon: "üéà" },
        { limit: 328000, name: "Ligne de K√°rm√°n (Espace)", icon: "üåå" },
        { limit: 1300000, name: "Station Spatiale (ISS)", icon: "üõ∞Ô∏è" },
        { limit: 9999999, name: "La Lune", icon: "üåë" }
    ];

    var SKINS_DB = [
        { id: 'rat_classic', animal: 'rat', name: 'Classique', cost: 0 },
        { id: 'rat_lumberjack', animal: 'rat', name: 'B√ªcheron', cost: 500 },
        { id: 'rat_mariachi', animal: 'rat', name: 'El Mariachi', cost: 1000 },
        { id: 'rat_luchador', animal: 'rat', name: 'Luchador', cost: 1500 },
        { id: 'rat_alien', animal: 'rat', name: 'Alien', cost: 3000 },
        { id: 'rat_zombie', animal: 'rat', name: 'Zombie', cost: 3000 },
        { id: 'rat_astronaut', animal: 'rat', name: 'Astronaute', cost: 5000 },
        { id: 'rat_ninja', animal: 'rat', name: 'Ninja', cost: 5000 },
        { id: 'rat_robot', animal: 'rat', name: 'Robot', cost: 5000 },
        { id: 'rat_pirate', animal: 'rat', name: 'Pirate', cost: 1500 },
        { id: 'rat_clown', animal: 'rat', name: 'Clown', cost: 1500 },
        { id: 'rat_vampire', animal: 'rat', name: 'Vampire', cost: 3000 },
        { id: 'rat_chef', animal: 'rat', name: 'Chef', cost: 750 },
        { id: 'rat_hockey', animal: 'rat', name: 'Joueur Hockey', cost: 7500 },
        { id: 'rat_poutine', animal: 'rat', name: 'Poutine', cost: 7500 },
        { id: 'rat_king', animal: 'rat', name: 'Roi', cost: 10000 },
        { id: 'rat_wizard', animal: 'rat', name: 'Sorcier', cost: 10000 },
        { id: 'rat_devil', animal: 'rat', name: 'Diable', cost: 15000 },
        { id: 'rat_angel', animal: 'rat', name: 'Ange', cost: 15000 },
        { id: 'cat_classic', animal: 'cat', name: 'Classique', cost: 250 },
        { id: 'cat_tabby', animal: 'cat', name: 'Tigr√©', cost: 1000 },
        { id: 'cat_tuxedo', animal: 'cat', name: 'Tuxedo', cost: 1000 },
        { id: 'dog_classic', animal: 'dog', name: 'Classique', cost: 250 },
        { id: 'dog_dalmation', animal: 'dog', name: 'Dalmatien', cost: 1000 },
        { id: 'dog_pug', animal: 'dog', name: 'Carlin', cost: 1500 },
        { id: 'bear_classic', animal: 'bear', name: 'Classique', cost: 500 },
        { id: 'bear_panda', animal: 'bear', name: 'Panda', cost: 3000 },
        { id: 'bear_polar', animal: 'bear', name: 'Polaire', cost: 3000 },
        { id: 'rabbit_classic', animal: 'rabbit', name: 'Classique', cost: 250 },
        { id: 'rabbit_jack', animal: 'rabbit', name: 'Li√®vre', cost: 1000 },
        { id: 'rabbit_magic', animal: 'rabbit', name: 'Magicien', cost: 2500 },
        { id: 'beaver_classic', animal: 'beaver', name: 'Classique', cost: 500 },
        { id: 'beaver_lumber', animal: 'beaver', name: 'B√ªcheron', cost: 1500 },
        { id: 'moose_classic', animal: 'moose', name: 'Classique', cost: 750 },
        { id: 'moose_royal', animal: 'moose', name: 'Royal', cost: 5000 },
        { id: 'penguin_classic', animal: 'penguin', name: 'Classique', cost: 750 },
        { id: 'penguin_emperor', animal: 'penguin', name: 'Empereur', cost: 3000 },
        { id: 'raccoon_classic', animal: 'raccoon', name: 'Classique', cost: 500 },
        { id: 'raccoon_bandit', animal: 'raccoon', name: 'Bandit', cost: 1500 },
        // NBA LEGENDS (Humans)
        { id: 'human_wall', animal: 'human', name: 'Speedy', cost: 5000, jerseyColor: '#002B5C', shortsColor: '#E31837', number: '2', numberColor: '#FFF', skinTone: '#5c3a21', hairStyle: 'short', hairColor: '#000', socksColor: '#FFF', shoesColor: '#000' },
        { id: 'human_lebron', animal: 'human', name: 'The King', cost: 25000, jerseyColor: '#6F263D', shortsColor: '#FFB81C', number: '23', numberColor: '#FFB81C', skinTone: '#4a3020', hairStyle: 'headband', hairColor: '#000', headbandColor: '#FFB81C', sleeveRight: '#6F263D', socksColor: '#FFF', shoesColor: '#111' },
        { id: 'human_kobe8', animal: 'human', name: 'Frobe', cost: 30000, jerseyColor: '#552583', shortsColor: '#552583', number: '8', numberColor: '#FDB927', skinTone: '#5c3a21', hairStyle: 'afro', hairColor: '#000', socksColor: '#FFF', shoesColor: '#111' },
        { id: 'human_kobe24', animal: 'human', name: 'Black Mamba', cost: 30000, jerseyColor: '#FFF', shortsColor: '#FFF', number: '24', numberColor: '#552583', skinTone: '#5c3a21', hairStyle: 'bald', hairColor: '#000', sleeveRight: '#FFF', socksColor: '#FFF', shoesColor: '#FFF' },
        { id: 'human_curry', animal: 'human', name: 'Chef Curry', cost: 30000, jerseyColor: '#000', shortsColor: '#000', number: '30', numberColor: '#FFC72C', skinTone: '#dcb98a', hairStyle: 'short', hairColor: '#000', jerseyType: 'tshirt', socksColor: '#FFF', shoesColor: '#1D428A' },
        { id: 'human_magic', animal: 'human', name: 'Magic', cost: 30000, jerseyColor: '#FDB927', shortsColor: '#552583', number: '32', numberColor: '#552583', skinTone: '#5c3a21', hairStyle: 'short', hairColor: '#000', socksColor: '#FFF', shoesColor: '#FFF' },
        { id: 'human_drj', animal: 'human', name: 'The Doctor', cost: 35000, jerseyColor: '#FFF', shortsColor: '#002B5C', number: '32', numberColor: '#E31837', skinTone: '#5c3a21', hairStyle: 'afro', hairColor: '#000', socksColor: '#FFF', shoesColor: '#FFF' },
        { id: 'human_wilt', animal: 'human', name: 'The Stilt', cost: 40000, jerseyColor: '#ED174C', shortsColor: '#ED174C', number: '13', numberColor: '#FFF', skinTone: '#4a3020', hairStyle: 'headband', hairColor: '#000', headbandColor: '#FFF', socksColor: '#FFF', shoesColor: '#FFF' },
        { id: 'human_mj', animal: 'human', name: 'The G.O.A.T.', cost: 50000, jerseyColor: '#CE1141', shortsColor: '#CE1141', number: '23', numberColor: '#000', skinTone: '#3e271a', hairStyle: 'bald', hairColor: '#000', socksColor: '#FFF', shoesColor: '#FFF' }
    ];

    var ANIMALS = ['rat', 'cat', 'dog', 'bear', 'rabbit', 'beaver', 'moose', 'penguin', 'raccoon', 'human'];

    var decors = [];
    for(let i=0; i<300; i++) {
        const dist = Math.random() * 10000;
        const pathX = 600 - (dist * 0.7);
        const pathY = 150 + (dist * 0.7);
        const scatter = (Math.random() - 0.5) * 1200;
        decors.push({ x: pathX + scatter, y: pathY + scatter, dist: dist });
    }

    var mountains = [];
    for(let i=0; i<15; i++) { mountains.push({ x: i * 80 - 100, h: 100 + Math.random() * 150, color: `hsl(25, ${30 + Math.random()*20}%, ${20 + Math.random()*10}%)` }); }

    // --- 2. GLOBAL VARIABLES ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('scoreVal');
    const distEl = document.getElementById('distVal');
    const highScoreEl = document.getElementById('highScoreVal');
    const shopUI = document.getElementById('shopUI');
    const achUI = document.getElementById('achUI');
    const statsUI = document.getElementById('statsUI');
    const notif = document.getElementById('notification');
    const courtNameEl = document.getElementById('courtNameDisplay');
    const missValEl = document.getElementById('missVal');
    const container = document.getElementById('game-container');
    const contestUI = document.getElementById('contest-ui');
    const strikesEl = document.getElementById('strikes');

    canvas.width = 800;
    canvas.height = 600;

    let viewingAnimalIndex = 0;
    let viewingSkinIndex = 0;
    let currentGameMode = 'CLASSIC';
    let contestData = { timer: 60, score: 0, rack: 1, ballsInRack: 0, isActive: false };
    let distanceLevel = 1;
    let state = 'IDLE';
    let feedback = "";
    let feedbackTimer = 0;
    let consecutiveMisses = 0;
    let currentStreak = 0;
    let spacePressed = false;
    let cameraZoom = 800;
    let cameraHeight = 300;
    let resetStage = 0;

    // Physique
    const GRAVITY = 0.5;
    const HOOP_POS = { x: 600, y: 150, z: 130 };
    let player3D = { x: 300, y: 300, z: 0, vz: 0 };
    let ball = { x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0, active: false };

    const defaultData = {
        tacos: 0, level: 1, difficulty: 1.0, highScore: 10,
        stats: { income: 1, aim: 1, luck: 1, moonwalk: 1, extraLives: 0 },
        lifetimeStats: { shots: 0, makes: 0, misses: 0, contests: 0 },
        unlockedSkins: ['rat_classic'], currentSkin: 'rat_classic', unlockedAchievements: []
    };

    let savedData = localStorage.getItem('tacoSaveData');
    let playerData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultData));

    // Migration logic to fix old saves
    if(!playerData.unlockedAchievements) playerData.unlockedAchievements = [];
    if(!playerData.stats.income) playerData.stats.income = 1;
    if(!playerData.stats.moonwalk) playerData.stats.moonwalk = 1;
    if(typeof playerData.stats.extraLives === 'undefined') playerData.stats.extraLives = 0;
    if(!playerData.lifetimeStats) playerData.lifetimeStats = { shots: 0, makes: 0, misses: 0, contests: 0 };
    if(!playerData.unlockedSkins) playerData.unlockedSkins = ['rat_classic'];
    if(!playerData.currentSkin) playerData.currentSkin = 'rat_classic'; window.playerData = playerData;

    highScoreEl.innerText = playerData.highScore + " pi";

    // --- 3. HELPER FUNCTIONS ---
    function saveData() { localStorage.setItem('tacoSaveData', JSON.stringify(playerData)); }
    function getScaleObject(dist) { return SCALE_OBJECTS.find(o => dist < o.limit) || SCALE_OBJECTS[SCALE_OBJECTS.length-1]; }
    function getCourtDetails(dist) { return COURT_ZONES.find(z => dist < z.limit) || COURT_ZONES[COURT_ZONES.length-1]; }
    function getJoint(x, y, length, angle) { return { x: x + Math.cos(angle) * length, y: y + Math.sin(angle) * length }; }

    function resizeGame() {
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        const scale = Math.min(winW / 800, winH / 600) * 0.95;
        container.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);

    function project(x, y, z) {
        const dxToHoop = HOOP_POS.x - player3D.x;
        const dyToHoop = HOOP_POS.y - player3D.y;
        const distToHoop = Math.sqrt(dxToHoop*dxToHoop + dyToHoop*dyToHoop);
        let idealZoom = 380 * (400 + distToHoop) / Math.max(100, distToHoop);
        idealZoom = Math.min(1000, Math.max(400, idealZoom));
        cameraZoom = idealZoom; cameraHeight = 84000 / cameraZoom;
        const angleToHoop = Math.atan2(dyToHoop, dxToHoop);
        const rotation = -angleToHoop - Math.PI/2;
        const dx = x - player3D.x; const dy = y - player3D.y;
        const rx = dx * Math.cos(rotation) - dy * Math.sin(rotation);
        const ry = dx * Math.sin(rotation) + dy * Math.cos(rotation);
        const cameraOffset = 400; const depth = cameraOffset - ry;
        if (depth <= 0) return null;
        const scale = cameraZoom / depth;
        const screenX = canvas.width / 2 + (rx * scale);
        const horizonY = (canvas.height - 120) * 0.5;
        const screenY = horizonY + (cameraHeight - z) * scale;
        return { x: screenX, y: screenY, scale: scale, depth: depth };
    }

    // --- 4. DRAWING FUNCTIONS ---
    function drawFlightTracker() {
        const h = 120;
        const y = canvas.height - h;
        ctx.fillStyle = '#111'; ctx.fillRect(0, y, canvas.width, h);
        ctx.fillStyle = '#222'; ctx.fillRect(0, y + h/2, canvas.width, h/2);
        const dist = 10 + (distanceLevel * 5);
        const scaleObj = getScaleObject(dist);
        ctx.font = "bold 20px 'Segoe UI'"; ctx.fillStyle = "#FFD700"; ctx.textAlign = "center";
        if (currentGameMode === 'CLASSIC') {
            ctx.fillText(`Distance: ${dist} pi`, canvas.width/2, y + 30);
            ctx.font = "italic 16px 'Segoe UI'"; ctx.fillStyle = "#aaa";
            ctx.fillText(`(√âquivalent: ${scaleObj.name})`, canvas.width/2, y + 55);
        } else {
             ctx.fillText(`CONCOURS 3 POINTS`, canvas.width/2, y + 30);
        }
        const margin = 100; const lineY = y + 80; const lineLen = canvas.width - (margin * 2);
        ctx.strokeStyle = '#555'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(margin, lineY); ctx.lineTo(margin + lineLen, lineY); ctx.stroke();
        ctx.font = "30px Arial"; ctx.textAlign="center";
        ctx.fillText("‚õπÔ∏è", margin, lineY + 10); ctx.fillText("üèÄ", margin + lineLen, lineY + 10);
        if (currentGameMode === 'CLASSIC') { ctx.globalAlpha = 0.3; ctx.font = "60px Arial"; ctx.fillText(scaleObj.icon, canvas.width/2, lineY); ctx.globalAlpha = 1.0; }
        if(state === 'SHOOTING' && ball.active) {
            const dx = HOOP_POS.x - player3D.x; const dy = HOOP_POS.y - player3D.y;
            const totalDist = Math.sqrt(dx*dx + dy*dy);
            const ballDx = ball.x - player3D.x; const ballDy = ball.y - player3D.y;
            const currentDist = Math.sqrt(ballDx*ballDx + ballDy*ballDy);
            let progress = currentDist / totalDist;
            const zFactor = ball.z / 300;
            const ballX = margin + (progress * lineLen);
            const ballY = lineY - (zFactor * 50);
            ctx.fillStyle = '#ff6600'; ctx.beginPath(); ctx.arc(ballX, ballY, 5, 0, Math.PI*2); ctx.fill();
        }
    }

    function drawBallSprite(x, y, scale) {
        let color1 = '#ff6600'; let color2 = '#cc5500';
        if(currentGameMode === 'CONTEST' && contestData.ballsInRack === 4) { color1 = '#FFFFFF'; color2 = '#0000FF'; }
        ctx.strokeStyle = '#000'; ctx.lineWidth = 1 * scale;
        const grad = ctx.createRadialGradient(x - 2*scale, y - 2*scale, 1*scale, x, y, 8*scale);
        grad.addColorStop(0, color1); grad.addColorStop(1, color2);
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, 8 * scale, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.beginPath(); ctx.arc(x, y, 8 * scale, 0, Math.PI*2); ctx.stroke();
        if(currentGameMode === 'CONTEST' && contestData.ballsInRack === 4) { ctx.strokeStyle = '#FF0000'; ctx.lineWidth = 2 * scale; }
        ctx.beginPath(); ctx.moveTo(x - 8*scale, y); ctx.quadraticCurveTo(x, y + 4*scale, x + 8*scale, y); ctx.stroke();
    }

    function drawBall(p) {
        if (!p) return;
        drawBallSprite(p.x, p.y, p.scale);
    }

    // --- FUR & ANATOMY HELPERS ---
    function drawFuzzyPath(points, color, scale, close = true, seed = 1) {
        if(points.length < 2) return;
        ctx.beginPath();
        const fuzz = 3 * scale;

        // Simple seeded random function
        const pseudoRand = (idx) => {
            let t = (seed + idx) * 0.123456789;
            return Math.sin(t) * 43758.5453123 - Math.floor(Math.sin(t) * 43758.5453123);
        };

        for (let i = 0; i < points.length; i++) {
            const p1 = points[i];
            const p2 = points[(i + 1) % points.length];
            if (!close && i === points.length - 1) break;

            const dist = Math.sqrt((p2.x - p1.x)**2 + (p2.y - p1.y)**2);
            const segments = Math.max(2, Math.floor(dist / (4 * scale)));

            if(i===0) ctx.moveTo(p1.x, p1.y);

            for(let j=1; j<=segments; j++) {
                const t = j / segments;
                const tx = p1.x + (p2.x - p1.x) * t;
                const ty = p1.y + (p2.y - p1.y) * t;
                const noiseX = (pseudoRand(i * 100 + j) - 0.5) * fuzz;
                const noiseY = (pseudoRand(i * 100 + j + 5000) - 0.5) * fuzz;
                ctx.lineTo(tx + noiseX, ty + noiseY);
            }
        }
        if(close) ctx.closePath();

        ctx.fillStyle = color;
        ctx.fill();
        // Add texture
        ctx.save();
        ctx.clip();
        ctx.strokeStyle = 'rgba(0,0,0,0.15)';
        ctx.lineWidth = 1 * scale;
        const b = getBounds(points);
        const area = (b.maxX - b.minX) * (b.maxY - b.minY);
        const dens = Math.floor(area / (100 * scale * scale)); // Approximate density
        for(let k=0; k<dens; k++) {
            const r1 = pseudoRand(k * 10 + 200);
            const r2 = pseudoRand(k * 10 + 300);
            const rx = b.minX + r1 * (b.maxX - b.minX);
            const ry = b.minY + r2 * (b.maxY - b.minY);
            if(isPointInPoly(rx, ry, points)) {
                ctx.beginPath(); ctx.moveTo(rx, ry);
                const r3 = pseudoRand(k * 10 + 400);
                ctx.lineTo(rx + (r3-0.5)*5*scale, ry + 5*scale);
                ctx.stroke();
            }
        }
        ctx.restore();
    }

    function getBounds(points) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        points.forEach(p => { if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y; });
        return {minX, minY, maxX, maxY};
    }

    function isPointInPoly(x, y, points) {
        let inside = false;
        for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
            const xi = points[i].x, yi = points[i].y;
            const xj = points[j].x, yj = points[j].y;
            const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function drawFuzzyLimb(x1, y1, x2, y2, width, color, scale, isFurry, seed = 1) {
        if(!isFurry) {
            drawLimb(x1, y1, x2, y2, width, color);
            return;
        }
        // Construct polygon for limb
        const angle = Math.atan2(y2 - y1, x2 - x1);
        const dx = Math.sin(angle) * (width / 2);
        const dy = Math.cos(angle) * (width / 2);

        const p1 = {x: x1 - dx, y: y1 + dy};
        const p2 = {x: x2 - dx, y: y2 + dy};
        const p3 = {x: x2 + dx, y: y2 - dy};
        const p4 = {x: x1 + dx, y: y1 - dy};

        drawFuzzyPath([p1, p2, p3, p4], color, scale, true, seed);

        // Add shadow gradient overlay for depth
        ctx.save();
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.closePath();
        ctx.clip();
        const grad = ctx.createLinearGradient(x1, y1, x2, y2);
        grad.addColorStop(0, 'rgba(0,0,0,0)'); grad.addColorStop(1, 'rgba(0,0,0,0.3)');
        ctx.fillStyle = grad; ctx.fill();
        ctx.restore();
    }

    function drawAnatomicBody(cx, topY, w, h, scale, color, isFurry, seed = 1) {
        // Hourglass / Tapered shape
        // Shoulders
        const sW = w * 1.1;
        const hW = w * 1.0; // Hips
        const wW = w * 0.85; // Waist

        const shoulderY = topY;
        const waistY = topY + h * 0.55;
        const hipY = topY + h;

        const points = [
            {x: cx - sW/2, y: shoulderY},     // Top Left
            {x: cx + sW/2, y: shoulderY},     // Top Right
            {x: cx + wW/2, y: waistY},        // Waist Right
            {x: cx + hW/2, y: hipY},          // Hip Right
            {x: cx - hW/2, y: hipY},          // Hip Left
            {x: cx - wW/2, y: waistY}         // Waist Left
        ];

        if (isFurry) {
            drawFuzzyPath(points, color, scale, true, seed);
        } else {
            ctx.beginPath();
            ctx.moveTo(points[0].x + 10*scale, points[0].y); // Round corner start
            ctx.lineTo(points[1].x - 10*scale, points[1].y);
            ctx.quadraticCurveTo(points[1].x, points[1].y, points[1].x, points[1].y + 10*scale);
            ctx.lineTo(points[2].x, points[2].y);
            ctx.lineTo(points[3].x, points[3].y - 10*scale);
            ctx.quadraticCurveTo(points[3].x, points[3].y, points[3].x - 10*scale, points[3].y);
            ctx.lineTo(points[4].x + 10*scale, points[4].y);
            ctx.quadraticCurveTo(points[4].x, points[4].y, points[4].x, points[4].y - 10*scale);
            ctx.lineTo(points[5].x, points[5].y);
            ctx.lineTo(points[0].x, points[0].y + 10*scale);
            ctx.quadraticCurveTo(points[0].x, points[0].y, points[0].x + 10*scale, points[0].y);
            ctx.closePath();

            const grad = ctx.createRadialGradient(cx, topY + h/2, 5*scale, cx, topY + h/2, w);
            grad.addColorStop(0, color); grad.addColorStop(1, 'rgba(0,0,0,0.3)');
            ctx.fillStyle = color; ctx.fill(); ctx.fillStyle = grad; ctx.fill();
            ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
        }
    }

    function drawLimb(x1, y1, x2, y2, width, color) {
        const angle = Math.atan2(y2 - y1, x2 - x1);
        const dx = Math.sin(angle) * (width / 2); const dy = Math.cos(angle) * (width / 2);
        ctx.beginPath(); ctx.moveTo(x1 - dx, y1 + dy); ctx.lineTo(x2 - dx, y2 + dy); ctx.arc(x2, y2, width/2, angle + Math.PI/2, angle - Math.PI/2);
        ctx.lineTo(x1 + dx, y1 - dy); ctx.arc(x1, y1, width/2, angle - Math.PI/2, angle + Math.PI/2); ctx.closePath();
        const grad = ctx.createLinearGradient(x1, y1, x2, y2); grad.addColorStop(0, color); grad.addColorStop(1, '#000000');
        ctx.fillStyle = color; ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
    }

    function drawRoundedRect(x, y, w, h, r, color) {
        ctx.beginPath(); ctx.moveTo(x+r, y); ctx.arcTo(x+w, y, x+w, y+h, r); ctx.arcTo(x+w, y+h, x, y+h, r); ctx.arcTo(x, y+h, x, y, r); ctx.arcTo(x, y, x+w, y, r); ctx.closePath();
        const grad = ctx.createRadialGradient(x + w/2, y + h/2, 5, x + w/2, y + h/2, w); grad.addColorStop(0, color); grad.addColorStop(1, 'rgba(0,0,0,0.3)');
        ctx.fillStyle = color; ctx.fill(); ctx.fillStyle = grad; ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
    }

    function drawDecor(p, type) {
        if (!p) return;
        const s = p.scale;
        if(type === 'grass') {
            ctx.fillStyle = '#F4C430';
            ctx.beginPath(); ctx.arc(p.x, p.y - 20*s, 30*s, Math.PI, 0); ctx.fill();
            ctx.strokeStyle = '#D2691E'; ctx.lineWidth = 2*s; ctx.stroke();
            ctx.fillStyle = '#32CD32'; for(let i=0; i<5; i++) { ctx.beginPath(); ctx.arc(p.x - 25*s + (i*12*s), p.y - 45*s, 8*s, 0, Math.PI*2); ctx.fill(); }
            ctx.fillStyle = '#FFA500'; ctx.beginPath(); ctx.arc(p.x - 30*s, p.y - 25*s, 15*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(p.x-40*s, p.y-35*s); ctx.lineTo(p.x-45*s, p.y-50*s); ctx.lineTo(p.x-30*s, p.y-38*s); ctx.fill();
            ctx.beginPath(); ctx.moveTo(p.x-20*s, p.y-38*s); ctx.lineTo(p.x-15*s, p.y-50*s); ctx.lineTo(p.x-25*s, p.y-35*s); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p.x - 35*s, p.y - 22*s, 4*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x - 25*s, p.y - 22*s, 4*s, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(p.x - 35*s, p.y - 22*s, 1.5*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x - 25*s, p.y - 22*s, 1.5*s, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 6*s; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(p.x + 25*s, p.y - 25*s); ctx.quadraticCurveTo(p.x + 40*s, p.y - 40*s, p.x + 45*s, p.y - 10*s); ctx.stroke();
            ctx.fillStyle = '#FFA500';
            ctx.beginPath(); ctx.arc(p.x - 20*s, p.y - 5*s, 5*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x - 5*s, p.y - 5*s, 5*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x + 10*s, p.y - 5*s, 5*s, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x + 25*s, p.y - 5*s, 5*s, 0, Math.PI*2); ctx.fill();
        }
        else if(type === 'tree') {
            ctx.fillStyle = '#8B4513'; ctx.fillRect(p.x - 5*s, p.y, 10*s, -20*s);
            ctx.fillStyle = '#006400';
            ctx.beginPath(); ctx.moveTo(p.x - 30*s, p.y - 15*s); ctx.lineTo(p.x + 30*s, p.y - 15*s); ctx.lineTo(p.x, p.y - 80*s); ctx.fill();
            ctx.beginPath(); ctx.moveTo(p.x - 25*s, p.y - 40*s); ctx.lineTo(p.x + 25*s, p.y - 40*s); ctx.lineTo(p.x, p.y - 100*s); ctx.fill();
        }
        else if (type === 'water') {
             ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.arc(p.x, p.y, 10*s, 0, Math.PI*2); ctx.fill();
             ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p.x, p.y, 5*s, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'castle') {
            ctx.strokeStyle = '#222'; ctx.lineWidth = 3*s;
            ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y - 50*s); ctx.stroke();
            ctx.fillStyle = '#FFFFE0'; ctx.beginPath(); ctx.arc(p.x, p.y - 55*s, 8*s, 0, Math.PI*2); ctx.fill();
        }
        else if (type === 'mountain') {
            ctx.fillStyle = '#808080'; ctx.beginPath(); ctx.arc(p.x, p.y, 20*s, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p.x, p.y, 20*s, 3.5, 5.9); ctx.fill();
        }
        else if (type === 'space') {
            ctx.fillStyle = '#555'; ctx.beginPath(); ctx.arc(p.x, p.y - 30*s, 15*s, 0, Math.PI*2); ctx.fill();
        }
    }

    function drawShadow(p) { if(!p) return; ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(p.x, p.y, 25*p.scale, 8*p.scale, 0, 0, Math.PI*2); ctx.fill(); }

    function drawHoop(p) {
        if (!p) return;
        const s = p.scale;
        const baseP = project(HOOP_POS.x, HOOP_POS.y, 0);
        if(baseP) { ctx.fillStyle = '#444'; ctx.fillRect(p.x - 2*s, p.y, 4*s, baseP.y - p.y); }
        const bbW = 60 * s; const bbH = 40 * s; const bbX = p.x - bbW/2; const bbY = p.y - bbH - 10*s;
        ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillRect(bbX, bbY, bbW, bbH);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2*s; ctx.strokeRect(bbX, bbY, bbW, bbH);
        ctx.fillStyle = '#CE1126'; ctx.fillRect(bbX + bbW*0.35, bbY + bbH*0.6, bbW*0.3, bbH*0.3);
        ctx.beginPath(); ctx.ellipse(p.x, p.y, 18 * s, 5 * s, 0, 0, Math.PI * 2);
        ctx.fillStyle = 'none'; ctx.strokeStyle = 'orange'; ctx.lineWidth = 4 * s; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x - 15*s, p.y); ctx.lineTo(p.x - 10*s, p.y + 20*s); ctx.lineTo(p.x + 10*s, p.y + 20*s); ctx.lineTo(p.x + 15*s, p.y);
        ctx.strokeStyle = 'white'; ctx.lineWidth = 1*s; ctx.stroke();
    }

        function drawPlayer(p) {
        if (!p) return;
        const s = p.scale;
        const skin = playerData.currentSkin;
        let skinObj = SKINS_DB.find(x => x.id === skin);
        if(!skinObj) skinObj = SKINS_DB[0];
        const currentAnimal = skinObj.animal;

        let sizeMod = { w: 1, h: 1, head: 1 };
        switch(currentAnimal) {
            case 'rat': sizeMod = { w: 0.7, h: 0.7, head: 0.8 }; break;
            case 'cat': sizeMod = { w: 0.8, h: 0.8, head: 0.9 }; break;
            case 'rabbit': sizeMod = { w: 0.8, h: 0.8, head: 0.9 }; break;
            case 'raccoon': sizeMod = { w: 0.9, h: 0.9, head: 0.95 }; break;
            case 'dog': sizeMod = { w: 1.0, h: 1.0, head: 1.0 }; break;
            case 'penguin': sizeMod = { w: 1.1, h: 0.8, head: 1.0 }; break;
            case 'beaver': sizeMod = { w: 1.1, h: 0.9, head: 1.0 }; break;
            case 'moose': sizeMod = { w: 1.2, h: 1.3, head: 1.1 }; break;
            case 'bear': sizeMod = { w: 1.4, h: 1.1, head: 1.2 }; break;
            case 'human': sizeMod = { w: 0.9, h: 1.1, head: 0.9 }; break;
        }

        // Determine if Furry
        let isFurry = !skin.includes('robot') && !skin.includes('astronaut') && !skin.includes('alien') && !skin.includes('ninja');
        if (currentAnimal === 'human') isFurry = false;

        // 1. Setup Base Colors
        let furColor = '#555', tailColor = '#FFC0CB', torsoColor = '#555', legColor = '#555', armColor = '#555';
        let thighColor = '#555', calfColor = '#555';
        let bellyColor = null, hasSpots = false, hasBlackEars = false;

        if(currentAnimal === 'rat') { furColor = '#696969'; tailColor = '#FFC0CB'; }
        else if(currentAnimal === 'cat') { furColor = '#808080'; tailColor = '#808080'; }
        else if(currentAnimal === 'dog') { furColor = '#8B4513'; tailColor = '#8B4513'; }
        else if(currentAnimal === 'bear') { furColor = '#4B3621'; tailColor = '#4B3621'; }
        else if(currentAnimal === 'rabbit') { furColor = '#fff'; tailColor = '#fff'; }
        else if(currentAnimal === 'beaver') { furColor = '#5D4037'; tailColor = '#3E2723'; }
        else if(currentAnimal === 'moose') { furColor = '#5D4037'; tailColor = '#5D4037'; }
        else if(currentAnimal === 'penguin') { furColor = '#111'; tailColor = '#111'; bellyColor = '#fff'; }
        else if(currentAnimal === 'raccoon') { furColor = '#777'; tailColor = '#333'; }
        else if(currentAnimal === 'human') {
            furColor = skinObj.skinTone || '#8d5524';
            tailColor = 'transparent';
        }

        // Default clothes to fur color (naked)
        torsoColor = furColor; legColor = furColor; armColor = furColor;
        thighColor = legColor; calfColor = legColor;

        // 2. Apply Skin Overrides
        if (currentAnimal === 'human') {
            torsoColor = skinObj.jerseyColor || '#FFF';
            thighColor = skinObj.shortsColor || torsoColor;
            calfColor = furColor;
            armColor = furColor;
            legColor = thighColor;
        }
        else if(skin.includes('lumberjack')) {
            torsoColor = '#b30000';
            legColor = '#00008b';
            armColor = '#b30000';
            thighColor = legColor; calfColor = legColor;
        }
        else if(skin.includes('mariachi')) { torsoColor='#1a1a1a'; legColor='#1a1a1a'; armColor='#1a1a1a'; thighColor='#1a1a1a'; calfColor='#1a1a1a'; }
        else if(skin.includes('luchador')) { legColor = '#008000'; thighColor='#008000'; calfColor='#008000'; }
        else if(skin.includes('astronaut')) { torsoColor='#fff'; legColor='#fff'; armColor='#fff'; thighColor='#fff'; calfColor='#fff'; }
        else if(skin.includes('alien')) { furColor = '#32CD32'; tailColor='#32CD32'; torsoColor=furColor; legColor=furColor; armColor=furColor; thighColor=furColor; calfColor=furColor; }
        else if(skin.includes('zombie')) { furColor = '#98FB98'; torsoColor='#98FB98'; legColor='#8B4513'; thighColor='#8B4513'; calfColor='#8B4513'; }
        else if(skin.includes('ninja')) { furColor='#111'; torsoColor='#111'; legColor='#111'; armColor='#111'; thighColor='#111'; calfColor='#111'; }
        else if(skin.includes('robot')) { furColor='#C0C0C0'; torsoColor='#808080'; legColor='#808080'; armColor='#808080'; thighColor='#808080'; calfColor='#808080'; }

        let bodyW = 20 * s * sizeMod.w; let bodyH = 40 * s * sizeMod.h;
        if(currentAnimal === 'bear') bodyW = 30 * s * sizeMod.w;
        let legLen = 30 * s * sizeMod.h;
        let torsoY = p.y - legLen - bodyH;
        let headY = torsoY - (10 * s * sizeMod.head);
        let headRadius = 12 * s * sizeMod.head;

        // 3. Draw Back Accessories
        if(skin.includes('vampire') || skin.includes('king') || skin.includes('wizard')) {
            ctx.fillStyle = skin.includes('vampire') ? '#000' : (skin.includes('king') ? '#800080' : '#000080');
            ctx.fillRect(p.x - bodyW/1.5, torsoY + 5*s, bodyW*1.3, bodyH*0.8);
        }
        if(skin.includes('angel')) {
            ctx.fillStyle = '#FFF';
            ctx.beginPath(); ctx.ellipse(p.x - 20*s, torsoY + 10*s, 10*s, 20*s, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(p.x + 20*s, torsoY + 10*s, 10*s, 20*s, 0.5, 0, Math.PI*2); ctx.fill();
        }

        // 4. Draw Legs
        const kneeY = p.y - (legLen * 0.5);
        const legFurry = isFurry && (legColor === furColor);
        drawFuzzyLimb(p.x - 8*s, p.y - legLen, p.x - 9*s, kneeY, 7*s*sizeMod.w, thighColor, s, legFurry, 1); // Left Thigh
        drawFuzzyLimb(p.x + 8*s, p.y - legLen, p.x + 9*s, kneeY, 7*s*sizeMod.w, thighColor, s, legFurry, 3); // Right Thigh

        // Calves & Socks/Shoes
        const drawLowerLeg = (xTop, xBot, isRight) => {
             const calfBaseColor = calfColor;
             // Draw Base Calf
             drawFuzzyLimb(xTop, kneeY, xBot, p.y, 6*s*sizeMod.w, calfBaseColor, s, legFurry, isRight?4:2);

             // Socks & Shoes Overlay
             if(skinObj.socksColor || skinObj.shoesColor) {
                 const shoeH = 5 * s; const sockH = 7 * s;
                 const ankleY = p.y - shoeH; const sockY = ankleY - sockH;

                 // Interpolate X for sock/shoe top
                 const getXAtY = (y) => {
                     const t = (y - kneeY) / (p.y - kneeY);
                     return xTop + (xBot - xTop) * t;
                 };

                 if(skinObj.socksColor) {
                     const sockTopX = getXAtY(sockY);
                     const ankleX = getXAtY(ankleY);
                     drawFuzzyLimb(sockTopX, sockY, ankleX, ankleY, 5.8*s*sizeMod.w, skinObj.socksColor, s, false, 0);
                 }
                 if(skinObj.shoesColor) {
                     const ankleX = getXAtY(ankleY);
                     drawFuzzyLimb(ankleX, ankleY, xBot, p.y, 6*s*sizeMod.w, skinObj.shoesColor, s, false, 0);
                     // Shoe Foot
                     ctx.fillStyle = skinObj.shoesColor;
                     ctx.beginPath(); ctx.ellipse(xBot, p.y + 1*s, 4.5*s, 2.5*s, 0, 0, Math.PI*2); ctx.fill();
                 }
             }
        };

        drawLowerLeg(p.x - 9*s, p.x - 10*s, false); // Left
        drawLowerLeg(p.x + 9*s, p.x + 10*s, true); // Right


        // 5. Arms Logic
        let leftArmAngle, rightArmAngle, leftForeArmAngle, rightForeArmAngle;
        let upperArmLen = 20 * s * sizeMod.h * 0.6; let foreArmLen = 20 * s * sizeMod.h * 0.6;
        let wristAngle = 0;

        if (state === 'SHOOTING') {
            leftArmAngle = -Math.PI/2 + 0.2; rightArmAngle = -Math.PI/2 - 0.2;
            leftForeArmAngle = -Math.PI/2 + 0.4; rightForeArmAngle = -Math.PI/2 - 0.4;
            wristAngle = 1.0;
        } else if (state === 'JUMPING') {
            let lift = Math.max(0, (9 - player3D.vz) / 9);
            leftArmAngle = (Math.PI/2 - 0.2) + ((-Math.PI/2 + 0.2) - (Math.PI/2 - 0.2)) * lift;
            rightArmAngle = (Math.PI/2 + 0.2) + ((-Math.PI/2 - 0.2) - (Math.PI/2 + 0.2)) * lift;
            leftForeArmAngle = (Math.PI/2 - 0.1) + ((-Math.PI/2 + 0.4) - (Math.PI/2 - 0.1)) * lift;
            rightForeArmAngle = (Math.PI/2 + 0.1) + ((-Math.PI/2 - 0.4) - (Math.PI/2 + 0.1)) * lift;
        } else {
            leftArmAngle = Math.PI/2 - 0.2; rightArmAngle = Math.PI/2 + 0.2;
            leftForeArmAngle = Math.PI/2 - 0.1; rightForeArmAngle = Math.PI/2 + 0.1;
        }

        let shoulderY = torsoY + (5*s);
        let leftShoulderX = p.x - 12*s; let rightShoulderX = p.x + 12*s;

        const drawSegmentedArm = (sx, sy, isRight, angle1, angle2) => {
            const armFurry = isFurry && (armColor === furColor);
            const seedBase = isRight ? 10 : 20;

            let thisUpperColor = armColor;
            let thisForeColor = armColor;

            // T-Shirt Logic
            if(skinObj.jerseyType === 'tshirt') {
                thisUpperColor = torsoColor;
            }

            // Sleeve Logic
            if(isRight && skinObj.sleeveRight) {
                thisUpperColor = skinObj.sleeveRight;
                thisForeColor = skinObj.sleeveRight;
            }
            if(!isRight && skinObj.sleeveLeft) {
                thisUpperColor = skinObj.sleeveLeft;
                thisForeColor = skinObj.sleeveLeft;
            }

            let elbow = getJoint(sx, sy, upperArmLen, angle1);
            drawFuzzyLimb(sx, sy, elbow.x, elbow.y, 6*s*sizeMod.w, thisUpperColor, s, armFurry, seedBase);
            let wrist = getJoint(elbow.x, elbow.y, foreArmLen, angle2);
            drawFuzzyLimb(elbow.x, elbow.y, wrist.x, wrist.y, 5*s*sizeMod.w, thisForeColor, s, armFurry, seedBase + 1);

            ctx.save(); ctx.translate(wrist.x, wrist.y); ctx.rotate(angle2 + (isRight ? wristAngle : 0));
            ctx.fillStyle = thisForeColor; ctx.beginPath(); ctx.arc(0, 0, 5*s, 0, Math.PI*2); ctx.fill();
            if (wristAngle > 0.5 && isRight) {
                 if(skin.includes('hockey')) { ctx.strokeStyle='#8B4513'; ctx.lineWidth=3*s; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, 40*s); ctx.lineTo(10*s, 45*s); ctx.stroke(); }
            }
            if (isRight && state !== 'SHOOTING' && state !== 'GAMEOVER') { drawBallSprite(0, 5*s, s); }
            ctx.restore();
        };

        if(currentAnimal === 'penguin') {
            drawFuzzyLimb(p.x - 12*s, p.y - 50*s, p.x - 25*s, p.y - 30*s, 6*s, furColor, s, true, 30);
            drawFuzzyLimb(p.x + 12*s, p.y - 50*s, p.x + 25*s, p.y - 30*s, 6*s, furColor, s, true, 31);
        } else {
             drawSegmentedArm(leftShoulderX, shoulderY, false, leftArmAngle, leftForeArmAngle);
             drawSegmentedArm(rightShoulderX, shoulderY, true, rightArmAngle, rightForeArmAngle);
        }

        // 6. Draw Body (Layer 2)
        const bodyFurry = isFurry && (torsoColor === furColor);
        drawAnatomicBody(p.x, torsoY, bodyW, bodyH, s, torsoColor, bodyFurry, 40);

        if(hasSpots) { ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(p.x, torsoY + 20*s, 4*s, 0, Math.PI*2); ctx.fill(); }
        if(skin.includes('tabby')) { ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2*s; ctx.beginPath(); ctx.moveTo(p.x-5*s, torsoY+10*s); ctx.lineTo(p.x+5*s, torsoY+10*s); ctx.stroke(); }
        if(bellyColor && currentAnimal === 'penguin') { ctx.fillStyle=bellyColor; ctx.fillRect(p.x-5*s, torsoY+5*s, 10*s, 30*s); }
        if(skin.includes('lumberjack')) {
             ctx.strokeStyle = '#000'; ctx.lineWidth = 1*s;
             ctx.beginPath(); ctx.moveTo(p.x-bodyW/2, torsoY+10*s); ctx.lineTo(p.x+bodyW/2, torsoY+10*s); ctx.stroke();
             ctx.beginPath(); ctx.moveTo(p.x-bodyW/2, torsoY+20*s); ctx.lineTo(p.x+bodyW/2, torsoY+20*s); ctx.stroke();
             ctx.beginPath(); ctx.moveTo(p.x-bodyW/2, torsoY+30*s); ctx.lineTo(p.x+bodyW/2, torsoY+30*s); ctx.stroke();
             ctx.beginPath(); ctx.moveTo(p.x, torsoY); ctx.lineTo(p.x, torsoY+bodyH); ctx.stroke();
        }

        // 7. Draw Tail (Layer 3)
        if(currentAnimal !== 'bear' && currentAnimal !== 'penguin' && currentAnimal !== 'human' && !skin.includes('astronaut') && !skin.includes('robot')) {
            ctx.beginPath(); ctx.strokeStyle = tailColor; ctx.lineWidth = (currentAnimal === 'beaver' ? 10 : 4) * s;
            ctx.lineCap = 'round'; ctx.moveTo(p.x, p.y - legLen - 5*s);
            ctx.quadraticCurveTo(p.x + 15*s, p.y - legLen + 5*s, p.x + 20*s, p.y - legLen - 10*s); ctx.stroke();
            if(currentAnimal === 'beaver') {
                 ctx.strokeStyle = '#3E2723'; ctx.lineWidth = 1*s;
                 ctx.beginPath(); ctx.moveTo(p.x + 5*s, p.y - legLen); ctx.lineTo(p.x + 15*s, p.y - legLen); ctx.stroke();
            }
        }

        // 8. Draw Head & Ears (Layer 4)
        ctx.fillStyle = (hasBlackEars) ? '#000' : furColor;
        if(skin.includes('alien')) ctx.fillStyle = '#32CD32';

        const drawFuzzyCircle = (cx, cy, r, c, seed = 50) => {
            if(!isFurry) { ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill(); return; }
            const points = []; const segs = 16;
            for(let i=0; i<segs; i++) { const a = (i/segs)*Math.PI*2; points.push({x: cx + Math.cos(a)*r, y: cy + Math.sin(a)*r}); }
            drawFuzzyPath(points, c, s, true, seed);
        };

        if(currentAnimal === 'rat') {
            drawFuzzyCircle(p.x - 12*s, headY - 5*s, 7*s, ctx.fillStyle, 51);
            drawFuzzyCircle(p.x + 12*s, headY - 5*s, 7*s, ctx.fillStyle, 52);
        } else if (currentAnimal === 'cat') {
            const earL = [{x: p.x-5*s, y: headY-8*s}, {x: p.x-15*s, y: headY-20*s}, {x: p.x-15*s, y: headY}];
            const earR = [{x: p.x+5*s, y: headY-8*s}, {x: p.x+15*s, y: headY-20*s}, {x: p.x+15*s, y: headY}];
            drawFuzzyPath(earL, ctx.fillStyle, s, true, 53);
            drawFuzzyPath(earR, ctx.fillStyle, s, true, 54);
        } else if (currentAnimal === 'rabbit') {
             ctx.beginPath(); ctx.ellipse(p.x-8*s, headY-20*s, 5*s, 15*s, -0.2, 0, Math.PI*2); ctx.fill();
             ctx.beginPath(); ctx.ellipse(p.x+8*s, headY-20*s, 5*s, 15*s, 0.2, 0, Math.PI*2); ctx.fill();
        } else if (currentAnimal === 'bear' || currentAnimal === 'dog') {
            drawFuzzyCircle(p.x - 10*s, headY - 8*s, 5*s, ctx.fillStyle, 55);
            drawFuzzyCircle(p.x + 10*s, headY - 8*s, 5*s, ctx.fillStyle, 56);
        } else if (currentAnimal === 'human') {
            // Human Ears
            ctx.fillStyle = furColor;
            ctx.beginPath(); ctx.ellipse(p.x - 12*s, headY, 3*s, 6*s, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(p.x + 12*s, headY, 3*s, 6*s, 0, 0, Math.PI*2); ctx.fill();
            if(skinObj.hairStyle === 'afro') {
                 ctx.fillStyle = skinObj.hairColor || '#000';
                 ctx.beginPath(); ctx.arc(p.x, headY - 2*s, headRadius * 1.5, 0, Math.PI*2); ctx.fill();
            }
        }
        if(currentAnimal === 'moose') {
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 4*s;
            ctx.beginPath(); ctx.moveTo(p.x-10*s, headY-10*s); ctx.lineTo(p.x-30*s, headY-25*s); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(p.x+10*s, headY-10*s); ctx.lineTo(p.x+30*s, headY-25*s); ctx.stroke();
        }

        // Head Circle
        let headColor = furColor;
        if(skin.includes('alien')) headColor = '#32CD32';
        drawFuzzyCircle(p.x, headY, headRadius, headColor, 60);

        // Human Hair
        if(currentAnimal === 'human') {
             if(skinObj.hairStyle === 'short') {
                 ctx.fillStyle = skinObj.hairColor || '#000';
                 ctx.beginPath(); ctx.arc(p.x, headY - 2*s, headRadius, Math.PI, 0); ctx.fill();
             }
             if(skinObj.hairStyle === 'headband') {
                 ctx.fillStyle = skinObj.hairColor || '#000';
                 ctx.beginPath(); ctx.arc(p.x, headY - 2*s, headRadius, Math.PI, 0); ctx.fill();
                 ctx.strokeStyle = skinObj.headbandColor || '#FFF'; ctx.lineWidth = 4*s;
                 ctx.beginPath(); ctx.moveTo(p.x-11*s, headY-5*s); ctx.lineTo(p.x+11*s, headY-5*s); ctx.stroke();
             }
             if(skinObj.hairStyle === 'bald') {
                 ctx.fillStyle = 'rgba(255,255,255,0.2)';
                 ctx.beginPath(); ctx.arc(p.x + 5*s, headY - 5*s, 3*s, 0, Math.PI*2); ctx.fill();
             }
        }

        // Head Accessories
        if(skin.includes('mariachi')) {
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath(); ctx.ellipse(p.x, headY - 5*s, 30*s, 8*s, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x, headY - 15*s, 10*s, Math.PI, 0); ctx.fill();
        }
        if(skin.includes('clown')) { ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(p.x, headY, 3*s, 0, Math.PI*2); ctx.fill(); }
        if(skin.includes('pirate')) { ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(p.x+3*s, headY-2*s, 3*s, 0, Math.PI*2); ctx.fill(); }
        if(skin.includes('king')) { ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.moveTo(p.x-8*s, headY-10*s); ctx.lineTo(p.x-4*s, headY-18*s); ctx.lineTo(p.x, headY-10*s); ctx.lineTo(p.x+4*s, headY-18*s); ctx.lineTo(p.x+8*s, headY-10*s); ctx.lineTo(p.x+8*s, headY-5*s); ctx.lineTo(p.x-8*s, headY-5*s); ctx.fill(); }
        if(skin.includes('wizard')) { ctx.fillStyle='#000080'; ctx.beginPath(); ctx.moveTo(p.x-10*s, headY-5*s); ctx.lineTo(p.x+10*s, headY-5*s); ctx.lineTo(p.x, headY-30*s); ctx.fill(); }
        if(skin.includes('chef')) { ctx.fillStyle='#FFF'; ctx.fillRect(p.x-8*s, headY-25*s, 16*s, 15*s); }
        if(skin.includes('hockey')) { ctx.fillStyle='#FFF'; ctx.beginPath(); ctx.arc(p.x, headY, headRadius+2*s, 0, Math.PI*2); ctx.stroke(); }
        if(skin.includes('devil')) { ctx.fillStyle='red'; ctx.beginPath(); ctx.moveTo(p.x-5*s, headY-10*s); ctx.lineTo(p.x-8*s, headY-18*s); ctx.lineTo(p.x-2*s, headY-10*s); ctx.fill(); ctx.beginPath(); ctx.moveTo(p.x+5*s, headY-10*s); ctx.lineTo(p.x+8*s, headY-18*s); ctx.lineTo(p.x+2*s, headY-10*s); ctx.fill(); }
        if(skin.includes('angel')) { ctx.strokeStyle='#FFD700'; ctx.lineWidth=2*s; ctx.beginPath(); ctx.ellipse(p.x, headY-15*s, 8*s, 3*s, 0, 0, Math.PI*2); ctx.stroke(); }
        if(skin.includes('astronaut')) { ctx.strokeStyle='#87CEEB'; ctx.lineWidth=2*s; ctx.beginPath(); ctx.arc(p.x, headY, headRadius-2*s, 0, Math.PI*2); ctx.stroke(); }
        if(skin.includes('lumberjack')) { ctx.fillStyle='#FF0000'; ctx.fillRect(p.x-10*s, headY-12*s, 20*s, 6*s); }

        // 9. Jersey Number (Layer 5)
        if(!skin.includes('alien') && !skin.includes('robot')) {
            ctx.fillStyle = skinObj.numberColor || "#FFF";
            ctx.font = `bold ${12 * s}px Arial`;
            ctx.textAlign = "center";
            ctx.fillText(skinObj.number || "23", p.x, torsoY + bodyH * 0.6);
        }
        // 10. Shot Meter (Layer 6)
        if (state === 'JUMPING') {
            const maxVz = 9; const curVz = Math.abs(player3D.vz);
            let progress = 1.0 - (curVz / maxVz); progress = Math.max(0, Math.min(1, progress));
            const groundY = p.y + (player3D.z * s);
            const meterY = groundY - (130 * s * sizeMod.h);
            const cx = p.x + (60 * s); const radius = 50 * s;
            ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 10*s; ctx.lineCap = 'round';
            ctx.arc(cx, meterY, radius, 0, -Math.PI / 2, true); ctx.stroke();
            const damp = 6.0 + (playerData.stats.aim - 1);
            const pen = Math.min(4.0, 1.0 + (distanceLevel * 0.04));
            const thresh = (0.25 * damp) / (playerData.difficulty * pen);
            const greenStart = 1.0 - (thresh / maxVz);
            ctx.beginPath(); ctx.strokeStyle = 'rgba(0,255,0,0.4)'; ctx.lineWidth = 10*s;
            ctx.arc(cx, meterY, radius, -Math.PI/2 * Math.max(0, greenStart), -Math.PI/2, true); ctx.stroke();
            ctx.beginPath();
            if (progress > greenStart) ctx.strokeStyle = '#00FF00'; else if (progress > 0.6) ctx.strokeStyle = '#FFFF00'; else ctx.strokeStyle = '#FF4500';
            ctx.lineWidth = 8*s; ctx.arc(cx, meterY, radius, 0, -Math.PI/2 * progress, true); ctx.stroke();
        }
    }
    function drawBackground() {
        const currentDist = 10 + (distanceLevel * 5);
        const court = getCourtDetails(currentDist);
        const horizonY = (canvas.height - 120) * 0.5;

        // Sky
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.6);
        skyGrad.addColorStop(0, court.sky1); skyGrad.addColorStop(1, court.sky2);
        ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Current Floor Fill
        const currentZoneGrad = ctx.createLinearGradient(0, horizonY, 0, canvas.height);
        currentZoneGrad.addColorStop(0, court.ground1); currentZoneGrad.addColorStop(1, court.ground2);
        ctx.fillStyle = currentZoneGrad; ctx.fillRect(0, horizonY, canvas.width, canvas.height - horizonY);

        // Past Floors
        const getProjectedY = (gDist) => {
            if (gDist <= 0) { const p = project(HOOP_POS.x, HOOP_POS.y, 0); return p ? p.y : horizonY; }
            const ratio = gDist / currentDist;
            const wx = HOOP_POS.x + (player3D.x - HOOP_POS.x) * ratio; const wy = HOOP_POS.y + (player3D.y - HOOP_POS.y) * ratio;
            const p = project(wx, wy, 0); return p ? p.y : canvas.height;
        };

        for (let i = 0; i < COURT_ZONES.length; i++) {
            const z = COURT_ZONES[i];
            let zStart = (i === 0) ? 0 : COURT_ZONES[i-1].limit;
            let zEnd = z.limit;
            if (zStart >= currentDist) break;
            let drawEnd = Math.min(zEnd, currentDist);
            const yTop = getProjectedY(zStart); const yBottom = getProjectedY(drawEnd);
            if ((yBottom - yTop) > 0.5) {
                const grad = ctx.createLinearGradient(0, yTop, 0, yBottom);
                grad.addColorStop(0, z.ground1); grad.addColorStop(1, z.ground2);
                ctx.fillStyle = grad; ctx.fillRect(0, yTop, canvas.width, (yBottom - yTop) + 2);
            }
        }

        mountains.forEach(m => {
            const shift = (player3D.x + player3D.y) * 0.05;
            const xPos = ((m.x - shift) % (canvas.width + 200)) - 100;
            ctx.beginPath(); ctx.moveTo(xPos, horizonY); ctx.lineTo(xPos + 60, horizonY - m.h); ctx.lineTo(xPos + 120, horizonY);
            ctx.fillStyle = m.color; ctx.fill();
        });
        ctx.beginPath(); ctx.moveTo(0, horizonY); ctx.lineTo(canvas.width, horizonY); ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.stroke();

        // 3D OBJECTS
        let renderList = [];
        decors.forEach(d => {
            const proj = project(d.x, d.y, 0);
            const dDist = Math.sqrt(Math.pow(d.x - HOOP_POS.x, 2) + Math.pow(d.y - HOOP_POS.y, 2));
            const decorZone = COURT_ZONES.find(z => dDist < z.limit) || COURT_ZONES[COURT_ZONES.length-1];
            if (proj) renderList.push({ type: 'decor', depth: proj.depth, proj: proj, zoneType: decorZone.type });
        });

        const hoopProj = project(HOOP_POS.x, HOOP_POS.y, HOOP_POS.z); if (hoopProj) renderList.push({ type: 'hoop', depth: hoopProj.depth, proj: hoopProj });
        const playerProj = project(player3D.x, player3D.y, player3D.z); if (playerProj) renderList.push({ type: 'player', depth: playerProj.depth, proj: playerProj });
        const shadowProj = project(player3D.x, player3D.y, 0); if (shadowProj) renderList.push({ type: 'shadow', depth: shadowProj.depth, proj: shadowProj });

        if (state === 'SHOOTING' && ball.active) {
            const ballProj = project(ball.x, ball.y, ball.z);
            if (ballProj) renderList.push({ type: 'ball', depth: ballProj.depth, proj: ballProj });
        }

        renderList.sort((a, b) => b.depth - a.depth);
        renderList.forEach(obj => {
            if (obj.type === 'decor') drawDecor(obj.proj, obj.zoneType);
            if (obj.type === 'hoop') drawHoop(obj.proj);
            if (obj.type === 'shadow') drawShadow(obj.proj);
            if (obj.type === 'player') drawPlayer(obj.proj);
            if (obj.type === 'ball') drawBall(obj.proj);
        });

        if (feedbackTimer > 0) {
            ctx.save(); ctx.font = "900 60px 'Arial Black'";
            ctx.fillStyle = feedback === "MUY BIEN!" || feedback === "CHANCEUX!" || feedback === "Swish" || feedback.includes('MONEY') || feedback === "SUR LA LIGNE!" || feedback === "OUF!" || feedback.includes('S√âRIE') ? "#00FF00" : "#FF0000";
            if (feedback === "DERNI√àRE CHANCE !") ctx.fillStyle = "#FFA500";
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.textAlign = "center";
            ctx.fillText(feedback, canvas.width/2, 200); ctx.strokeText(feedback, canvas.width/2, 200);
            ctx.restore();
        }
    }

    // Achievement Logic Helpers
    function unlockAchievement(id) {
        if (!playerData.unlockedAchievements.includes(id)) {
            playerData.unlockedAchievements.push(id);
            const ach = ACHIEVEMENTS.find(a => a.id === id);
            if(ach) {
                playerData.tacos += ach.reward;
                saveData();
                showNotification(ach.name, ach.reward);
                updateUI();
            }
        }
    }

    function checkAchievements(context) {
        const dist = 10 + (distanceLevel * 5);
        const ls = playerData.lifetimeStats;
        if (context === 'score') {
            unlockAchievement('rookie');
            if (ls.makes >= 100) unlockAchievement('veteran');
             if (dist >= 25) unlockAchievement('amateur'); if (dist >= 50) unlockAchievement('sniper');
            if (dist >= 75) unlockAchievement('pro');
            if (dist >= 100) { unlockAchievement('parking_lot'); unlockAchievement('urban_legend'); }
            if (dist >= 125) unlockAchievement('longshot'); if (dist >= 150) unlockAchievement('levis_legend');
            if (dist >= 300) unlockAchievement('chateau');
            if (dist >= 1000) unlockAchievement('mountain');
            if (dist >= 2000) unlockAchievement('astronaut');
            if (dist >= 5000) unlockAchievement('demigod');
            if (playerData.difficulty >= 3) unlockAchievement('daredevil');
            if (playerData.difficulty >= 2) unlockAchievement('hard_mode');
        }
        if(context === 'shot_stats') {
             if(ls.shots >= 500) unlockAchievement('ball_hog');
             if(ls.misses >= 50) unlockAchievement('bricklayer');
        }
        if(context === 'contest') {
             if(contestData.score > 10) unlockAchievement('contest_winner');
             if(contestData.score > 20) unlockAchievement('contest_perfect');
        }
        if (context === 'shop') {
            if (playerData.unlockedSkins.length >= 5) unlockAchievement('fashionista');
            if (playerData.unlockedSkins.length >= 10) unlockAchievement('wardrobe_malfunction');
            if (playerData.unlockedSkins.length >= 15) unlockAchievement('collector');
            if (playerData.stats.income >= 5) unlockAchievement('sweet_tooth');
            if (playerData.stats.aim >= 5) unlockAchievement('hawkeye');
            if (playerData.stats.luck >= 5) unlockAchievement('leprechaun');
            if (playerData.stats.moonwalk >= 5) unlockAchievement('moonwalker_pro');
            const animalsOwned = new Set();
            playerData.unlockedSkins.forEach(skinId => { const s = SKINS_DB.find(x => x.id === skinId); if(s) animalsOwned.add(s.animal); });
            if(animalsOwned.size >= 3) unlockAchievement('zoo');
        }
        if (context === 'lucky') unlockAchievement('lucky');
        if (context === 'skin') {
            const s = playerData.currentSkin;
            if(s.includes('robot') || s.includes('alien') || s.includes('astronaut')) unlockAchievement('cosplay');
            if(s.includes('lumberjack') || s.includes('hockey')) unlockAchievement('eh');
            if(s.includes('zombie') || s.includes('vampire') || s.includes('devil')) unlockAchievement('spooky');
            if(s.includes('poutine')) unlockAchievement('poutine_chef');
        }
        if (playerData.tacos >= 100) unlockAchievement('pocket_change');
        if (playerData.tacos >= 500) unlockAchievement('tycoon');
        if (playerData.tacos >= 2000) unlockAchievement('millionaire');
    }

    function showNotification(name, reward) {
        const notifText = document.getElementById('notifText');
        notifText.innerText = `${name} (+${reward} Tacos)`;
        notif.style.display = 'block'; setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }

    function renderAchievements() {
        const list = document.getElementById('achList');
        list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            const unlocked = playerData.unlockedAchievements.includes(ach.id);
            const div = document.createElement('div');
            div.className = `ach-row ${unlocked ? 'unlocked' : ''}`;
            div.innerHTML = `<div style="display:flex; align-items:center;"><div class="ach-icon">${unlocked ? 'üèÜ' : 'üîí'}</div><div class="ach-info"><h4>${ach.name}</h4><span>${ach.desc}</span></div></div>${unlocked ? '<div style="color:#00FF00">‚úì</div>' : ''}`;
            list.appendChild(div);
        });
    }

    // --- GAME ACTIONS ---
    function startJump() { if (state !== 'IDLE') return; state = 'JUMPING'; player3D.vz = 9; feedback = ""; }
    function releaseShot() { if (state !== 'JUMPING') return; const timingError = player3D.vz; shoot(timingError); }
    function retryShot() { player3D.z = 0; player3D.vz = 0; state = 'IDLE'; }

    function shoot(timingError) {
        state = 'SHOOTING';
        playerData.lifetimeStats.shots++;
        checkAchievements('shot_stats');
        let aimBonus = (playerData.stats.aim - 1);
        let baseDampener = 6.0;
        if (currentGameMode === 'CONTEST') { aimBonus *= 0.2; baseDampener = 4.5; }
        let dampener = baseDampener + aimBonus; if (dampener > 36.0) dampener = 36.0;
        const distPenalty = 1.0 + Math.pow(distanceLevel, 1.25) * 0.06;
        const accuracy = (timingError / dampener) * playerData.difficulty * distPenalty;
        const dx = HOOP_POS.x - player3D.x; const dy = HOOP_POS.y - player3D.y;
        ball.x = player3D.x; ball.y = player3D.y; ball.z = player3D.z + 120;
        ball.active = true;
        const flightTime = Math.min(120, 40 + (distanceLevel * 0.8));
        ball.vx = (dx / flightTime); ball.vy = (dy / flightTime); ball.vz = (HOOP_POS.z - ball.z + 0.5 * GRAVITY * flightTime * (flightTime - 1)) / flightTime;
        let isMiss = Math.abs(accuracy) > 0.25;
        if (isMiss && Math.abs(accuracy) < 0.32) { if(Math.random() > 0.5) { isMiss = false; feedback = "SUR LA LIGNE!"; feedbackTimer = 30; } }
        if (isMiss) {
            const luckChance = (playerData.stats.luck - 1) * 0.05;
            if (Math.random() < luckChance) { feedback = "CHANCEUX!"; feedbackTimer = 30; checkAchievements('lucky'); }
            else {
                const len = Math.sqrt(dx*dx + dy*dy); const perpX = -dy / len; const perpY = dx / len;
                const scatter = (Math.random() > 0.5 ? 1 : -1) * Math.abs(accuracy) * 15;
                ball.vx += perpX * scatter; ball.vy += perpY * scatter; ball.vz -= Math.abs(accuracy) * 5;
                feedback = Math.abs(accuracy) > 0.5 ? "AIRBALL" : "BRIQUE"; feedbackTimer = 30;
            }
        }
    }

    function handleScore() {
        ball.active = false; playerData.lifetimeStats.makes++; currentStreak++;
        if(currentGameMode === 'CONTEST') {
            const isMoneyBall = (contestData.ballsInRack === 4);
            const points = isMoneyBall ? 2 : 1;
            contestData.score += points;
            if (currentStreak >= 3) { feedback = `S√âRIE DE ${currentStreak}!`; } else { feedback = isMoneyBall ? "MONEY BALL! (+2)" : "Swish (+1)"; }
            feedbackTimer = 30; updateContestUI(); state = 'RESETTING'; setTimeout(nextLevel, 500);
        } else {
            consecutiveMisses = 0;
            if (currentStreak >= 3) { feedback = `S√âRIE DE ${currentStreak} üî•`; } else { feedback = "Swish"; }
            feedbackTimer = 60; state = 'RESETTING'; setTimeout(nextLevel, 1000);
        }
    }

    function handleMiss() {
        if(state === 'GAMEOVER') return;
        playerData.lifetimeStats.misses++; currentStreak = 0; checkAchievements('shot_stats');
        if(currentGameMode === 'CONTEST') {
            feedback = "Manqu√©"; feedbackTimer = 30; state = 'RESETTING'; setTimeout(nextLevel, 500);
        } else {
            consecutiveMisses++; updateUI();
            const maxMisses = 2 + (playerData.stats.extraLives || 0);
            if (consecutiveMisses >= maxMisses) {
                feedback = "TERMIN√â !"; feedbackTimer = 60; state = 'GAMEOVER'; setTimeout(openShop, 1500);
            } else {
                feedback = "DERNI√àRE CHANCE !"; feedbackTimer = 60; state = 'RESETTING'; setTimeout(retryShot, 1500);
            }
        }
    }

    function update(dt) {
        if (state === 'SHOP' || state === 'ACHIEVEMENTS' || state === 'STATS') return;
        if(currentGameMode === 'CONTEST' && state !== 'GAMEOVER') {
            if(contestData.timer > 0) {
                contestData.timer -= (1/60) * dt;
                if(contestData.timer <= 0) { contestData.timer = 0; endContest(); }
                if(Math.floor(contestData.timer) !== parseInt(document.getElementById('contestTime').innerText)) { updateContestUI(); }
            }
        }
        if (state === 'JUMPING') {
            player3D.z += player3D.vz * dt; player3D.vz -= GRAVITY * dt;
            if (player3D.z <= 0) { player3D.z = 0; player3D.vz = 0; state = 'GAMEOVER'; feedback = "MARCH√â!"; feedbackTimer = 60; setTimeout(openShop, 1500); }
        }
        if (state === 'SHOOTING') {
            if (player3D.z > 0) { player3D.z += player3D.vz * dt; player3D.vz -= GRAVITY * dt; if (player3D.z < 0) player3D.z = 0; }
            if (ball.active) {
                const prevZ = ball.z;
                ball.x += ball.vx * dt; ball.y += ball.vy * dt; ball.z += ball.vz * dt; ball.vz -= GRAVITY * dt;
                if (prevZ >= HOOP_POS.z && ball.z <= HOOP_POS.z) {
                    const distToHoopCenter = Math.sqrt(Math.pow(ball.x - HOOP_POS.x, 2) + Math.pow(ball.y - HOOP_POS.y, 2));
                    if (distToHoopCenter < 25) { handleScore(); return; }
                }
                const distToHoop = Math.sqrt(Math.pow(HOOP_POS.x - player3D.x, 2) + Math.pow(HOOP_POS.y - player3D.y, 2));
                const currentDist = Math.sqrt(Math.pow(ball.x - player3D.x, 2) + Math.pow(ball.y - player3D.y, 2));
                if (ball.z < -50 || currentDist > distToHoop + 5000) { ball.active = false; handleMiss(); return; }
                if (ball.z <= 0) { ball.z = 0; ball.active = false; handleMiss(); return; }
            }
        }
        if (feedbackTimer > 0) feedbackTimer -= 1 * dt;
    }

    // --- HELPER FUNCTIONS ---
    function nextLevel() {
        if(currentGameMode === 'CONTEST') {
            contestData.ballsInRack++;
            if(contestData.ballsInRack >= 5) {
                contestData.rack++; contestData.ballsInRack = 0;
                if(contestData.rack > 5) { endContest(); return; }
                else { setPlayerPositionForRack(contestData.rack); }
            }
            updateContestUI(); state = 'IDLE';
        } else {
            const baseReward = 1 * distanceLevel * playerData.difficulty;
            const multiplier = 1 + (playerData.stats.income - 1) * 0.5;
            let reward = Math.ceil(baseReward * multiplier);
            if (currentStreak > 1) reward += currentStreak * 2;
            playerData.tacos += reward;
            const jump = playerData.stats.moonwalk || 1; distanceLevel += jump;
            const currentDistanceVal = 10 + (distanceLevel * 5);
            if (currentDistanceVal > playerData.highScore) { playerData.highScore = currentDistanceVal; highScoreEl.innerText = playerData.highScore + " pi"; }
            saveData(); checkAchievements('score');
            player3D.x -= 15 * jump; player3D.y += 15 * jump; player3D.z = 0; player3D.vz = 0; state = 'IDLE'; updateUI();
        }
    }

    function endContest() {
        state = 'GAMEOVER'; feedback = "TERMIN√â !"; feedbackTimer = 120;
        const reward = contestData.score * 10; playerData.tacos += reward;
        checkAchievements('contest'); saveData(); setTimeout(openShop, 2000);
    }

    function updateUI() {
        scoreEl.innerText = playerData.tacos;
        if(currentGameMode === 'CLASSIC') {
            distEl.innerText = (10 + (distanceLevel * 5)) + " pi";
            const maxMisses = 2 + (playerData.stats.extraLives || 0);
            missValEl.innerText = `${consecutiveMisses}/${maxMisses}`;
            const dist = 10 + (distanceLevel * 5); const c = getCourtDetails(dist); courtNameEl.innerText = c.name;
        } else { courtNameEl.innerText = "CONCOURS 3 POINTS"; }
    }

    function setPlayerPositionForRack(rackNum) {
        if(rackNum === 1) { player3D.x = 200; player3D.y = 500; }
        else if(rackNum === 2) { player3D.x = 250; player3D.y = 400; }
        else if(rackNum === 3) { player3D.x = 300; player3D.y = 300; }
        else if(rackNum === 4) { player3D.x = 350; player3D.y = 200; }
        else if(rackNum === 5) { player3D.x = 400; player3D.y = 100; }
        player3D.z = 0; player3D.vz = 0;
    }

    function updateContestUI() {
        document.getElementById('contestTime').innerText = Math.ceil(contestData.timer);
        document.getElementById('contestScore').innerText = contestData.score;
        document.getElementById('contestRack').innerText = contestData.rack;
    }

    function resetGame() {
        if(currentGameMode === 'CONTEST') { startContest(); }
        else {
            distanceLevel = 1; consecutiveMisses = 0;
            player3D = { x: 300, y: 300, z: 0, vz: 0 };
            document.getElementById('classic-stats').style.display = 'block';
            strikesEl.style.display = 'block';
            contestUI.style.display = 'none';
            state = 'IDLE'; updateUI();
        }
    }

    // --- UI FUNCTIONS ---
    window.openShop = function() {
        if(state !== 'IDLE' && state !== 'GAMEOVER') return;
        state = 'SHOP'; shopUI.style.display = 'block'; achUI.style.display = 'none'; statsUI.style.display = 'none';
        document.getElementById('diffSlider').value = playerData.difficulty;
        updateDifficulty(); updateShopUI();
    }
    window.openAchievements = function() {
        if(state !== 'IDLE' && state !== 'GAMEOVER') return;
        state = 'ACHIEVEMENTS'; achUI.style.display = 'block'; shopUI.style.display = 'none'; statsUI.style.display = 'none'; renderAchievements();
    }
    window.openStats = function() {
        if(state !== 'IDLE' && state !== 'GAMEOVER') return;
        state = 'STATS';
        shopUI.style.display = 'none';
        achUI.style.display = 'none';
        statsUI.style.display = 'block';
        const ls = playerData.lifetimeStats;
        document.getElementById('statShots').innerText = ls.shots;
        document.getElementById('statMakes').innerText = ls.makes;
        document.getElementById('statMisses').innerText = ls.misses;
        document.getElementById('statContests').innerText = ls.contests;
        document.getElementById('statBestDist').innerText = playerData.highScore + " pi";
        let acc = 0;
        if(ls.shots > 0) acc = ((ls.makes / ls.shots) * 100).toFixed(1);
        document.getElementById('statAccuracy').innerText = acc + "%";
    }
    window.attemptReset = function() {
        const btn = document.getElementById('btnReset');
        if (resetStage === 0) { resetStage = 1; btn.innerText = "S√õR ? (CLIQUEZ ENCORE)"; btn.style.background = "#FF0000"; return; }
        playerData = JSON.parse(JSON.stringify(defaultData)); saveData();
        highScoreEl.innerText = playerData.highScore + " pi"; updateUI(); closeStats(); resetGame();
        resetStage = 0; btn.innerText = "R√âINITIALISER PROGRESSION"; btn.style.background = "#8B0000"; feedback = "RESET!"; feedbackTimer = 60;
    }
    window.unlockAllSkins = function() {
        if(resetStage === 0) {
            const btn = document.getElementById('btnUnlock');
            resetStage = 2; // Different stage for unlock
            btn.innerText = "S√õR ? (CLIQUEZ ENCORE)";
            btn.style.background = "#800080";
            return;
        }
        if(resetStage === 2) {
            SKINS_DB.forEach(skin => {
                if(!playerData.unlockedSkins.includes(skin.id)) {
                    playerData.unlockedSkins.push(skin.id);
                }
            });
            checkAchievements('shop');
            saveData();
            updateShopUI();
            const btn = document.getElementById('btnUnlock');
            btn.innerText = "TRICHEUR !";
            btn.disabled = true;
            resetStage = 0;
            showNotification("TRICHEUR !", 0);
        }
    }
    window.closeShop = function() { state = 'IDLE'; shopUI.style.display = 'none'; if(feedback === "TERMIN√â !" || feedback === "MARCH√â!") resetGame(); }
    window.closeAchievements = function() { state = 'IDLE'; achUI.style.display = 'none'; if(feedback === "TERMIN√â !" || feedback === "MARCH√â!") resetGame(); }
    window.closeStats = function() {
        state = 'IDLE'; statsUI.style.display = 'none'; resetStage = 0;
        const btn = document.getElementById('btnReset'); if(btn) { btn.innerText = "R√âINITIALISER PROGRESSION"; btn.style.background = "#8B0000"; }
        if(feedback === "TERMIN√â !" || feedback === "MARCH√â!") resetGame();
    }
    window.updateDifficulty = function() {
        const val = parseFloat(document.getElementById('diffSlider').value);
        playerData.difficulty = val;
        const label = document.getElementById('diffLabel');
        label.innerText = `x${val.toFixed(1)} Tacos`;
        if(val === 1) { label.innerText = "NORMAL (x1.0)"; label.style.color = "#00FF00"; }
        else if (val < 2.5) { label.innerText = `DIFFICILE (x${val.toFixed(1)})`; label.style.color = "#FFFF00"; }
        else { label.innerText = `L√âVIS LEGEND (x${val.toFixed(1)})`; label.style.color = "#FF0000"; }
        saveData();
    }
    window.getUpgradeCost = function(statName) {
        const lvl = playerData.stats[statName];
        if (statName === 'income') return Math.floor(25 * Math.pow(lvl, 2));
        if (statName === 'aim') return Math.floor(50 * Math.pow(lvl, 2));
        if (statName === 'luck') return Math.floor(75 * Math.pow(lvl, 2));
        if (statName === 'moonwalk') return Math.floor(150 * Math.pow(lvl, 2));
        if (statName === 'extraLives') return Math.floor(1000 * Math.pow(2, lvl));
        return 999;
    }
    window.buyUpgrade = function(stat) {
        const cost = getUpgradeCost(stat);
        if (playerData.tacos >= cost) {
            playerData.tacos -= cost; playerData.stats[stat]++; saveData(); updateShopUI(); updateUI(); checkAchievements('shop');
        }
    }
    window.changeAnimal = function(dir) {
        viewingAnimalIndex += dir;
        if(viewingAnimalIndex < 0) viewingAnimalIndex = ANIMALS.length - 1;
        if(viewingAnimalIndex >= ANIMALS.length) viewingAnimalIndex = 0;
        viewingSkinIndex = 0; updateShopUI();
    }
    window.changeSkin = function(dir) {
        const currentAnimal = ANIMALS[viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        viewingSkinIndex += dir;
        if(viewingSkinIndex < 0) viewingSkinIndex = animalSkins.length - 1;
        if(viewingSkinIndex >= animalSkins.length) viewingSkinIndex = 0;
        updateShopUI();
    }
    window.buyOrEquipSkin = function() {
        const currentAnimal = ANIMALS[viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        const skin = animalSkins[viewingSkinIndex];
        const isUnlocked = playerData.unlockedSkins.includes(skin.id);
        if (isUnlocked) { playerData.currentSkin = skin.id; checkAchievements('skin'); }
        else if (playerData.tacos >= skin.cost) {
            playerData.tacos -= skin.cost; playerData.unlockedSkins.push(skin.id); playerData.currentSkin = skin.id;
            checkAchievements('shop'); checkAchievements('skin');
        }
        saveData(); updateShopUI(); updateUI();
    }
    window.updateShopUI = function() {
        document.getElementById('shopTacos').innerText = playerData.tacos;
        document.getElementById('lvlIncome').innerText = playerData.stats.income;
        document.getElementById('btnBuyIncome').innerText = `Acheter (${getUpgradeCost('income')})`;
        document.getElementById('btnBuyIncome').disabled = playerData.tacos < getUpgradeCost('income');
        document.getElementById('lvlAim').innerText = playerData.stats.aim;
        document.getElementById('btnBuyAim').innerText = `Acheter (${getUpgradeCost('aim')})`;
        document.getElementById('btnBuyAim').disabled = playerData.tacos < getUpgradeCost('aim');
        document.getElementById('lvlLuck').innerText = playerData.stats.luck;
        document.getElementById('btnBuyLuck').innerText = `Acheter (${getUpgradeCost('luck')})`;
        document.getElementById('btnBuyLuck').disabled = playerData.tacos < getUpgradeCost('luck');
        document.getElementById('lvlMoonwalk').innerText = playerData.stats.moonwalk;
        document.getElementById('btnBuyMoonwalk').innerText = `Acheter (${getUpgradeCost('moonwalk')})`;
        document.getElementById('btnBuyMoonwalk').disabled = playerData.tacos < getUpgradeCost('moonwalk');
        document.getElementById('lvlExtraLives').innerText = playerData.stats.extraLives || 0;
        document.getElementById('btnBuyExtraLives').innerText = `Acheter (${getUpgradeCost('extraLives')})`;
        document.getElementById('btnBuyExtraLives').disabled = playerData.tacos < getUpgradeCost('extraLives');
        const currentAnimal = ANIMALS[viewingAnimalIndex];
        const animalSkins = SKINS_DB.filter(s => s.animal === currentAnimal);
        const skin = animalSkins[viewingSkinIndex];
        document.getElementById('animalName').innerText = currentAnimal.toUpperCase();
        document.getElementById('skinName').innerText = skin.name;
        const btn = document.getElementById('btnEquipSkin');
        const status = document.getElementById('skinStatus');
        const isUnlocked = playerData.unlockedSkins.includes(skin.id);
        const isEquipped = playerData.currentSkin === skin.id;
        if (isEquipped) { status.innerText = "√âquip√©"; btn.style.display = 'none'; }
        else if (isUnlocked) { status.innerText = "Poss√©d√©"; btn.style.display = 'inline-block'; btn.innerText = "√âquiper"; btn.disabled = false; }
        else { status.innerText = `Co√ªt: ${skin.cost} Tacos`; btn.style.display = 'inline-block'; btn.innerText = "Acheter"; btn.disabled = playerData.tacos < skin.cost; }
    }
    window.toggleMode = function() {
        if(state !== 'IDLE' && state !== 'GAMEOVER') return;
        if(currentGameMode === 'CLASSIC') { currentGameMode = 'CONTEST'; document.getElementById('modeBtnText').innerText = "CONCOURS"; }
        else { currentGameMode = 'CLASSIC'; document.getElementById('modeBtnText').innerText = "CLASSIQUE"; }
        resetGame();
    }

    // --- GAME LOOP ---
    function draw() {
        drawBackground();
        drawFlightTracker();
    }

    let lastTime = 0;
    function loop(timestamp) {
        requestAnimationFrame(loop);
        if (!lastTime) lastTime = timestamp;
        const elapsed = timestamp - lastTime;
        let dt = elapsed / 16.666;
        if(dt > 4) dt = 4;
        lastTime = timestamp;
        update(dt);
        draw();
    }

    // Start buttons
    window.addEventListener('keydown', (e) => {
        if(state === 'SHOP') { if(e.code === 'Escape') closeShop(); return; }
        if(state === 'ACHIEVEMENTS') { if(e.code === 'Escape') closeAchievements(); return; }
        if(state === 'STATS') { if(e.code === 'Escape') closeStats(); return; }
        if(e.code === 'KeyP') openShop(); if(e.code === 'KeyO') openAchievements(); if(e.code === 'KeyS') openStats();
        if (e.code === 'Space' && !spacePressed) { spacePressed = true; if (state === 'GAMEOVER') openShop(); else if (state === 'IDLE') startJump(); }
    });
    window.addEventListener('keyup', (e) => { if (e.code === 'Space') { spacePressed = false; if (state === 'JUMPING') releaseShot(); } });
    window.addEventListener('mousedown', (e) => {
        if(e.target.closest('.modal') || e.target.closest('.ui-btn')) return;
        if (state === 'GAMEOVER') openShop(); else if (state === 'IDLE') startJump();
    });
    window.addEventListener('mouseup', () => { if (state === 'JUMPING') releaseShot(); });

    // Initial resize call
    resizeGame();
    // Start loop
    requestAnimationFrame(loop);
</script>
</body>
</html>